# Test Design: Story 6.2 - MTOM Attachment Handling

Date: 2025-11-22
Designer: Quinn (Test Architect)

## Test Strategy Overview

| Metric | Count | Percentage |
|--------|-------|------------|
| **Total Test Scenarios** | 36 | 100% |
| **Unit Tests** | 24 | 66.7% |
| **Integration Tests** | 10 | 27.8% |
| **E2E Tests** | 2 | 5.5% |

### Priority Distribution

| Priority | Count | Focus Area |
|----------|-------|------------|
| **P0** | 14 | Critical - Hash/size calculation, MTOM structure, XOP references |
| **P1** | 16 | Important - Content-ID, encoding, validation, multiple documents |
| **P2** | 6 | Secondary - Streaming, custom configuration, edge cases |

---

## Test Scenarios by Acceptance Criteria

### AC1: MTOM attachment creation for CCD XML documents

Core functionality for creating attachments from CCD content.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-001 | Unit | P0 | Create MTOMAttachment from bytes with valid content | Core constructor logic |
| 6.2-UNIT-002 | Unit | P0 | Create MTOMAttachment from file path | File I/O factory method |
| 6.2-UNIT-003 | Unit | P1 | Verify content_type defaults to text/xml | Default value logic |
| 6.2-UNIT-004 | Unit | P1 | Create MTOMAttachment with custom content_type | Parameter handling |
| 6.2-INT-001 | Integration | P0 | Create attachment from real CCD fixture file | Real file integration |

---

### AC2: Content-ID generation and reference in metadata

Content-ID uniqueness and cid: URI reference format.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-005 | Unit | P0 | Content-ID format contains @ symbol | ID format validation |
| 6.2-UNIT-006 | Unit | P0 | Content-ID contains UUID component | Uniqueness guarantee |
| 6.2-UNIT-007 | Unit | P0 | get_cid_reference() returns cid: URI | Reference format |
| 6.2-UNIT-008 | Unit | P1 | generate_content_id() with custom domain | Configurable domain |
| 6.2-UNIT-009 | Unit | P0 | get_xop_include() returns valid XOP element | XOP Include structure |
| 6.2-UNIT-010 | Unit | P1 | XOP Include href attribute matches cid reference | Reference consistency |
| 6.2-UNIT-011 | Unit | P1 | XOP namespace is correct | Namespace compliance |

---

### AC3: Base64 encoding applied for binary transport

Base64 encoding correctness for document content.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-012 | Unit | P0 | base64_content property returns valid base64 | Encoding logic |
| 6.2-UNIT-013 | Unit | P1 | base64 decoded matches original content | Round-trip verification |
| 6.2-UNIT-014 | Unit | P1 | base64_content is ASCII string | Transport compatibility |

---

### AC4: Document hash (SHA256) calculation for integrity verification

SHA-256 hash calculation accuracy.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-015 | Unit | P0 | sha256_hash returns lowercase hex string | Hash format critical |
| 6.2-UNIT-016 | Unit | P0 | sha256_hash is 64 characters (256 bits) | Hash length validation |
| 6.2-UNIT-017 | Unit | P0 | sha256_hash matches known pre-calculated value | Algorithm correctness |
| 6.2-UNIT-018 | Unit | P1 | sha256_hash is cached (computed once) | Performance optimization |
| 6.2-INT-002 | Integration | P0 | Hash of CCD fixture matches expected value | Real content verification |

---

### AC5: Document size calculation and inclusion in metadata

Byte count accuracy for metadata slot.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-019 | Unit | P0 | size_bytes returns exact byte count | Size accuracy critical |
| 6.2-UNIT-020 | Unit | P0 | size_bytes matches len(content) | Implementation correctness |
| 6.2-INT-003 | Integration | P0 | Size matches file system size for fixture | Real file verification |

---

### AC6: Multiple document support for future extensibility

Support for attaching multiple documents.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-021 | Unit | P1 | MTOMPackage.add_attachments() accepts list | Bulk add method |
| 6.2-UNIT-022 | Unit | P1 | Package tracks attachments in order | Order preservation |
| 6.2-UNIT-023 | Unit | P1 | Duplicate Content-ID raises error | ID uniqueness enforcement |
| 6.2-INT-004 | Integration | P1 | Build package with 3 attachments | Multi-document workflow |

---

### AC7: MTOM packaging with proper MIME multipart boundaries

MIME multipart/related structure compliance.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-024 | Unit | P0 | MTOMPackage generates unique boundary | Boundary uniqueness |
| 6.2-UNIT-025 | Unit | P0 | build() returns bytes and content-type header | API contract |
| 6.2-UNIT-026 | Unit | P0 | Content-Type header is multipart/related | MTOM compliance |
| 6.2-UNIT-027 | Unit | P1 | Content-Type includes type=application/xop+xml | XOP type parameter |
| 6.2-UNIT-028 | Unit | P1 | Content-Type includes start parameter | Root part reference |
| 6.2-UNIT-029 | Unit | P1 | Root part has Content-ID header | SOAP envelope ID |
| 6.2-UNIT-030 | Unit | P1 | Attachment part has Content-Transfer-Encoding: binary | Encoding header |
| 6.2-INT-005 | Integration | P0 | Built MTOM package parseable by MIME parser | Structure validity |
| 6.2-INT-006 | Integration | P1 | Extract SOAP envelope from built package | Content extraction |
| 6.2-INT-007 | Integration | P1 | Extract attachment content from built package | Attachment extraction |

---

### AC8: Memory-efficient streaming for large documents (per NFR4)

Chunked processing for documents >1MB.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-031 | Unit | P2 | from_file_streaming() reads in chunks | Memory efficiency |
| 6.2-UNIT-032 | Unit | P2 | is_large_document returns True for >1MB | Threshold logic |
| 6.2-UNIT-033 | Unit | P2 | Streaming calculates correct hash | Hash correctness with streaming |
| 6.2-INT-008 | Integration | P2 | Process 5MB test file without memory spike | Memory behavior |

---

### AC9: MTOM structure validation before transmission

Validation catches malformed packages.

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-UNIT-034 | Unit | P1 | validate() returns (True, []) for valid package | Happy path |
| 6.2-UNIT-035 | Unit | P1 | validate() detects missing attachment content | Error detection |
| 6.2-UNIT-036 | Unit | P1 | validate() detects invalid Content-ID format | Format validation |
| 6.2-UNIT-037 | Unit | P1 | validate() detects XOP reference mismatch | Reference validation |
| 6.2-UNIT-038 | Unit | P2 | validate() detects malformed SOAP envelope | XML validation |
| 6.2-INT-009 | Integration | P1 | Validation passes for complete real package | Full validation |

---

### AC10: Unit tests verify MTOM packaging, hash calculation, size accuracy

Meta-requirement for test coverage (self-referential).

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.2-INT-010 | Integration | P1 | Hash in MTOM matches XDSb metadata hash slot | Metadata integration |
| 6.2-E2E-001 | E2E | P0 | Build complete MTOM package, submit to mock endpoint | Full workflow |
| 6.2-E2E-002 | E2E | P1 | Mock endpoint extracts and validates CCD content | End-to-end verification |

---

## Risk Coverage Matrix

| Risk | Severity | Test Coverage |
|------|----------|---------------|
| Hash mismatch causes document rejection | High | 6.2-UNIT-015/16/17, 6.2-INT-002 |
| Size mismatch causes metadata validation failure | High | 6.2-UNIT-019/20, 6.2-INT-003 |
| Content-ID collision causes attachment confusion | Medium | 6.2-UNIT-005/06, 6.2-UNIT-023 |
| Malformed MTOM rejected by XDS repository | High | 6.2-INT-005, 6.2-E2E-001 |
| Memory exhaustion on large documents | Medium | 6.2-UNIT-031/32/33, 6.2-INT-008 |
| XOP reference mismatch breaks document link | High | 6.2-UNIT-009/10, 6.2-UNIT-037 |

---

## Given-When-Then Scenarios

### Hash Calculation (P0)

```gherkin
Scenario: SHA-256 hash calculation
  Given a CCD document with known content "<?xml...>"
  When I create an MTOMAttachment with this content
  Then sha256_hash should return 64-character lowercase hex
  And the hash should match the pre-calculated value
```

### Content-ID Format (P0)

```gherkin
Scenario: Content-ID generation
  Given a default domain "ihe-test-util.local"
  When I call generate_content_id()
  Then the result should contain "@ihe-test-util.local"
  And the result should contain a UUID segment
```

### MTOM Package Build (P0)

```gherkin
Scenario: Build MTOM multipart package
  Given a SOAP envelope bytes
  And an MTOMAttachment with content_id "doc1@local"
  When I call MTOMPackage.build()
  Then the result Content-Type should be "multipart/related"
  And the result should contain the boundary in headers
  And the body should contain both SOAP and attachment parts
```

### XOP Include Reference (P0)

```gherkin
Scenario: XOP Include element generation
  Given an MTOMAttachment with content_id "doc1@local"
  When I call get_xop_include()
  Then the result should be an lxml Element
  And the element should have tag "{http://www.w3.org/2004/08/xop/include}Include"
  And the href attribute should be "cid:doc1@local"
```

---

## Recommended Execution Order

### Phase 1: P0 Critical Tests (Fail Fast)

1. 6.2-UNIT-001, 002 - Attachment creation
2. 6.2-UNIT-015, 016, 017 - Hash calculation
3. 6.2-UNIT-019, 020 - Size calculation
4. 6.2-UNIT-005, 006, 007, 009 - Content-ID and XOP
5. 6.2-UNIT-024, 025, 026 - Package building
6. 6.2-INT-001, 002, 003, 005 - Integration validation
7. 6.2-E2E-001 - Full workflow

### Phase 2: P1 Important Tests

1. All remaining UNIT tests
2. Integration tests 004, 006, 007, 009, 010
3. 6.2-E2E-002

### Phase 3: P2 Secondary Tests

1. Streaming tests (031, 032, 033)
2. 6.2-INT-008 (memory efficiency)
3. 6.2-UNIT-038 (edge cases)

---

## Test Implementation Notes

### Test File Locations

- Unit tests: `tests/unit/test_mtom.py`
- Integration tests: `tests/integration/test_mtom_workflow.py`

### Required Fixtures

- `tests/fixtures/test_ccd_template.xml` - Real CCD for integration tests
- Pre-calculated hash values for known content (embed in test file)
- 5MB test file for streaming tests (generate in fixture)

### Coverage Target

- **Unit coverage on mtom.py**: 90%+
- **Combined coverage**: 80%+

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 36
  by_level:
    unit: 24
    integration: 10
    e2e: 2
  by_priority:
    p0: 14
    p1: 16
    p2: 6
  coverage_gaps: []
  risk_coverage:
    hash_mismatch: covered
    size_mismatch: covered
    content_id_collision: covered
    malformed_mtom: covered
    memory_exhaustion: covered
    xop_reference_mismatch: covered
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

---

ðŸ§ª *Quinn, Test Architect - Test Design Complete*
