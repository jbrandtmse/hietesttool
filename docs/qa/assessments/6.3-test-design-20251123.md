# Test Design: Story 6.3 - ITI-41 SOAP Client Implementation

**Date:** 2025-11-23
**Designer:** Quinn (Test Architect)
**Story:** ITI-41 SOAP Client Implementation
**Epic:** 6 - ITI-41 Document Submission Complete Workflow

---

## Test Strategy Overview

| Metric | Count | Percentage |
|--------|-------|------------|
| **Total test scenarios** | 32 | 100% |
| Unit tests | 18 | 56% |
| Integration tests | 11 | 34% |
| E2E tests | 3 | 10% |

### Priority Distribution

| Priority | Count | Description |
|----------|-------|-------------|
| **P0** | 12 | Critical - IHE compliance, security, data integrity |
| **P1** | 14 | High - Core functionality, error handling |
| **P2** | 6 | Medium - Configuration, logging, edge cases |

### Test Level Rationale

This story implements a **critical healthcare interoperability transaction** (IHE ITI-41). The test strategy emphasizes:

1. **Heavy unit testing (56%)** - SOAP construction, WS-Addressing, retry logic are pure functions
2. **Strong integration testing (34%)** - HTTP transport, MTOM packaging, mock endpoint interaction
3. **Focused E2E tests (10%)** - Critical submission workflows only (avoiding over-testing)

---

## Test Scenarios by Acceptance Criteria

### AC1: SOAP Client with Manual MTOM Packaging

> SOAP client implementation using manual MTOM packaging with `requests` (per ADR-001)

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-001 | Unit | P0 | `test_soap_envelope_structure` - Verify SOAP 1.2 envelope has correct namespaces (soap12, wsa, wsse) | Pure XML construction logic |
| 6.3-UNIT-002 | Unit | P0 | `test_soap_body_contains_xdsb_metadata` - Verify ProvideAndRegisterDocumentSetRequest embedded in Body | Pure XML construction |
| 6.3-UNIT-003 | Unit | P1 | `test_xop_include_reference_generated` - Verify XOP Include element with correct Content-ID | MTOM attachment reference logic |
| 6.3-INT-001 | Integration | P0 | `test_mtom_package_integration` - Verify MTOMPackage from Story 6.2 correctly wraps SOAP envelope | Component integration |
| 6.3-INT-002 | Integration | P0 | `test_content_type_header_format` - Verify multipart/related Content-Type with boundary, start, type params | HTTP header construction |

### AC2: Configurable Endpoint URL

> ITI-41 endpoint URL configurable via configuration file

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-004 | Unit | P1 | `test_endpoint_url_initialization` - Client accepts endpoint URL in constructor | Constructor logic |
| 6.3-UNIT-005 | Unit | P2 | `test_endpoint_url_property_access` - Endpoint URL retrievable via property | Property getter |
| 6.3-INT-003 | Integration | P1 | `test_config_manager_endpoint_loading` - Endpoint URL loaded from config file | Config integration |

### AC3: HTTP/HTTPS with TLS 1.2+ Enforcement

> HTTP and HTTPS transport support with TLS 1.2+ enforcement

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-006 | Unit | P0 | `test_tls_minimum_version_configuration` - Session configured with TLS 1.2 minimum | Security-critical configuration |
| 6.3-UNIT-007 | Unit | P1 | `test_http_warning_logged` - Warning logged when HTTP (not HTTPS) used | Security awareness |
| 6.3-INT-004 | Integration | P0 | `test_https_connection_established` - HTTPS connection with valid certificate succeeds | Transport security |
| 6.3-INT-005 | Integration | P1 | `test_http_transport_for_mock` - HTTP transport works for local mock server | Mock testing capability |

### AC4: WS-Addressing Headers

> WS-Addressing headers included (Action, MessageID, To, ReplyTo)

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-008 | Unit | P0 | `test_wsa_action_header` - Action set to `urn:ihe:iti:2007:ProvideAndRegisterDocumentSet-b` | IHE compliance |
| 6.3-UNIT-009 | Unit | P0 | `test_wsa_message_id_format` - MessageID formatted as `urn:uuid:{uuid4}` | IHE compliance |
| 6.3-UNIT-010 | Unit | P0 | `test_wsa_to_header` - To header matches endpoint URL | IHE compliance |
| 6.3-UNIT-011 | Unit | P1 | `test_wsa_reply_to_anonymous` - ReplyTo contains anonymous address | IHE compliance |
| 6.3-UNIT-012 | Unit | P1 | `test_message_id_uniqueness` - Each request generates unique MessageID | Correlation requirement |

### AC5: WS-Security with SAML Assertion

> Signed SAML assertion embedded in WS-Security header

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-013 | Unit | P0 | `test_wsse_security_header_present` - Security header exists with mustUnderstand="true" | Security compliance |
| 6.3-UNIT-014 | Unit | P0 | `test_saml_assertion_embedded` - SAML XML content embedded within Security header | Security compliance |
| 6.3-INT-006 | Integration | P0 | `test_saml_module_integration` - SAMLAssertion.xml_content correctly retrieved and embedded | Module integration |

### AC6: Audit Logging

> Complete SOAP request with MTOM attachment logged to audit file

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-015 | Unit | P1 | `test_request_logged_to_audit` - Complete SOAP request logged | RULE 2 compliance |
| 6.3-UNIT-016 | Unit | P1 | `test_response_logged_to_audit` - Complete SOAP response logged | RULE 2 compliance |
| 6.3-UNIT-017 | Unit | P2 | `test_timing_information_logged` - Duration in milliseconds included in log | Audit completeness |
| 6.3-INT-007 | Integration | P1 | `test_logging_audit_module_integration` - logging_audit module correctly invoked | Module integration |

### AC7: Configurable Timeout

> Request timeout configurable (default 60 seconds for large documents)

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-018 | Unit | P1 | `test_default_timeout_60_seconds` - Default timeout is 60 seconds | Configuration default |
| 6.3-UNIT-019 | Unit | P2 | `test_custom_timeout_accepted` - Custom timeout value accepted in constructor | Configuration flexibility |
| 6.3-INT-008 | Integration | P1 | `test_timeout_enforced_in_request` - Request times out after configured duration | Timeout behavior |

### AC8: Network Error Handling with Retry

> Network error handling with retry logic for transient failures

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-020 | Unit | P0 | `test_exponential_backoff_delays` - Retry delays are 1s, 2s, 4s | Retry logic correctness |
| 6.3-UNIT-021 | Unit | P0 | `test_retry_on_connection_error` - ConnectionError triggers retry | Transient failure handling |
| 6.3-UNIT-022 | Unit | P0 | `test_retry_on_timeout` - Timeout triggers retry | Transient failure handling |
| 6.3-UNIT-023 | Unit | P0 | `test_retry_on_503_service_unavailable` - 503 status triggers retry | Transient failure handling |
| 6.3-UNIT-024 | Unit | P1 | `test_no_retry_on_400_bad_request` - 400 status does NOT trigger retry | Error classification |
| 6.3-UNIT-025 | Unit | P1 | `test_no_retry_on_401_unauthorized` - 401 status does NOT trigger retry | Error classification |
| 6.3-UNIT-026 | Unit | P1 | `test_no_retry_on_500_internal_error` - 500 status does NOT trigger retry | Error classification |
| 6.3-UNIT-027 | Unit | P1 | `test_max_retries_exceeded_raises_error` - ITI41TransportError raised after 3 retries | Error boundary |
| 6.3-UNIT-028 | Unit | P2 | `test_retry_attempt_logged` - Each retry attempt logged with reason | Observability |

### AC9: Response Correlation

> Response correlation with request via message ID

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-UNIT-029 | Unit | P1 | `test_relates_to_extraction` - RelatesTo element extracted from response | Correlation logic |
| 6.3-UNIT-030 | Unit | P1 | `test_correlation_match_success` - Correlation returns True when IDs match | Correlation logic |
| 6.3-UNIT-031 | Unit | P2 | `test_correlation_match_failure_logged` - Mismatch logged as warning | Error handling |
| 6.3-INT-009 | Integration | P1 | `test_registry_response_parsing` - XDSb RegistryResponse status extracted | Response parsing |
| 6.3-INT-010 | Integration | P1 | `test_error_list_extraction` - RegistryErrorList errors extracted | Error parsing |

### AC10: Integration Test with Mock Endpoint

> Integration test submits CCD to mock ITI-41 endpoint

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 6.3-INT-011 | Integration | P0 | `test_submit_ccd_to_mock_endpoint` - Full submission workflow to mock | Critical path validation |
| 6.3-E2E-001 | E2E | P0 | `test_complete_iti41_workflow` - End-to-end CCD submission with SAML | Critical user journey |
| 6.3-E2E-002 | E2E | P1 | `test_iti41_error_recovery` - Error response handling and logging | Error recovery path |
| 6.3-E2E-003 | E2E | P2 | `test_iti41_timeout_behavior` - Timeout with mock slow endpoint | Edge case behavior |

---

## Risk Coverage

| Risk | Test Coverage | Scenarios |
|------|---------------|-----------|
| **MTOM packaging failure** | High | 6.3-UNIT-001, 6.3-UNIT-002, 6.3-INT-001, 6.3-INT-002 |
| **WS-Addressing non-compliance** | High | 6.3-UNIT-008 through 6.3-UNIT-012 |
| **SAML embedding failure** | High | 6.3-UNIT-013, 6.3-UNIT-014, 6.3-INT-006 |
| **TLS security weakness** | Medium | 6.3-UNIT-006, 6.3-INT-004 |
| **Retry logic failure** | High | 6.3-UNIT-020 through 6.3-UNIT-028 |
| **Response parsing failure** | Medium | 6.3-INT-009, 6.3-INT-010 |
| **Audit logging gaps** | Medium | 6.3-UNIT-015 through 6.3-INT-007 |

---

## Test Implementation Mapping

### Unit Test File: `tests/unit/test_iti41_client.py`

```python
# Scenarios: 6.3-UNIT-001 through 6.3-UNIT-031 (31 unit tests)
# Estimated test count: 31
# Target coverage: 90%+ on iti41_client.py
```

### Integration Test File: `tests/integration/test_iti41_client_flow.py`

```python
# Scenarios: 6.3-INT-001 through 6.3-INT-011 (11 integration tests)
# Requires: Mock server running (python -m ihe_test_util mock start)
# Test fixtures: tests/fixtures/test_ccd_template.xml
```

### E2E Test Location

E2E tests (6.3-E2E-001 through 6.3-E2E-003) should be included in integration test file or separate E2E test suite if available.

---

## Recommended Execution Order

1. **P0 Unit tests** (12 tests) - Fail fast on critical logic
   - SOAP construction (6.3-UNIT-001, 002)
   - WS-Addressing compliance (6.3-UNIT-008, 009, 010)
   - WS-Security (6.3-UNIT-013, 014)
   - TLS configuration (6.3-UNIT-006)
   - Retry logic (6.3-UNIT-020, 021, 022, 023)

2. **P0 Integration tests** (5 tests) - Validate component boundaries
   - 6.3-INT-001, 002, 004, 006, 011

3. **P0 E2E tests** (1 test) - Critical path
   - 6.3-E2E-001

4. **P1 tests** (14 tests) - Core functionality
   - Remaining unit and integration tests

5. **P2 tests** (6 tests) - As time permits
   - Configuration edge cases
   - Logging details

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 18
    integration: 11
    e2e: 3
  by_priority:
    p0: 12
    p1: 14
    p2: 6
  coverage_gaps: []
  risk_coverage:
    mtom_packaging: HIGH
    ws_addressing: HIGH
    saml_embedding: HIGH
    tls_security: MEDIUM
    retry_logic: HIGH
    response_parsing: MEDIUM
```

---

## Quality Checklist

- [x] Every AC has test coverage (10/10 ACs covered)
- [x] Test levels are appropriate (shifted left - 56% unit)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (IHE compliance = P0)
- [x] Test IDs follow naming convention (6.3-LEVEL-SEQ)
- [x] Scenarios are atomic and independent

---

## Trace References

```text
Test design matrix: docs/qa/assessments/6.3-test-design-20251123.md
P0 tests identified: 12
Story coverage: 10/10 ACs (100%)
