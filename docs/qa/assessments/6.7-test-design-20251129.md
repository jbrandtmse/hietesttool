# Test Design: Story 6.7 - Complete Workflow CLI

Date: 2025-11-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 32
- **Unit tests:** 18 (56%)
- **Integration tests:** 10 (31%)
- **E2E tests:** 4 (13%)
- **Priority distribution:** P0: 8, P1: 14, P2: 8, P3: 2

## Test Levels Justification

| Level | Scope | Rationale |
|-------|-------|-----------|
| Unit | CLI flag parsing, validation, error categorization | Pure logic, fast feedback, Click CliRunner |
| Integration | Workflow mode execution, file I/O, config loading | Multi-component interactions |
| E2E | Full workflow execution against mock server | Critical user journeys |

## Test Scenarios by Acceptance Criteria

### AC1: CLI command `submit <csv>` executes complete workflow

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-001 | Unit | P0 | `test_submit_csv_direct_command` - Verify `submit <csv>` syntax invokes workflow | CLI argument parsing logic |
| 6.7-UNIT-002 | Unit | P1 | `test_submit_backward_compat_batch_syntax` - Verify `submit batch <csv>` still works | Regression prevention |
| 6.7-INT-001 | Integration | P0 | `test_submit_csv_invokes_integrated_workflow` - CSV triggers full workflow | Multi-component flow |
| 6.7-E2E-001 | E2E | P0 | `test_complete_workflow_end_to_end` - Full CSV → PIX Add → ITI-41 flow | Critical user journey |

### AC2: Option `--ccd-template <file>` (Already Implemented)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-003 | Unit | P2 | `test_ccd_template_option_parsing` - Flag parsed correctly | Backward compatibility |
| 6.7-INT-002 | Integration | P1 | `test_ccd_template_loads_custom_template` - Custom template used for CCD | Integration with template engine |

### AC3: Option `--config <file>` (Already Implemented)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-004 | Unit | P2 | `test_config_option_parsing` - Flag parsed correctly | Backward compatibility |
| 6.7-INT-003 | Integration | P1 | `test_config_loads_custom_settings` - Custom config overrides defaults | Integration with config manager |

### AC4: Option `--pix-only` executes only PIX Add

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-005 | Unit | P0 | `test_pix_only_flag_parsing` - Flag recognized and stored | CLI flag logic |
| 6.7-UNIT-006 | Unit | P1 | `test_pix_only_skips_iti41_status` - Result shows ITI-41 as 'skipped' | Business logic |
| 6.7-INT-004 | Integration | P0 | `test_pix_only_executes_pix_add_only` - Only PIX Add called, ITI-41 skipped | Workflow mode isolation |
| 6.7-INT-005 | Integration | P1 | `test_pix_only_saves_results_json` - PIX results saved for later ITI-41 | File I/O for chained workflow |
| 6.7-E2E-002 | E2E | P1 | `test_pix_only_workflow_against_mock` - PIX-only against mock server | User workflow validation |

### AC5: Option `--iti41-only` (requires `--pix-results`)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-007 | Unit | P0 | `test_iti41_only_requires_pix_results` - Error without --pix-results | Input validation |
| 6.7-UNIT-008 | Unit | P1 | `test_iti41_only_flag_parsing` - Flag recognized and stored | CLI flag logic |
| 6.7-UNIT-009 | Unit | P1 | `test_iti41_only_loads_pix_results_format` - JSON format validated | Data structure validation |
| 6.7-UNIT-010 | Unit | P1 | `test_mutual_exclusion_pix_iti41_only` - Error when both flags used | Business rule enforcement |
| 6.7-INT-006 | Integration | P0 | `test_iti41_only_uses_pix_enterprise_ids` - Enterprise IDs from prior run used | Component integration |
| 6.7-INT-007 | Integration | P1 | `test_iti41_only_skips_failed_pix_patients` - Patients with failed PIX skipped | Business logic |
| 6.7-E2E-003 | E2E | P1 | `test_pix_then_iti41_chained_workflow` - PIX-only followed by ITI-41-only | Chained user journey |

### AC6: Real-time progress display

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-011 | Unit | P1 | `test_progress_format_patient_count` - "Processing patient X/Y" format | Output formatting |
| 6.7-UNIT-012 | Unit | P2 | `test_progress_live_success_rates` - PIX and ITI-41 rates displayed | Calculation logic |
| 6.7-UNIT-013 | Unit | P2 | `test_quiet_flag_suppresses_progress` - --quiet hides progress | Flag behavior |
| 6.7-UNIT-014 | Unit | P2 | `test_verbose_flag_detailed_output` - --verbose shows per-operation detail | Flag behavior |
| 6.7-INT-008 | Integration | P1 | `test_progress_updates_during_processing` - Progress updated after each patient | Real-time integration |

### AC7: Color-coded status output with error reporting

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-015 | Unit | P1 | `test_error_categorization_network` - Network errors categorized | Pure classification logic |
| 6.7-UNIT-016 | Unit | P1 | `test_error_categorization_validation` - Validation errors categorized | Pure classification logic |
| 6.7-UNIT-017 | Unit | P2 | `test_show_errors_flag_displays_details` - --show-errors shows full errors | Flag behavior |
| 6.7-UNIT-018 | Unit | P3 | `test_top_3_errors_display` - Most common errors summarized | Aggregation logic |

### AC8: Option `--output <dir>` for artifacts

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-INT-009 | Integration | P1 | `test_output_dir_creates_structure` - logs/, results/, audit/ created | Directory management |
| 6.7-INT-010 | Integration | P2 | `test_output_dir_saves_all_artifacts` - All artifacts saved to correct locations | File I/O |

### AC9: Summary report with stage breakdown

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-019 | Unit | P1 | `test_summary_includes_csv_parsing_stage` - Stage 1 metrics | Report structure |
| 6.7-UNIT-020 | Unit | P1 | `test_summary_includes_pix_add_stage` - Stage 3 metrics with rates | Report structure |
| 6.7-UNIT-021 | Unit | P1 | `test_summary_includes_iti41_stage` - Stage 4 with skipped count | Report structure |
| 6.7-UNIT-022 | Unit | P2 | `test_summary_throughput_calculation` - patients/minute calculated | Calculation logic |

### AC10: Comprehensive help documentation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 6.7-UNIT-023 | Unit | P3 | `test_help_includes_examples` - --help shows usage examples | Documentation completeness |
| 6.7-E2E-004 | E2E | P2 | `test_help_documentation_accessible` - Help accessible via CLI | User experience |

## Test Scenarios Summary

### Unit Tests (18 tests)

```
6.7-UNIT-001: test_submit_csv_direct_command (P0)
6.7-UNIT-002: test_submit_backward_compat_batch_syntax (P1)
6.7-UNIT-003: test_ccd_template_option_parsing (P2)
6.7-UNIT-004: test_config_option_parsing (P2)
6.7-UNIT-005: test_pix_only_flag_parsing (P0)
6.7-UNIT-006: test_pix_only_skips_iti41_status (P1)
6.7-UNIT-007: test_iti41_only_requires_pix_results (P0)
6.7-UNIT-008: test_iti41_only_flag_parsing (P1)
6.7-UNIT-009: test_iti41_only_loads_pix_results_format (P1)
6.7-UNIT-010: test_mutual_exclusion_pix_iti41_only (P1)
6.7-UNIT-011: test_progress_format_patient_count (P1)
6.7-UNIT-012: test_progress_live_success_rates (P2)
6.7-UNIT-013: test_quiet_flag_suppresses_progress (P2)
6.7-UNIT-014: test_verbose_flag_detailed_output (P2)
6.7-UNIT-015: test_error_categorization_network (P1)
6.7-UNIT-016: test_error_categorization_validation (P1)
6.7-UNIT-017: test_show_errors_flag_displays_details (P2)
6.7-UNIT-018: test_top_3_errors_display (P3)
```

### Integration Tests (10 tests)

```
6.7-INT-001: test_submit_csv_invokes_integrated_workflow (P0)
6.7-INT-002: test_ccd_template_loads_custom_template (P1)
6.7-INT-003: test_config_loads_custom_settings (P1)
6.7-INT-004: test_pix_only_executes_pix_add_only (P0)
6.7-INT-005: test_pix_only_saves_results_json (P1)
6.7-INT-006: test_iti41_only_uses_pix_enterprise_ids (P0)
6.7-INT-007: test_iti41_only_skips_failed_pix_patients (P1)
6.7-INT-008: test_progress_updates_during_processing (P1)
6.7-INT-009: test_output_dir_creates_structure (P1)
6.7-INT-010: test_output_dir_saves_all_artifacts (P2)
```

### E2E Tests (4 tests)

```
6.7-E2E-001: test_complete_workflow_end_to_end (P0)
6.7-E2E-002: test_pix_only_workflow_against_mock (P1)
6.7-E2E-003: test_pix_then_iti41_chained_workflow (P1)
6.7-E2E-004: test_help_documentation_accessible (P2)
```

## Risk Coverage

| Risk | Test IDs | Mitigation |
|------|----------|------------|
| CLI syntax change breaks existing scripts | 6.7-UNIT-002 | Backward compatibility test |
| PIX-only results not usable for ITI-41 | 6.7-INT-005, 6.7-INT-006 | JSON format validation and usage |
| Progress display causes performance issues | 6.7-INT-008 | Integration test with timing |
| Error categorization incorrect | 6.7-UNIT-015, 6.7-UNIT-016 | Unit tests for each category |

## Recommended Execution Order

1. **P0 Unit tests** (4 tests) - Fail fast on core logic
   - 6.7-UNIT-001, 6.7-UNIT-005, 6.7-UNIT-007
2. **P0 Integration tests** (3 tests) - Verify component integration
   - 6.7-INT-001, 6.7-INT-004, 6.7-INT-006
3. **P0 E2E tests** (1 test) - Validate critical path
   - 6.7-E2E-001
4. **P1 tests** (14 tests) - Core functionality
5. **P2 tests** (8 tests) - Secondary features
6. **P3 tests** (2 tests) - Nice-to-have coverage

## Test File Structure

```
tests/
├── unit/
│   └── test_submit_commands.py       # 18 unit tests (6.7-UNIT-*)
├── integration/
│   └── test_submit_cli_integration.py # 10 integration tests (6.7-INT-*)
└── e2e/
    └── test_submit_workflow_e2e.py    # 4 E2E tests (6.7-E2E-*)
```

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 18
    integration: 10
    e2e: 4
  by_priority:
    p0: 8
    p1: 14
    p2: 8
    p3: 2
  coverage_gaps: []
  ac_coverage:
    ac1: 4 tests
    ac2: 2 tests
    ac3: 2 tests
    ac4: 5 tests
    ac5: 7 tests
    ac6: 5 tests
    ac7: 4 tests
    ac8: 2 tests
    ac9: 4 tests
    ac10: 2 tests
```

## Quality Checklist

- [x] Every AC has test coverage (10/10 ACs covered)
- [x] Test levels are appropriate (unit for logic, integration for components, E2E for journeys)
- [x] No duplicate coverage across levels
- [x] Critical paths have multiple levels (AC1: Unit + Integration + E2E)
- [x] Test IDs follow naming convention ({epic}.{story}-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Priority distribution appropriate (25% P0, 44% P1, 25% P2, 6% P3)
