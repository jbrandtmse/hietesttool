# Story 1.10: Configuration File Support

## Status
Ready for Review

## Story

**As a** developer,
**I want** to manage endpoint and certificate configuration via JSON files,
**so that** I don't need to pass numerous CLI flags for every operation.

## Acceptance Criteria

1. Configuration file format is JSON (per technical assumptions)
2. Default config file location: `./config/config.json`, overridable via `--config <path>` CLI flag
3. Config supports sections: `endpoints` (PIX Add, ITI-41 URLs), `certificates` (paths to PEM/PKCS12/DER files), `transport` (HTTP/HTTPS settings), `logging` (log level, file path)
4. Environment variables override config file values (precedence: CLI args > env vars > config file > defaults)
5. Sensitive values (certificate passwords, endpoint credentials) loaded from environment variables, not stored in config file
6. Example configuration file provided in `examples/config.example.json` with documentation
7. Configuration validation on load with clear error messages for invalid structure or missing required fields
8. `config validate <file>` CLI command validates configuration without executing operations
9. Configuration schema documented in user guide
10. Unit tests cover config loading, environment variable overrides, validation errors

## Tasks / Subtasks

- [x] Create config module structure (AC: 1, 2, 3)
  - [x] Create `src/ihe_test_util/config/__init__.py`
  - [x] Create `src/ihe_test_util/config/manager.py` for configuration loading and management
  - [x] Create `src/ihe_test_util/config/schema.py` with pydantic models for validation
  - [x] Create `src/ihe_test_util/config/defaults.py` with default configuration values
  - [x] Export key functions from `__init__.py`: `load_config()`, `Config` class

- [x] Implement pydantic configuration models in schema.py (AC: 1, 3, 7)
  - [x] Define `EndpointsConfig` model with fields: `pix_add_url`, `iti41_url`
  - [x] Define `CertificatesConfig` model with fields: `cert_path`, `key_path`, `cert_format`, `pkcs12_password_env_var`
  - [x] Define `TransportConfig` model with fields: `verify_tls`, `timeout_connect`, `timeout_read`, `max_retries`, `backoff_factor`
  - [x] Define `LoggingConfig` model with fields: `level`, `log_file`, `redact_pii`
  - [x] Define `Config` root model with sections: `endpoints`, `certificates`, `transport`, `logging`
  - [x] Add field validators for URLs (valid HTTP/HTTPS), file paths (Path objects), log levels (valid values)
  - [x] Add custom error messages for validation failures
  - [x] Add complete type hints and Google-style docstrings

- [x] Implement configuration manager in manager.py (AC: 2, 4, 5, 7)
  - [x] Implement `load_config(config_path: Optional[Path] = None) -> Config` function
  - [x] Default config path: `./config/config.json`
  - [x] Support `--config <path>` override via parameter
  - [x] Load JSON file and parse into dict
  - [x] Apply environment variable overrides with `IHE_TEST_` prefix
  - [x] Implement precedence: CLI args > env vars > config file > defaults
  - [x] Validate configuration using pydantic models
  - [x] Return validated `Config` instance
  - [x] Handle missing config file gracefully (use defaults with INFO log)
  - [x] Handle malformed JSON with clear error message
  - [x] Implement `get_endpoint(endpoint_name: str) -> str` method
  - [x] Implement `get_certificate_paths() -> tuple[Path, Path]` method
  - [x] Implement `get_transport_config() -> TransportConfig` method
  - [x] Add complete type hints and Google-style docstrings

- [x] Implement default configuration in defaults.py (AC: 2, 3)
  - [x] Define `DEFAULT_CONFIG` dict with all default values
  - [x] Endpoints: `pix_add_url: "http://localhost:8080/pix/add"`, `iti41_url: "http://localhost:8080/iti41/submit"`
  - [x] Certificates: `cert_path: null`, `key_path: null`, `cert_format: "pem"`
  - [x] Transport: `verify_tls: true`, `timeout_connect: 10`, `timeout_read: 30`, `max_retries: 3`, `backoff_factor: 1.0`
  - [x] Logging: `level: "INFO"`, `log_file: "logs/ihe-test-util.log"`, `redact_pii: false`
  - [x] Document each default value with inline comments

- [x] Integrate python-dotenv for environment variable support (AC: 4, 5)
  - [x] Add python-dotenv dependency to pyproject.toml
  - [x] Load `.env` file if present in project root
  - [x] Support environment variables: `IHE_TEST_PIX_ADD_URL`, `IHE_TEST_ITI41_URL`, `IHE_TEST_CERT_PATH`, `IHE_TEST_KEY_PATH`, `IHE_TEST_LOG_LEVEL`, `IHE_TEST_LOG_FILE`, `IHE_TEST_VERIFY_TLS`, `IHE_TEST_PKCS12_PASSWORD`
  - [x] Environment variables override config file values
  - [x] Document environment variable naming convention in docstring
  - [x] Warn if sensitive values (passwords) found in config file instead of env vars

- [x] Create example configuration file (AC: 6)
  - [x] Create `examples/config.example.json` with all configuration sections
  - [x] Include comments (JSON5-style, documented separately) explaining each field
  - [x] Provide example values for mock endpoints (localhost URLs)
  - [x] Include example certificate paths (relative paths to examples/)
  - [x] Add warnings about not storing sensitive values in config file
  - [x] Document that this file should be copied to `config/config.json` and customized
  - [x] Create `config/README.md` with configuration guide

- [x] Add CLI integration for config flag (AC: 2, 8)
  - [x] Modify `src/ihe_test_util/cli/main.py` to add global `--config <path>` option
  - [x] Call `load_config()` on CLI startup with provided path
  - [x] Store loaded config in click context for access by subcommands
  - [x] Create `config validate <file>` CLI command
  - [x] Validate command should load config, validate, and report results
  - [x] Display validation success with green checkmark
  - [x] Display validation errors with red X and detailed error messages
  - [x] Exit with code 0 for valid config, code 1 for invalid config

- [x] Update existing modules to use Config Manager (AC: 4)
  - [x] Modify `src/ihe_test_util/logging_audit/logger.py` to accept config parameter
  - [x] Update `configure_logging()` to use config values if provided
  - [x] Add helper method `config.get_logging_config() -> LoggingConfig`
  - [x] Document that Config Manager must be used instead of direct `os.getenv()` calls (RULE 3)
  - [x] Add example in docstring showing config integration

- [x] Create configuration documentation (AC: 9)
  - [x] Create `docs/configuration-guide.md` documentation file
  - [x] Document JSON configuration file structure with examples
  - [x] Document all configuration sections: endpoints, certificates, transport, logging
  - [x] Document environment variable overrides with naming convention
  - [x] Document precedence order: CLI > env vars > config file > defaults
  - [x] Document sensitive value handling (env vars only)
  - [x] Provide complete example configuration files for common scenarios
  - [x] Include troubleshooting section for configuration errors
  - [x] Document `config validate` CLI command usage

- [x] Add comprehensive unit tests (AC: 10)
  - [x] Create `tests/unit/test_config.py`
  - [x] Test `load_config()` with valid JSON file
  - [x] Test `load_config()` with missing file (should use defaults)
  - [x] Test `load_config()` with malformed JSON (should raise clear error)
  - [x] Test environment variable overrides work correctly
  - [x] Test precedence order: env vars override config file values
  - [x] Test pydantic validation catches invalid URLs
  - [x] Test pydantic validation catches invalid log levels
  - [x] Test pydantic validation catches invalid file paths
  - [x] Test `get_endpoint()` returns correct URL
  - [x] Test `get_certificate_paths()` returns Path objects
  - [x] Test `get_transport_config()` returns TransportConfig instance
  - [x] Test sensitive value warning when password in config file
  - [x] Test default values used when not provided in config
  - [x] Use pytest AAA pattern and tmp_path fixture for file testing
  - [x] Use monkeypatch fixture for environment variable testing

- [x] Add integration tests (AC: 2, 4, 8)
  - [x] Create `tests/integration/test_config_workflow.py`
  - [x] Test complete workflow: load config → validate → use in operations
  - [x] Test CLI `--config <path>` flag overrides default location
  - [x] Test CLI `config validate` command with valid config
  - [x] Test CLI `config validate` command with invalid config
  - [x] Test environment variables override config file in real workflow
  - [x] Test config integration with logging module
  - [x] Test missing config file falls back to defaults gracefully

- [x] Update project documentation (AC: 6, 9)
  - [x] Update README.md with configuration section
  - [x] Document `--config` CLI flag usage
  - [x] Document `config validate` command
  - [x] Reference detailed configuration guide (docs/configuration-guide.md)
  - [x] Add quick start example using config file
  - [x] Document `.env` file support for environment variables

## Dev Notes

### Previous Story Insights

[Source: Story 1.9 Completion Notes]

Story 1.9 implemented the logging and audit trail foundation. The logging configuration is currently hardcoded in the CLI main.py file and needs to be integrated with the Config Manager in Story 1.10.

**What Story 1.9 Implemented:**
- Logging configuration in `src/ihe_test_util/logging_audit/logger.py`
- `configure_logging(level, log_file, redact_pii)` function
- CLI flags: `--verbose`, `--log-file`, `--redact-pii`
- Logging module ready to accept configuration from Config Manager

**What Story 1.10 Will Add:**
- Config Manager module in `src/ihe_test_util/config/`
- JSON configuration file support
- Environment variable override support
- Integration with logging module for configuration values
- CLI `--config` flag and `config validate` command

**Integration Required:**
- Config Manager should provide logging configuration to `configure_logging()`
- Existing CLI flags should override config file values (maintain precedence)
- Environment variables should follow naming convention: `IHE_TEST_*`

### Tech Stack & Dependencies

[Source: architecture/tech-stack.md]

**Configuration Management:**
- `json` (Python built-in) - JSON parsing
- `pydantic` 2.5+ - Data validation and settings management
  - Type-safe configuration validation
  - Field validators for URLs, paths, log levels
  - Custom error messages for validation failures
- `python-dotenv` 1.0+ - Environment variable management
  - Load `.env` files for configuration
  - Support environment variable overrides
- `pathlib.Path` (Python built-in) - File path handling (RULE 4)

**Additional Dependencies:**
- No new external dependencies beyond those already in tech stack

### File Locations

[Source: architecture/source-tree.md]

**Implementation Files:**
- `src/ihe_test_util/config/__init__.py` - NEW: Module initialization with exported functions
- `src/ihe_test_util/config/manager.py` - NEW: Configuration loading and management
- `src/ihe_test_util/config/schema.py` - NEW: Pydantic configuration models
- `src/ihe_test_util/config/defaults.py` - NEW: Default configuration values
- `src/ihe_test_util/cli/main.py` - MODIFY: Add `--config` flag and `config validate` command
- `src/ihe_test_util/logging_audit/logger.py` - MODIFY: Accept config parameter

**Configuration Files:**
- `config/` - NEW: Configuration file directory
- `config/config.json` - NEW: Default configuration file (created by user, not in Git)
- `config/README.md` - NEW: Configuration directory documentation
- `.env.example` - MODIFY: Add configuration environment variables

**Example Files:**
- `examples/config.example.json` - NEW: Example configuration file with documentation

**Test Files:**
- `tests/unit/test_config.py` - NEW: Unit tests for configuration management
- `tests/integration/test_config_workflow.py` - NEW: Integration tests for config workflows

**Documentation Files:**
- `docs/configuration-guide.md` - NEW: Comprehensive configuration documentation
- `README.md` - MODIFY: Add configuration section

### Coding Standards

[Source: architecture/coding-standards.md]

**MANDATORY Requirements:**

1. **RULE 3: Configuration values via Config Manager only**
   - This story implements the Config Manager that all other modules must use
   - NEVER use `os.getenv()` directly in application code
   - Always use `config.get_endpoint()`, `config.get_certificate_paths()`, etc.
   - Example: `config.get_endpoint("pix_add")` not `os.getenv("PIX_ADD_URL")`

2. **RULE 4: All file I/O MUST use Path objects**
   - Configuration paths must use `pathlib.Path`
   - Example: `Path("config") / "config.json"` not `"config/config.json"`
   - Pydantic models should use `Path` type for file paths

3. **RULE 5: Exceptions must include actionable context**
   - Configuration errors must explain what's wrong and how to fix it
   - Example: `raise ConfigurationError(f"Invalid log level '{level}'. Must be one of: DEBUG, INFO, WARNING, ERROR, CRITICAL")`

4. **RULE 6: No bare except clauses**
   - Catch specific exceptions when loading config
   - Example: `except (FileNotFoundError, json.JSONDecodeError, ValidationError)` not `except:`

5. **RULE 7: Type hints are mandatory**
   - All configuration functions must have complete type hints
   - Example: `def load_config(config_path: Optional[Path] = None) -> Config:`

6. **Docstrings required (Google style)**
   - All public functions must have comprehensive docstrings
   - Include examples showing how to use Config Manager

**Naming Conventions:**
- Module: `config` (snake_case)
- Functions: `load_config()`, `get_endpoint()`, `get_certificate_paths()` (snake_case)
- Classes: `Config`, `EndpointsConfig`, `TransportConfig` (PascalCase)
- Constants: `DEFAULT_CONFIG`, `CONFIG_FILE_PATH` (UPPER_SNAKE_CASE)

### Configuration Schema Design

[Source: architecture/components.md#configuration-manager-module]

**Pydantic Models Structure:**

```python
from pydantic import BaseModel, Field, field_validator, HttpUrl
from pathlib import Path
from typing import Optional

class EndpointsConfig(BaseModel):
    """Configuration for IHE endpoint URLs."""
    pix_add_url: str = Field(..., description="PIX Add endpoint URL")
    iti41_url: str = Field(..., description="ITI-41 endpoint URL")
    
    @field_validator('pix_add_url', 'iti41_url')
    def validate_url(cls, v):
        """Validate URL is valid HTTP/HTTPS."""
        if not v.startswith(('http://', 'https://')):
            raise ValueError(f"Invalid URL: {v}. Must start with http:// or https://")
        return v

class CertificatesConfig(BaseModel):
    """Configuration for certificate and key paths."""
    cert_path: Optional[Path] = None
    key_path: Optional[Path] = None
    cert_format: str = Field(default="pem", description="Certificate format: pem, pkcs12, or der")
    pkcs12_password_env_var: Optional[str] = Field(default="IHE_TEST_PKCS12_PASSWORD", description="Environment variable for PKCS12 password")
    
    @field_validator('cert_format')
    def validate_cert_format(cls, v):
        """Validate certificate format."""
        valid_formats = ['pem', 'pkcs12', 'der']
        if v not in valid_formats:
            raise ValueError(f"Invalid cert_format: {v}. Must be one of: {', '.join(valid_formats)}")
        return v

class TransportConfig(BaseModel):
    """Configuration for HTTP/HTTPS transport."""
    verify_tls: bool = True
    timeout_connect: int = Field(default=10, ge=1, description="Connection timeout in seconds")
    timeout_read: int = Field(default=30, ge=1, description="Read timeout in seconds")
    max_retries: int = Field(default=3, ge=0, description="Maximum retry attempts")
    backoff_factor: float = Field(default=1.0, ge=0.0, description="Exponential backoff factor")

class LoggingConfig(BaseModel):
    """Configuration for logging."""
    level: str = Field(default="INFO", description="Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL")
    log_file: Path = Field(default=Path("logs/ihe-test-util.log"), description="Log file path")
    redact_pii: bool = Field(default=False, description="Redact PII from logs")
    
    @field_validator('level')
    def validate_log_level(cls, v):
        """Validate log level."""
        valid_levels = ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL']
        v_upper = v.upper()
        if v_upper not in valid_levels:
            raise ValueError(f"Invalid log level: {v}. Must be one of: {', '.join(valid_levels)}")
        return v_upper

class Config(BaseModel):
    """Root configuration model."""
    endpoints: EndpointsConfig
    certificates: CertificatesConfig = CertificatesConfig()
    transport: TransportConfig = TransportConfig()
    logging: LoggingConfig = LoggingConfig()
```

**Configuration Manager Pattern:**

```python
from pathlib import Path
from typing import Optional
import json
import os
from dotenv import load_dotenv
from pydantic import ValidationError

from ihe_test_util.config.schema import Config
from ihe_test_util.config.defaults import DEFAULT_CONFIG
from ihe_test_util.utils.exceptions import ConfigurationError

def load_config(config_path: Optional[Path] = None) -> Config:
    """Load configuration from file and environment variables.
    
    Precedence order: CLI args > env vars > config file > defaults
    
    Args:
        config_path: Path to configuration file. Defaults to ./config/config.json
        
    Returns:
        Validated Config instance
        
    Raises:
        ConfigurationError: If configuration is invalid
        
    Example:
        >>> config = load_config(Path("custom/config.json"))
        >>> pix_url = config.endpoints.pix_add_url
    """
    # Load .env file if present
    load_dotenv()
    
    # Determine config file path
    if config_path is None:
        config_path = Path("config") / "config.json"
    
    # Load config file or use defaults
    if config_path.exists():
        try:
            with open(config_path, 'r') as f:
                config_dict = json.load(f)
        except json.JSONDecodeError as e:
            raise ConfigurationError(
                f"Invalid JSON in config file: {config_path}\n"
                f"Error: {e}\n"
                f"Fix: Check JSON syntax at line {e.lineno}, column {e.colno}"
            )
    else:
        logger.info(f"Config file not found: {config_path}. Using defaults.")
        config_dict = DEFAULT_CONFIG.copy()
    
    # Apply environment variable overrides
    config_dict = _apply_env_overrides(config_dict)
    
    # Validate and return
    try:
        return Config(**config_dict)
    except ValidationError as e:
        raise ConfigurationError(f"Configuration validation failed:\n{e}")

def _apply_env_overrides(config_dict: dict) -> dict:
    """Apply environment variable overrides with IHE_TEST_ prefix."""
    # Implementation details...
    pass
```

### Environment Variable Naming Convention

[Source: architecture/components.md#configuration-manager-module]

**Prefix:** `IHE_TEST_`

**Supported Environment Variables:**
- `IHE_TEST_PIX_ADD_URL` - Override PIX Add endpoint URL
- `IHE_TEST_ITI41_URL` - Override ITI-41 endpoint URL
- `IHE_TEST_CERT_PATH` - Override certificate file path
- `IHE_TEST_KEY_PATH` - Override private key file path
- `IHE_TEST_CERT_FORMAT` - Override certificate format (pem/pkcs12/der)
- `IHE_TEST_PKCS12_PASSWORD` - PKCS12 certificate password (sensitive)
- `IHE_TEST_VERIFY_TLS` - Override TLS verification (true/false)
- `IHE_TEST_TIMEOUT_CONNECT` - Override connection timeout (seconds)
- `IHE_TEST_TIMEOUT_READ` - Override read timeout (seconds)
- `IHE_TEST_MAX_RETRIES` - Override max retry attempts
- `IHE_TEST_LOG_LEVEL` - Override log level (DEBUG/INFO/WARNING/ERROR/CRITICAL)
- `IHE_TEST_LOG_FILE` - Override log file path
- `IHE_TEST_REDACT_PII` - Override PII redaction (true/false)

**Environment Variable Handling:**
- All env vars are optional (config file or defaults used if not set)
- Boolean values: "true"/"false" (case-insensitive)
- Numeric values: parsed as int or float
- Path values: converted to `pathlib.Path` objects
- URL values: validated as HTTP/HTTPS

### Configuration Precedence

[Source: architecture/components.md#configuration-manager-module]

**Precedence Order (highest to lowest):**
1. **CLI Arguments** - Flags like `--verbose`, `--log-file`, `--config`
2. **Environment Variables** - `IHE_TEST_*` variables
3. **Configuration File** - `config/config.json` or custom path
4. **Defaults** - Defined in `config/defaults.py`

**Example:**
```
Log level determined by:
1. --verbose CLI flag (sets DEBUG) → Highest priority
2. IHE_TEST_LOG_LEVEL env var → Overrides config file
3. config.json "logging.level" → Overrides default
4. DEFAULT_CONFIG "INFO" → Lowest priority
```

### JSON Configuration File Structure

[Source: Epic 1 Story 1.10 AC3, AC6]

**Example config.json:**
```json
{
  "endpoints": {
    "pix_add_url": "http://localhost:8080/pix/add",
    "iti41_url": "http://localhost:8080/iti41/submit"
  },
  "certificates": {
    "cert_path": "examples/test_cert.pem",
    "key_path": "examples/test_key.pem",
    "cert_format": "pem",
    "pkcs12_password_env_var": "IHE_TEST_PKCS12_PASSWORD"
  },
  "transport": {
    "verify_tls": true,
    "timeout_connect": 10,
    "timeout_read": 30,
    "max_retries": 3,
    "backoff_factor": 1.0
  },
  "logging": {
    "level": "INFO",
    "log_file": "logs/ihe-test-util.log",
    "redact_pii": false
  }
}
```

**Security Best Practices:**
- NEVER store passwords in config.json
- NEVER store API keys in config.json
- NEVER commit config.json with real credentials to Git
- ALWAYS use environment variables for sensitive values
- Warn users if sensitive values detected in config file

### Testing Strategy

[Source: architecture/test-strategy-and-standards.md]

**Test Framework:** pytest 7.4+

**Coverage Target:** 80%+ for config module

**Test Pattern:** AAA (Arrange, Act, Assert)

**Key Test Scenarios:**
1. Test loading valid JSON configuration file
2. Test loading missing configuration file (should use defaults)
3. Test loading malformed JSON (should raise ConfigurationError)
4. Test environment variable overrides work correctly
5. Test precedence order (env vars override config file)
6. Test pydantic validation catches invalid URLs
7. Test pydantic validation catches invalid log levels
8. Test pydantic validation catches invalid file paths
9. Test sensitive value warning when password in config file
10. Test CLI `config validate` command with valid config
11. Test CLI `config validate` command with invalid config

**Pytest Fixtures to Use:**
- `tmp_path` - For creating temporary config files
- `monkeypatch` - For setting environment variables in tests
- `caplog` - For capturing log messages in tests

**Example Test:**
```python
def test_load_config_with_env_override(tmp_path, monkeypatch):
    # Arrange
    config_file = tmp_path / "config.json"
    config_file.write_text('{"endpoints": {"pix_add_url": "http://config-url.com"}}')
    monkeypatch.setenv("IHE_TEST_PIX_ADD_URL", "http://env-url.com")
    
    # Act
    config = load_config(config_file)
    
    # Assert
    assert config.endpoints.pix_add_url == "http://env-url.com"  # Env var overrides file
```

### Integration with Existing Modules

[Source: architecture/components.md]

**Logging Module Integration:**
- `configure_logging()` should accept optional `config: LoggingConfig` parameter
- If config provided, use config values for level, log_file, redact_pii
- CLI flags still override config values (maintain precedence)

**Example:**
```python
# In cli/main.py
config = load_config(config_path)
configure_logging(
    level=verbose_flag or config.logging.level,
    log_file=log_file_flag or config.logging.log_file,
    redact_pii=redact_pii_flag or config.logging.redact_pii
)
```

**Future Module Integration:**
- IHE Transactions module will use `config.get_endpoint("pix_add")` for URLs
- Transport module will use `config.get_transport_config()` for HTTP settings
- SAML module will use `config.get_certificate_paths()` for cert loading

### Project Structure Notes

All file paths verified against architecture/source-tree.md:
- Config module: `src/ihe_test_util/config/` (new directory)
- Config files: `config/` (new directory at project root)
- Example config: `examples/config.example.json` (new file)
- Unit tests: `tests/unit/test_config.py` (new)
- Integration tests: `tests/integration/test_config_workflow.py` (new)
- Documentation: `docs/configuration-guide.md` (new)

No structural conflicts identified.

### Testing

**Test Framework:** pytest 7.4+

**Test Files:**
- `tests/unit/test_config.py` - NEW: Comprehensive unit tests
- `tests/integration/test_config_workflow.py` - NEW: Integration tests with CLI

**Coverage Target:** 80%+ for config module

**Test Pattern:** AAA (Arrange, Act, Assert)

**Key Test Scenarios:**
- Configuration file loading and parsing
- Environment variable overrides
- Precedence order validation
- Pydantic validation of invalid values
- CLI integration with `--config` flag
- CLI `config validate` command
- Default fallback behavior
- Sensitive value handling

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-3-5-sonnet-20241022)

### Completion Notes

Story 1.10 completed successfully with comprehensive configuration file support implementation.

**Implementation Summary:**
- Created complete config module with pydantic validation (schema.py, manager.py, defaults.py)
- Implemented JSON configuration file support with `./config/config.json` default location
- Added environment variable overrides with `IHE_TEST_*` prefix
- Implemented configuration precedence: CLI args > env vars > config file > defaults
- Added CLI `--config` flag and `config validate` command
- Integrated with logging module for configuration-based setup
- Created comprehensive documentation (configuration-guide.md, README.md updates)

**Testing Results:**
- 51 unit tests passed (27 original + 24 edge cases)
  - Schema validation: 100% coverage
  - Manager functionality: 86% coverage
  - CLI integration: 98% coverage
- 10 integration tests passed
  - End-to-end configuration workflows
  - CLI integration verified
  - Environment variable overrides validated

**Edge Cases Covered:**
- Empty JSON files, partial configurations
- URL validation with query parameters, ports, special characters
- Certificate format case-sensitivity
- Boolean parsing variations (true/True/1/yes/on)
- Negative/zero value handling for timeouts and retries
- Path object conversions
- Config immutability
- Multiple simultaneous env overrides

**All Acceptance Criteria Met:**
1. ✅ JSON configuration format implemented
2. ✅ Default config location `./config/config.json` with `--config` override
3. ✅ All configuration sections implemented (endpoints, certificates, transport, logging)
4. ✅ Environment variable overrides with proper precedence
5. ✅ Sensitive values loaded from environment variables only
6. ✅ Example configuration file with documentation
7. ✅ Comprehensive validation with clear error messages
8. ✅ `config validate` CLI command implemented
9. ✅ Configuration schema fully documented
10. ✅ Comprehensive unit and integration tests

### Debug Log References
None

### File List

**Source Code:**
- src/ihe_test_util/config/__init__.py (NEW)
- src/ihe_test_util/config/schema.py (NEW)
- src/ihe_test_util/config/manager.py (NEW)
- src/ihe_test_util/config/defaults.py (NEW)
- src/ihe_test_util/cli/main.py (MODIFIED)
- src/ihe_test_util/logging_audit/logger.py (MODIFIED)

**Configuration Files:**
- .env.example (MODIFIED)
- examples/config.example.json (NEW)
- config/README.md (NEW)

**Tests:**
- tests/unit/test_config.py (NEW - 51 tests)
- tests/integration/test_config_workflow.py (NEW - 10 tests)

**Documentation:**
- docs/configuration-guide.md (NEW)
- README.md (MODIFIED)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Scrum Master (Bob) |
| 2025-11-06 | 2.0 | Story completed - Configuration file support implemented | Developer (James) |

## QA Results

### Review Date: 2025-11-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Story 1.10 demonstrates excellent implementation quality with clean architecture, comprehensive validation, and outstanding test coverage. The configuration management system is well-designed using pydantic for validation, implements proper precedence rules, and provides excellent developer experience through clear error messages and comprehensive documentation.

**Strengths:**
- Clean, maintainable code with clear separation of concerns (schema, manager, defaults)
- Comprehensive pydantic validation with actionable error messages
- Excellent test coverage (61 tests: 51 unit + 10 integration)
- Outstanding documentation with detailed configuration guide
- Proper security practices (warnings for sensitive values in config files)
- Full CLI integration with validation command

**Technical Excellence:**
- Proper use of type hints throughout (100% coverage)
- Google-style docstrings on all public functions
- Appropriate use of pathlib.Path for cross-platform compatibility
- Clean error handling with specific exceptions
- No code smells or anti-patterns detected

### Refactoring Performed

No refactoring was needed. The implementation is clean and follows all project standards.

### Compliance Check

- Coding Standards: ✓ **PASS** - All 7 mandatory rules followed
  - RULE 1 (No print): ✓ Uses logging module
  - RULE 2 (IHE logging): N/A for this story
  - RULE 3 (Config Manager): ✓ Implements the Config Manager pattern correctly
  - RULE 4 (Path objects): ✓ All file I/O uses pathlib.Path
  - RULE 5 (Actionable errors): ✓ Excellent error messages with fixes
  - RULE 6 (No bare except): ✓ All exceptions are specific
  - RULE 7 (Type hints): ✓ 100% coverage on all functions
- Project Structure: ✓ **PASS** - Follows source tree organization
- Testing Strategy: ✓ **PASS** - AAA pattern, 61 comprehensive tests
- All ACs Met: ✓ **PASS** - All 10 acceptance criteria fully implemented

### Requirements Traceability

**AC Coverage Analysis:**

1. **AC1: JSON format** ✓ Covered
   - Given a configuration file in JSON format
   - When loaded by the Config Manager
   - Then it is parsed and validated using pydantic models
   - Tests: `test_load_config_with_valid_file`, `test_malformed_json`

2. **AC2: Default location & --config override** ✓ Covered
   - Given default location `./config/config.json`
   - When user provides `--config <path>` flag
   - Then custom path is used instead
   - Tests: `test_cli_with_custom_config_path`, integration tests

3. **AC3: Config sections** ✓ Covered
   - Given configuration with endpoints, certificates, transport, logging sections
   - When config is loaded
   - Then all sections are validated and accessible
   - Tests: All schema tests, `test_load_config_with_valid_file`

4. **AC4: Precedence order** ✓ Covered
   - Given config file, env vars, and CLI args
   - When configuration is loaded
   - Then precedence is: CLI > env vars > config file > defaults
   - Tests: `test_precedence_env_over_file`, `test_cli_flags_override_config_file`

5. **AC5: Sensitive values in env vars** ✓ Covered
   - Given sensitive values like passwords
   - When found in config file
   - Then warning is logged recommending env vars
   - Tests: `test_warn_pkcs12_password_in_config`

6. **AC6: Example config file** ✓ Covered
   - Given `examples/config.example.json`
   - When developer copies it
   - Then it provides complete working example with documentation
   - Files: `examples/config.example.json`, `config/README.md`

7. **AC7: Validation with clear errors** ✓ Covered
   - Given invalid configuration
   - When loaded
   - Then clear, actionable error messages are shown
   - Tests: `test_endpoints_config_invalid_url`, `test_logging_config_invalid_level`, all validation tests

8. **AC8: config validate command** ✓ Covered
   - Given `config validate <file>` CLI command
   - When executed
   - Then validates without running operations
   - Tests: `test_config_validate_valid_file`, `test_config_validate_invalid_file`

9. **AC9: Documentation** ✓ Covered
   - Given configuration schema
   - When developer needs reference
   - Then comprehensive documentation is available
   - Files: `docs/configuration-guide.md` (comprehensive 300+ lines)

10. **AC10: Unit tests** ✓ Covered
    - Given config loading, env overrides, validation
    - When tests are run
    - Then all scenarios are covered
    - Tests: 51 unit tests + 10 integration tests = 61 total

### Test Architecture Assessment

**Test Coverage:**
- Config module: 87% (manager.py), 100% (schema.py)
- CLI integration: 98%
- Overall: 61 tests passing (100% pass rate)

**Test Design Quality:**
- Excellent use of AAA pattern throughout
- Proper use of pytest fixtures (tmp_path, monkeypatch, runner)
- Comprehensive edge case coverage (24 edge case tests)
- Integration tests verify end-to-end workflows
- Good test organization with descriptive class names

**Test Levels:**
- Unit tests appropriately test individual components
- Integration tests verify CLI and workflow integration
- Good balance between unit and integration testing

**Edge Cases Covered:**
- Empty JSON files, partial configurations
- URL validation with query params, ports, special characters
- Boolean parsing variations (true/True/1/yes/on)
- Certificate format case-sensitivity
- Negative/zero value handling
- Path object conversions
- Config immutability
- Multiple simultaneous env overrides

**Recommendations:**
- Consider adding a few more tests for uncovered manager.py lines (104-105, 141-142, etc.)
- These are minor env var parsing edge cases, not critical

### Security Review

✓ **PASS** - No security concerns

**Positive Security Practices:**
- Sensitive values (passwords) trigger warnings if found in config files
- Clear documentation recommending env vars for secrets
- PKCS12 password explicitly uses env var pattern
- Config files can have restrictive permissions
- No hardcoded secrets in any files

**Recommendations:**
- Current implementation is secure
- Documentation clearly warns against storing secrets in config files
- Example files demonstrate proper security patterns

### Performance Considerations

✓ **PASS** - No performance concerns

**Analysis:**
- Config loading is a one-time operation at startup
- Pydantic validation is fast and efficient
- JSON parsing is standard library (optimized)
- No unnecessary file I/O or redundant operations
- Configuration is loaded once and reused

### Non-Functional Requirements (NFRs)

**Security:**
- Status: **PASS**
- Notes: Proper handling of sensitive values, warnings for passwords in config files, secure defaults

**Performance:**
- Status: **PASS**
- Notes: Efficient one-time loading, no performance bottlenecks

**Reliability:**
- Status: **PASS**
- Notes: Comprehensive error handling, clear error messages, graceful fallback to defaults

**Maintainability:**
- Status: **PASS**
- Notes: Clean code, excellent documentation, comprehensive tests, clear structure

### Files Modified During Review

None - no refactoring was needed.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.10-configuration-file-support.yml

Risk profile: Low risk - well-tested configuration module
NFR assessment: All NFRs met (security, performance, reliability, maintainability)

### Recommended Status

✓ **Ready for Done**

This is an excellent implementation with:
- All 10 acceptance criteria fully met
- 61 comprehensive tests (100% passing)
- Outstanding code quality and documentation
- No blocking issues or concerns
- Proper security practices
- Full compliance with coding standards

Story owner can mark as Done with confidence.
