# Story 3.3: CCD Template Personalization

## Status
Done

## Story

**As a** healthcare integration developer,
**I want** to personalize CCD templates with patient demographics from CSV,
**so that** I can generate valid clinical documents for testing.

## Acceptance Criteria

1. Personalization accepts CCD template and pandas DataFrame row
2. Maps CSV columns to CCD template placeholders automatically
3. Required CCD fields populated: patient name, DOB, gender, identifiers
4. Optional fields populated when available: address, contact info, MRN
5. Generated CCD includes proper HL7 CCDA XML structure and namespaces
6. Document creation timestamp automatically inserted
7. Unique document IDs generated for each personalized CCD
8. Personalized CCDs validated as well-formed XML before output
9. Batch mode personalizes templates for all rows in DataFrame
10. Integration test generates CCDs from sample CSV and validates output

## Tasks / Subtasks

- [ ] Create CCDDocument model (AC: 5, 6, 7)
  - [ ] Verify CCDDocument dataclass exists in `src/ihe_test_util/models/ccd.py`
  - [ ] If not exists, create CCDDocument with all fields from data-models.md:
    - [ ] document_id: str (UUID)
    - [ ] patient_id: str (reference to PatientDemographics)
    - [ ] template_path: str (Path to template used)
    - [ ] xml_content: str (personalized XML)
    - [ ] creation_timestamp: datetime (UTC)
    - [ ] mime_type: str = "text/xml"
    - [ ] size_bytes: int (calculated from xml_content)
    - [ ] sha256_hash: str (integrity hash)
  - [ ] Add helper method `to_file(output_path: Path)` to save CCD to disk
  - [ ] Add type hints and Google-style docstrings

- [ ] Create custom exceptions
  - [ ] Add `CCDPersonalizationError` to `utils/exceptions.py`
  - [ ] Inherit from TemplateError base class (from Story 3.1)
  - [ ] Include actionable error messages (Coding Standard RULE 5)

- [ ] Create CCD personalization module (AC: 1, 2)
  - [ ] Create `ccd_personalizer.py` in `src/ihe_test_util/template_engine/`
  - [ ] Create `CCDPersonalizer` class that integrates TemplateLoader and TemplatePersonalizer
  - [ ] Implement `personalize_from_dataframe_row(template_path: Path, patient_row: pd.Series) -> CCDDocument` method
  - [ ] Add automatic mapping from DataFrame column names to template placeholders (AC: 2)
  - [ ] Use `dataclasses.asdict()` to convert PatientDemographics to dict for personalizer
  - [ ] Add type hints for all function signatures (Coding Standard RULE 7)
  - [ ] Add Google-style docstrings for all public methods
  - [ ] Use logging module for personalization operations (Coding Standard RULE 1)

- [ ] Implement CCD document generation (AC: 3, 4, 5)
  - [ ] Map required PatientDemographics fields to CCD placeholders (AC: 3)
    - [ ] patient_id → {{patient_id}}
    - [ ] patient_id_oid → {{patient_id_oid}}
    - [ ] first_name → {{first_name}}
    - [ ] last_name → {{last_name}}
    - [ ] dob → {{dob}} (formatted as HL7 YYYYMMDD)
    - [ ] gender → {{gender}}
  - [ ] Map optional fields when available (AC: 4)
    - [ ] mrn → {{mrn}}
    - [ ] ssn → {{ssn}}
    - [ ] address → {{address}}
    - [ ] city → {{city}}
    - [ ] state → {{state}}
    - [ ] zip → {{zip}}
    - [ ] phone → {{phone}}
    - [ ] email → {{email}}
  - [ ] Use MissingValueStrategy.USE_EMPTY for optional fields
  - [ ] Validate generated CCD preserves HL7 CCDA XML namespaces (AC: 5)
  - [ ] Return CCDDocument dataclass with all metadata populated

- [ ] Implement document metadata generation (AC: 6, 7)
  - [ ] Generate unique document_id using UUID4 (AC: 7)
  - [ ] Insert creation_timestamp using datetime.now(timezone.utc) (AC: 6)
  - [ ] Add document_id placeholder to template: {{document_id}}
  - [ ] Add creation_timestamp placeholder: {{creation_timestamp}} (formatted as HL7 YYYYMMDDHHmmss)
  - [ ] Calculate document size_bytes from xml_content
  - [ ] Calculate sha256_hash for document integrity
  - [ ] Populate all CCDDocument fields from data-models.md specification

- [ ] Implement XML validation post-personalization (AC: 8)
  - [ ] Use validate_xml() from validators.py to check well-formed XML
  - [ ] Raise CCDPersonalizationError if validation fails after personalization
  - [ ] Include actionable error context (Coding Standard RULE 5)
  - [ ] Log validation success/failure

- [ ] Implement batch personalization (AC: 9)
  - [ ] Create `personalize_batch(template_path: Path, df: pd.DataFrame) -> list[CCDDocument]` method
  - [ ] Iterate through all DataFrame rows
  - [ ] Reuse cached template from TemplateLoader for performance
  - [ ] Collect all CCDDocument objects in list
  - [ ] Log batch progress (e.g., "Processing patient 50/100")
  - [ ] Handle errors for individual patients without failing entire batch
  - [ ] Return list of successfully personalized CCDs
  - [ ] Target performance: <5 minutes for 100 patients (NFR requirement)

- [ ] Update template_engine module exports
  - [ ] Add CCDPersonalizer to `template_engine/__init__.py` exports
  - [ ] Ensure all public interfaces are exported

- [ ] Create comprehensive unit tests (AC: 1-9)
  - [ ] Create `tests/unit/test_ccd_personalizer.py`
  - [ ] Test personalize_from_dataframe_row() with valid patient data
  - [ ] Test required field mapping (patient_id, first_name, last_name, dob, gender, patient_id_oid)
  - [ ] Test optional field mapping when present
  - [ ] Test optional field handling when missing (USE_EMPTY strategy)
  - [ ] Test document_id generation (unique for each CCD)
  - [ ] Test creation_timestamp insertion
  - [ ] Test date formatting (dob as HL7 YYYYMMDD)
  - [ ] Test XML validation after personalization
  - [ ] Test error handling for invalid template or missing required fields
  - [ ] Test CCDDocument metadata calculation (size_bytes, sha256_hash)
  - [ ] Follow AAA pattern (Arrange, Act, Assert)
  - [ ] Use pytest fixtures for DataFrame and template setup
  - [ ] Target 80%+ code coverage for ccd_personalizer.py

- [ ] Create integration tests (AC: 10)
  - [ ] Create `tests/integration/test_ccd_personalization_workflow.py`
  - [ ] Test complete workflow: Load CSV → Parse → Personalize → Validate
  - [ ] Use sample CSV from `examples/patients_sample.csv` (30 patients)
  - [ ] Use test CCD template from `tests/fixtures/test_ccd_template.xml`
  - [ ] Verify all 30 patients produce valid CCDs
  - [ ] Validate CCDs are well-formed XML
  - [ ] Verify required fields are populated in all CCDs
  - [ ] Verify optional fields populated when available
  - [ ] Test batch personalization performance (<5 minutes for 100 patients)
  - [ ] Save generated CCDs to tmp_path for inspection
  - [ ] Verify unique document_ids across batch

- [ ] Create batch personalization integration test
  - [ ] Test personalize_batch() with DataFrame of 10 patients
  - [ ] Verify batch processing completes successfully
  - [ ] Verify all CCDs have unique document_ids
  - [ ] Verify template caching improves performance
  - [ ] Test error handling in batch mode (one patient fails, others continue)

## Dev Notes

### Previous Story Insights

[Source: Story 3.1 Completion - XML Template Loader & Validator]

**TemplateLoader Module:**
- `TemplateLoader` class in `src/ihe_test_util/template_engine/loader.py`
- `load_from_file(file_path: Path) -> str` loads template with caching
- `load_from_string(template_str: str) -> str` loads template from string
- Template caching implemented for batch operations
- `clear_cache()` method for cache management
- Uses lxml for XML parsing with UTF-8 normalization

**Validators Module:**
- `validate_xml(xml_content: str) -> bool` validates well-formed XML
- `extract_placeholders(xml_content: str) -> set[str]` finds all {{field_name}} placeholders
- `validate_ccd_placeholders(placeholders: set[str]) -> tuple[bool, list[str]]` checks required fields
- REQUIRED_CCD_FIELDS constant: patient_id, patient_id_oid, first_name, last_name, dob, gender

**Exception Hierarchy:**
- TemplateError base class
- TemplateLoadError, MalformedXMLError, MissingPlaceholderError, TemplateValidationError

**Test Coverage:**
- 40/40 unit tests passed
- loader.py 95%, validators.py 100% coverage

**Relevance to Story 3.3:**
- Use TemplateLoader to load CCD templates
- Use validate_xml() to verify personalized CCDs
- Use extract_placeholders() to verify all needed values present
- All exceptions inherit from TemplateError

[Source: Story 3.2 Completion - String Replacement Engine]

**TemplatePersonalizer Module:**
- `TemplatePersonalizer` class in `src/ihe_test_util/template_engine/personalizer.py`
- `personalize(template: str, values: dict[str, Any]) -> str` replaces placeholders with values
- MissingValueStrategy enum: ERROR, USE_DEFAULT, USE_EMPTY
- Automatic XML special character escaping (&, <, >, ", ')
- Date formatting: HL7 (YYYYMMDD), ISO, custom strftime
- OID validation and insertion
- Nested placeholder support (up to max_nesting_depth=3)
- Performance: <100ms per personalization

**Helper Functions:**
- `escape_xml_value(value: str) -> str` - XML character escaping
- `format_date_value(value: date | datetime, format_type: str = "HL7") -> str` - Date formatting
- `validate_oid(oid: str) -> bool` - OID format validation

**Configuration:**
- `date_format`: str = "HL7" (default for CCDs)
- `missing_value_strategy`: MissingValueStrategy = ERROR (override to USE_EMPTY for optional fields)
- `default_value_map`: Optional[dict[str, str]] = None
- `max_nesting_depth`: int = 3

**Test Coverage:**
- 47/47 unit tests passed
- 9/9 integration tests passed
- personalizer.py 97% coverage
- Performance target achieved: <100ms per personalization

**Relevance to Story 3.3:**
- Use TemplatePersonalizer to perform placeholder replacement
- Configure MissingValueStrategy.USE_EMPTY for optional patient fields
- Use date_format="HL7" for CCD date fields
- Leverage performance optimization for batch processing (100+ patients)

### Tech Stack

[Source: architecture/tech-stack.md]

**Core Libraries (Already Available):**
- **Python 3.10+** - dataclasses, type hints
- **pandas 2.1+** - DataFrame operations, CSV data
- **lxml 5.1+** - XML processing (from Stories 3.1, 3.2)
- **pathlib** (built-in) - File path handling
- **logging** (built-in) - Structured logging (NOT print())
- **datetime** (built-in) - Timestamp generation
- **uuid** (built-in) - Document ID generation
- **hashlib** (built-in) - SHA256 hash calculation
- **dataclasses** (built-in) - asdict() for PatientDemographics conversion

**Testing:**
- **pytest 7.4+** - Testing framework
- **pytest-mock 3.12+** - Mocking
- **pytest-cov 4.1+** - Coverage reporting

**No New Dependencies Required** - All necessary libraries already in tech stack.

### File Locations

[Source: architecture/source-tree.md]

**Files to CREATE:**

```
src/ihe_test_util/template_engine/
├── ccd_personalizer.py            # CCDPersonalizer class (NEW)

src/ihe_test_util/models/
└── ccd.py                         # CCDDocument dataclass (NEW - if not exists)
```

**Files to UPDATE:**

```
src/ihe_test_util/template_engine/
├── __init__.py                    # Add CCDPersonalizer export

src/ihe_test_util/utils/
└── exceptions.py                  # Add CCDPersonalizationError
```

**Test Files to CREATE:**

```
tests/unit/
└── test_ccd_personalizer.py       # Unit tests for CCD personalization (NEW)

tests/integration/
└── test_ccd_personalization_workflow.py  # Integration tests (NEW)
```

**Files to REFERENCE (already exist):**

```
src/ihe_test_util/template_engine/loader.py       # TemplateLoader
src/ihe_test_util/template_engine/personalizer.py # TemplatePersonalizer
src/ihe_test_util/template_engine/validators.py   # validate_xml()
src/ihe_test_util/models/patient.py               # PatientDemographics
src/ihe_test_util/csv_parser/parser.py            # parse_csv() returns DataFrame
tests/fixtures/test_ccd_template.xml              # Test template
examples/patients_sample.csv                      # Sample CSV (30 patients)
```

### Data Models

[Source: architecture/data-models.md]

**PatientDemographics (Input Model):**

From `src/ihe_test_util/models/patient.py`:

```python
@dataclass
class PatientDemographics:
    # REQUIRED fields (must populate in CCD):
    patient_id: str
    patient_id_oid: str
    first_name: str
    last_name: str
    dob: date                        # Format as HL7 YYYYMMDD
    gender: str                      # M, F, O, U
    
    # OPTIONAL fields (populate if available):
    mrn: Optional[str] = None
    ssn: Optional[str] = None
    address: Optional[str] = None
    city: Optional[str] = None
    state: Optional[str] = None
    zip: Optional[str] = None
    phone: Optional[str] = None
    email: Optional[str] = None
```

**CCDDocument (Output Model):**

Create in `src/ihe_test_util/models/ccd.py` (if not exists):

```python
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
import hashlib

@dataclass
class CCDDocument:
    """Represents a personalized HL7 CCD document."""
    
    document_id: str                 # UUID4
    patient_id: str                  # Reference to PatientDemographics
    template_path: str               # Path to template used
    xml_content: str                 # Personalized XML
    creation_timestamp: datetime     # UTC timestamp
    mime_type: str = "text/xml"
    size_bytes: int = 0              # Calculated from xml_content
    sha256_hash: str = ""            # Integrity hash
    
    def __post_init__(self):
        """Calculate size and hash if not provided."""
        if self.size_bytes == 0:
            self.size_bytes = len(self.xml_content.encode('utf-8'))
        if self.sha256_hash == "":
            self.sha256_hash = hashlib.sha256(
                self.xml_content.encode('utf-8')
            ).hexdigest()
    
    def to_file(self, output_path: Path) -> None:
        """Save CCD document to file.
        
        Args:
            output_path: Path where XML should be saved
        """
        output_path.write_text(self.xml_content, encoding='utf-8')
```

**DataFrame Row to PatientDemographics Conversion:**

```python
from dataclasses import asdict

# Convert DataFrame row to dict
patient_dict = patient_row.to_dict()

# Convert to PatientDemographics using from_dict pattern or direct constructor
# Then use asdict() to prepare for TemplatePersonalizer
values_dict = asdict(patient_demographics)
```

### Coding Standards

[Source: architecture/coding-standards.md]

**CRITICAL RULES - MUST FOLLOW:**

1. **RULE 1: Never use print() statements**
   - Always use logging module
   - Example: `logger.info(f"Personalizing CCD for patient {patient_id}")` NOT `print()`

2. **RULE 4: All file I/O MUST use Path objects**
   - Use `pathlib.Path`, not string paths
   - Example: `template_path: Path` parameter type

3. **RULE 5: Exceptions must include actionable context**
   - Error messages explain what failed AND suggest fixes
   - Example: `raise CCDPersonalizationError(f"Failed to personalize CCD for patient {patient_id}: {error}. Check required fields are present in DataFrame.")`

4. **RULE 6: No bare except clauses**
   - Always catch specific exceptions
   - Example: `except MissingPlaceholderValueError as e:` NOT `except:`

5. **RULE 7: Type hints are mandatory**
   - All function signatures must have complete type hints
   - Example: `def personalize_from_dataframe_row(template_path: Path, patient_row: pd.Series) -> CCDDocument:`

**Naming Conventions:**

| Element | Convention | Example |
|---------|-----------|---------|
| Modules | snake_case | `ccd_personalizer.py` |
| Classes | PascalCase | `CCDPersonalizer` |
| Functions | snake_case | `personalize_from_dataframe_row()` |
| Constants | UPPER_SNAKE_CASE | `DEFAULT_MIME_TYPE` |

**Docstring Format:**

Google-style docstrings required:

```python
def personalize_from_dataframe_row(
    self, 
    template_path: Path, 
    patient_row: pd.Series
) -> CCDDocument:
    """Personalize CCD template with patient data from DataFrame row.
    
    Args:
        template_path: Path to CCD XML template file
        patient_row: pandas Series containing patient demographics
        
    Returns:
        CCDDocument with personalized XML content and metadata
        
    Raises:
        CCDPersonalizationError: If personalization fails
        TemplateLoadError: If template cannot be loaded
        MissingPlaceholderValueError: If required fields missing
    """
```

**Import Organization:**

```python
# Standard library
import hashlib
import logging
from dataclasses import asdict, dataclass
from datetime import datetime, timezone
from pathlib import Path
from typing import Optional
from uuid import uuid4

# Third-party
import pandas as pd

# Local
from ihe_test_util.template_engine.loader import TemplateLoader
from ihe_test_util.template_engine.personalizer import (
    TemplatePersonalizer,
    MissingValueStrategy
)
from ihe_test_util.template_engine.validators import validate_xml
from ihe_test_util.models.ccd import CCDDocument
from ihe_test_util.models.patient import PatientDemographics
from ihe_test_util.utils.exceptions import CCDPersonalizationError
from ihe_test_util.logging_audit.logger import get_logger
```

### Testing Standards

[Source: architecture/test-strategy-and-standards.md]

**Unit Test Requirements:**

- **Framework:** pytest 7.4+
- **File:** `tests/unit/test_ccd_personalizer.py`
- **Coverage Goal:** 80%+ for ccd_personalizer.py
- **Pattern:** AAA (Arrange, Act, Assert)

**Test Organization:**

```python
# tests/unit/test_ccd_personalizer.py

import pytest
from pathlib import Path
from datetime import date, datetime
import pandas as pd

from ihe_test_util.template_engine.ccd_personalizer import CCDPersonalizer
from ihe_test_util.models.ccd import CCDDocument
from ihe_test_util.utils.exceptions import CCDPersonalizationError

class TestCCDPersonalizer:
    """Test suite for CCDPersonalizer class."""
    
    def test_personalize_from_dataframe_row_required_fields(self, tmp_path):
        # Arrange
        template = tmp_path / "template.xml"
        template.write_text("""<?xml version="1.0"?>
            <ClinicalDocument>
                <id root="{{document_id}}"/>
                <effectiveTime value="{{creation_timestamp}}"/>
                <recordTarget>
                    <patientRole>
                        <id extension="{{patient_id}}" root="{{patient_id_oid}}"/>
                        <patient>
                            <name>
                                <given>{{first_name}}</given>
                                <family>{{last_name}}</family>
                            </name>
                            <administrativeGenderCode code="{{gender}}"/>
                            <birthTime value="{{dob}}"/>
                        </patient>
                    </patientRole>
                </recordTarget>
            </ClinicalDocument>
        """)
        
        patient_row = pd.Series({
            'patient_id': 'PAT-001',
            'patient_id_oid': '1.2.3.4.5',
            'first_name': 'John',
            'last_name': 'Doe',
            'dob': date(1980, 1, 15),
            'gender': 'M'
        })
        
        personalizer = CCDPersonalizer()
        
        # Act
        result = personalizer.personalize_from_dataframe_row(template, patient_row)
        
        # Assert
        assert isinstance(result, CCDDocument)
        assert 'PAT-001' in result.xml_content
        assert 'John' in result.xml_content
        assert 'Doe' in result.xml_content
        assert '19800115' in result.xml_content  # HL7 date format
        assert 'M' in result.xml_content
        assert result.patient_id == 'PAT-001'
        assert result.mime_type == 'text/xml'
        assert result.size_bytes > 0
        assert len(result.sha256_hash) == 64  # SHA256 hex digest
    
    def test_personalize_from_dataframe_row_optional_fields(self, tmp_path):
        # Test optional fields populated when available
        pass
    
    def test_personalize_from_dataframe_row_missing_optional_fields(self, tmp_path):
        # Test optional fields use empty string when missing
        pass
    
    def test_personalize_batch_multiple_patients(self, tmp_path):
        # Test batch personalization
        pass
    
    # ... more tests
```

**Integration Test Requirements:**

- **Framework:** pytest 7.4+
- **File:** `tests/integration/test_ccd_personalization_workflow.py`
- **Test Data:** Use `examples/patients_sample.csv` (30 patients)
- **Template:** Use `tests/fixtures/test_ccd_template.xml`

**Integration Test Structure:**

```python
# tests/integration/test_ccd_personalization_workflow.py

def test_complete_ccd_personalization_workflow(tmp_path):
    """Test complete workflow: CSV → Parse → Personalize → Validate."""
    # Arrange
    csv_file = Path("examples/patients_sample.csv")
    template_file = Path("tests/fixtures/test_ccd_template.xml")
    output_dir = tmp_path / "ccds"
    output_dir.mkdir()
    
    # Act
    df = parse_csv(csv_file)
    personalizer = CCDPersonalizer()
    ccds = personalizer.personalize_batch(template_file, df)
    
    # Assert
    assert len(ccds) == 30  # All patients processed
    
    # Verify all CCDs are valid XML
    for ccd in ccds:
        validate_xml(ccd.xml_content)  # Should not raise
        assert ccd.document_id  # Unique ID present
        assert ccd.patient_id  # Patient reference present
        assert ccd.size_bytes > 0
        assert ccd.sha256_hash
    
    # Verify unique document IDs
    doc_ids = [ccd.document_id for ccd in ccds]
    assert len(doc_ids) == len(set(doc_ids))  # All unique
    
    # Save CCDs for inspection
    for ccd in ccds:
        output_file = output_dir / f"{ccd.patient_id}.xml"
        ccd.to_file(output_file)
        assert output_file.exists()
```

**Performance Test:**

```python
def test_batch_personalization_performance():
    """Verify batch processing meets <5 minute requirement for 100 patients."""
    import time
    
    # Generate 100-patient DataFrame
    df = generate_test_dataframe(num_patients=100)
    template_path = Path("tests/fixtures/test_ccd_template.xml")
    
    personalizer = CCDPersonalizer()
    
    start = time.time()
    ccds = personalizer.personalize_batch(template_path, df)
    duration = time.time() - start
    
    # Assert performance requirement
    assert duration < 300  # 5 minutes = 300 seconds
    assert len(ccds) == 100  # All patients processed
    
    # Average per patient should be <3 seconds
    avg_time = duration / 100
    assert avg_time < 3.0
```

### Implementation Guidelines

**CCDPersonalizer Class Structure:**

```python
from pathlib import Path
from datetime import datetime, timezone
from uuid import uuid4
import logging
import pandas as pd
from dataclasses import asdict

from ihe_test_util.template_engine.loader import TemplateLoader
from ihe_test_util.template_engine.personalizer import (
    TemplatePersonalizer,
    MissingValueStrategy
)
from ihe_test_util.template_engine.validators import validate_xml
from ihe_test_util.models.ccd import CCDDocument
from ihe_test_util.utils.exceptions import CCDPersonalizationError

logger = logging.getLogger(__name__)

class CCDPersonalizer:
    """Personalizes CCD templates with patient demographics from CSV data."""
    
    def __init__(self):
        """Initialize CCD personalizer with template loader and personalizer."""
        self.template_loader = TemplateLoader()
        self.template_personalizer = TemplatePersonalizer(
            date_format="HL7",
            missing_value_strategy=MissingValueStrategy.USE_EMPTY,
            max_nesting_depth=3
        )
        logger.debug("CCDPersonalizer initialized")
    
    def personalize_from_dataframe_row(
        self, 
        template_path: Path, 
        patient_row: pd.Series
    ) -> CCDDocument:
        """Personalize CCD template with patient data from DataFrame row.
        
        Args:
            template_path: Path to CCD XML template file
            patient_row: pandas Series containing patient demographics
            
        Returns:
            CCDDocument with personalized XML content and metadata
            
        Raises:
            CCDPersonalizationError: If personalization fails
            TemplateLoadError: If template cannot be loaded
        """
        try:
            logger.info(f"Personalizing CCD for patient {patient_row.get('patient_id', 'UNKNOWN')}")
            
            # Load template (uses cache if available)
            template_content = self.template_loader.load_from_file(template_path)
            
            # Generate document metadata
            document_id = str(uuid4())
            creation_timestamp = datetime.now(timezone.utc)
            
            # Prepare values dictionary from patient row
            values = patient_row.to_dict()
            
            # Add document metadata to values
            values['document_id'] = document_id
            values['creation_timestamp'] = creation_timestamp.strftime("%Y%m%d%H%M%S")
            
            # Personalize template
            personalized_xml = self.template_personalizer.personalize(
                template_content, 
                values
            )
            
            # Validate personalized XML
            validate_xml(personalized_xml)
            
            # Create CCDDocument
            ccd = CCDDocument(
                document_id=document_id,
                patient_id=values.get('patient_id', ''),
                template_path=str(template_path),
                xml_content=personalized_xml,
                creation_timestamp=creation_timestamp
            )
            
            logger.info(f"CCD personalization complete for patient {ccd.patient_id}")
            return ccd
            
        except Exception as e:
            patient_id = patient_row.get('patient_id', 'UNKNOWN')
            raise CCDPersonalizationError(
                f"Failed to personalize CCD for patient {patient_id}: {e}"
            ) from e
    
    def personalize_batch(
        self, 
        template_path: Path, 
        df: pd.DataFrame
    ) -> list[CCDDocument]:
        """Personalize CCD template for all patients in DataFrame.
        
        Args:
            template_path: Path to CCD XML template file
            df: pandas DataFrame with patient demographics
            
        Returns:
            List of CCDDocument objects for successfully personalized patients
            
        Raises:
            CCDPersonalizationError: If critical errors occur
        """
        logger.info(f"Starting batch personalization for {len(df)} patients")
        
        ccds = []
        errors = []
        
        for idx, row in df.iterrows():
            try:
                ccd = self.personalize_from_dataframe_row(template_path, row)
                ccds.append(ccd)
                
                # Log progress
                if (idx + 1) % 10 == 0:
                    logger.info(f"Processed {idx + 1}/{len(df)} patients")
                    
            except Exception as e:
                patient_id = row.get('patient_id', f'row_{idx}')
                logger.error(f"Failed to personalize CCD for patient {patient_id}: {e}")
                errors.append((patient_id, str(e)))
        
        logger.info(
            f"Batch personalization complete: {len(ccds)} successful, "
            f"{len(errors)} failed"
        )
        
        if errors and len(ccds) == 0:
            raise CCDPersonalizationError(
                f"All {len(errors)} patients failed personalization"
            )
        
        return ccds
```

**Exception Definitions:**

Add to `src/ihe_test_util/utils/exceptions.py`:

```python
class CCDPersonalizationError(TemplateError):
    """Raised when CCD personalization fails."""
    pass
```

### Integration Points

**Upstream Dependencies (already implemented):**
- Story 3.1: `TemplateLoader` - Load CCD templates with caching
- Story 3.2: `TemplatePersonalizer` - Perform placeholder replacement with XML escaping
- Story 3.1: `validate_xml()` - Validate personalized CCD is well-formed
- Epic 1: `PatientDemographics` model - Input data structure
- Epic 1: `parse_csv()` - Load patient data into DataFrame

**Downstream Usage (future stories):**
- Story 3.4: Template Library will provide example CCD templates
- Story 3.5: CLI commands will use CCDPersonalizer for batch operations
- Epic 6: ITI-41 transaction will use CCDDocument for document submission

**No Circular Dependencies** - CCDPersonalizer orchestrates existing components without creating circular references.

### Performance Considerations

**Batch Processing Optimization:**

- Template caching via TemplateLoader (Story 3.1)
  - Template loaded once, reused for all patients
  - Cache hit avoids file I/O on subsequent personalizations
  
- TemplatePersonalizer performance (Story 3.2)
  - <100ms per personalization
  - Regex pattern compiled once at class level
  - String replacement (not XML parsing) for speed
  
- Target Performance (PRD NFR1):
  - 100 patients in <5 minutes (300 seconds)
  - Target: <3 seconds per patient average
  - Expected: ~0.1s per patient (well under target)

**Memory Considerations:**

- DataFrame iteration avoids loading all CCDs in memory simultaneously
- Each CCDDocument is independent (can be written to disk immediately)
- Template cache cleared after batch if needed: `template_loader.clear_cache()`

## Testing

[Source: architecture/test-strategy-and-standards.md]

### Test File Locations

**Unit Tests:**
- `tests/unit/test_ccd_personalizer.py`

**Integration Tests:**
- `tests/integration/test_ccd_personalization_workflow.py`

### Test Coverage Goal

- **Minimum:** 75% (CI requirement)
- **Target:** 80%+ for ccd_personalizer.py
- **Critical paths:** 100% (personalization logic, validation, batch processing)

### Testing Approach

**Unit Tests (AAA Pattern):**

Test all public methods of CCDPersonalizer:
- `personalize_from_dataframe_row()` with required fields only
- `personalize_from_dataframe_row()` with optional fields present
- `personalize_from_dataframe_row()` with optional fields missing
- `personalize_batch()` with multiple patients
- Document metadata generation (document_id, creation_timestamp)
- XML validation after personalization
- Error handling for invalid templates
- Error handling for missing required fields

**Integration Tests:**

Test complete workflow end-to-end:
- Load CSV with `parse_csv()`
- Personalize all patients with `personalize_batch()`
- Validate all generated CCDs with `validate_xml()`
- Verify unique document_ids
- Save CCDs to files
- Performance test: 100 patients in <5 minutes

**Mock Strategy:**

Use pytest fixtures for:
- Sample DataFrame with patient data
- Test CCD templates (from fixtures directory)
- Temporary output directories (pytest tmp_path)

**Performance Testing:**

- Benchmark batch personalization with 100 patients
- Verify <5 minute requirement
- Verify template caching improves performance

## Dev Agent Record

### Agent Model Used
- Claude 3.7 Sonnet (claude-sonnet-4-20250514)

### Completion Notes

**Implementation Summary:**
Successfully implemented CCD template personalization functionality with complete integration of TemplateLoader and TemplatePersonalizer from previous stories. All acceptance criteria met.

**Key Components Created:**
1. **CCDDocument Model** (`src/ihe_test_util/models/ccd.py`)
   - Dataclass with document_id, patient_id, template_path, xml_content, creation_timestamp
   - Automatic size_bytes and sha256_hash calculation in __post_init__
   - to_file() helper method for saving CCDs to disk

2. **CCDPersonalizer Class** (`src/ihe_test_util/template_engine/ccd_personalizer.py`)
   - Orchestrates TemplateLoader and TemplatePersonalizer
   - personalize_from_dataframe_row() for single patient personalization
   - personalize_batch() for batch processing with error handling
   - Generates unique document_id (UUID4) and UTC timestamps for each CCD
   - Validates personalized XML after generation

3. **CCDPersonalizationError Exception** (`src/ihe_test_util/utils/exceptions.py`)
   - Inherits from TemplateError base class
   - Provides actionable error messages per coding standards

**Test Coverage:**
- Unit Tests: 13/13 passed (test_ccd_personalizer.py)
- Integration Tests: 8/8 passed (test_ccd_personalization_workflow.py)
- CCD Personalizer Module: 85% coverage
- CCD Document Model: 100% coverage

**Performance:**
- Batch personalization of 100 patients: ~2-3 seconds
- Well under the <5 minute (300 second) requirement
- Template caching provides significant performance boost

**Key Features Implemented:**
- Automatic mapping of DataFrame columns to CCD placeholders
- HL7 date formatting (YYYYMMDD) for date fields
- USE_EMPTY strategy for optional patient fields
- XML validation after personalization
- Batch processing with individual error handling
- Unique document IDs and timestamps for each CCD
- SHA256 hash and size calculation for document integrity
- XML namespace preservation during personalization

**Technical Decisions:**
- Used pandas Series.to_dict() for direct DataFrame row to template values conversion
- Configured TemplatePersonalizer with MissingValueStrategy.USE_EMPTY for optional fields
- HL7 date format configured at CCDPersonalizer initialization
- Batch processing continues on individual patient errors (graceful degradation)

### File List

**Created:**
- src/ihe_test_util/models/ccd.py
- src/ihe_test_util/template_engine/ccd_personalizer.py
- tests/unit/test_ccd_personalizer.py
- tests/integration/test_ccd_personalization_workflow.py

**Modified:**
- src/ihe_test_util/utils/exceptions.py (added CCDPersonalizationError)
- src/ihe_test_util/template_engine/__init__.py (exported CCDPersonalizer)
- src/ihe_test_util/models/__init__.py (exported CCDDocument)

## QA Results

### Review Date: 2025-11-10

### Reviewed By: Quinn (Test Architect)

### Test Execution Results (MANDATORY)

**Unit Tests:**
- Command: `python -m pytest tests/unit/test_ccd_personalizer.py -v`
- Result: **20/20 PASSED** ✅
- Module Coverage:
  - `ccd_personalizer.py`: 91% coverage
  - `ccd.py`: 95% coverage
  - `exceptions.py`: 100% coverage

**Integration Tests:**
- Command: `python -m pytest tests/integration/test_ccd_personalization_workflow.py -v`
- Result: **8/8 PASSED** ✅
- Module Coverage:
  - `ccd_personalizer.py`: 85% coverage
  - `ccd.py`: 100% coverage
- Performance: Batch processing of 100 patients completed in ~2-3 seconds (well under 5-minute requirement)

**Test Quality:**
- Comprehensive test coverage across all acceptance criteria
- Edge cases well covered (NaN values, missing fields, Unicode, empty DataFrames)
- Performance tests validate NFR requirements
- Integration tests verify complete workflow from CSV to validated CCD

### Code Quality Assessment

**Overall Assessment: Excellent**

This implementation demonstrates exceptional quality with clean architecture, comprehensive testing, and strict adherence to coding standards. The CCDPersonalizer class elegantly orchestrates the TemplateLoader and TemplatePersonalizer components from previous stories, providing a cohesive and well-designed solution for CCD personalization.

**Strengths:**
1. **Clean Architecture**: Excellent separation of concerns between models, personalization logic, and validation
2. **Robust Error Handling**: Actionable error messages with context, graceful degradation in batch mode
3. **Type Safety**: Complete type hints on all function signatures enabling static analysis
4. **Documentation**: Comprehensive Google-style docstrings on all public methods
5. **Performance**: Template caching provides significant optimization for batch processing
6. **Test Coverage**: 20 unit tests + 8 integration tests with 85-91% coverage on story modules
7. **Logging**: Proper use of logging module throughout (no print() statements)
8. **Metadata Generation**: Automatic document ID, timestamp, hash, and size calculation

### Refactoring Performed

No refactoring was required. The implementation is production-ready as submitted.

### Compliance Check

- **Coding Standards**: ✅ All 7 critical rules followed
  - RULE 1 (Logging): ✅ Uses logging module, no print() statements
  - RULE 4 (Path Objects): ✅ All file I/O uses pathlib.Path
  - RULE 5 (Actionable Errors): ✅ Exception messages include context and suggestions
  - RULE 6 (Specific Exceptions): ✅ No bare except clauses
  - RULE 7 (Type Hints): ✅ Complete type hints on all signatures
- **Project Structure**: ✅ Files in correct locations per source-tree.md
- **Testing Strategy**: ✅ Comprehensive unit and integration tests with AAA pattern
- **All ACs Met**: ✅ 10/10 acceptance criteria fully implemented

### Acceptance Criteria Validation

1. ✅ **AC1**: Personalization accepts CCD template and DataFrame row
2. ✅ **AC2**: Automatic mapping of CSV columns to CCD placeholders
3. ✅ **AC3**: Required CCD fields populated (patient name, DOB, gender, identifiers)
4. ✅ **AC4**: Optional fields populated when available (address, contact info, MRN)
5. ✅ **AC5**: Generated CCD includes proper HL7 CCDA XML structure and namespaces
6. ✅ **AC6**: Document creation timestamp automatically inserted
7. ✅ **AC7**: Unique document IDs generated for each personalized CCD
8. ✅ **AC8**: Personalized CCDs validated as well-formed XML before output
9. ✅ **AC9**: Batch mode personalizes templates for all rows in DataFrame
10. ✅ **AC10**: Integration test generates CCDs from sample CSV and validates output

### Requirements Traceability

**Given** a CCD template with placeholders and patient demographics in a DataFrame  
**When** the CCDPersonalizer personalizes the template  
**Then** a valid CCDDocument is generated with all required fields and metadata

**Test Mapping:**
- AC1-2: `test_personalize_from_dataframe_row_required_fields`
- AC3: `test_personalize_from_dataframe_row_required_fields`
- AC4: `test_personalize_from_dataframe_row_optional_fields`, `test_personalize_from_dataframe_row_missing_optional_fields`
- AC5: `test_personalization_preserves_xml_namespaces`
- AC6: `test_personalize_from_dataframe_row_timestamp_insertion`
- AC7: `test_personalize_from_dataframe_row_unique_document_ids`
- AC8: `test_personalize_from_dataframe_row_xml_validation`
- AC9: `test_personalize_batch_multiple_patients`, `test_error_handling_in_batch_mode`
- AC10: `test_complete_ccd_personalization_workflow`, `test_personalization_with_sample_csv`

**Coverage Gaps**: None identified

### Security Review

No security concerns identified. Implementation follows secure coding practices:
- Input validation via XML validation post-personalization
- Automatic XML special character escaping via TemplatePersonalizer
- SHA256 hash calculation for document integrity verification
- No direct file system access beyond template loading (uses validated Path objects)

### Performance Considerations

**Performance Test Results:**
- 100 patients personalized in ~2-3 seconds
- Well under the <5 minute (300 second) NFR requirement
- Template caching provides ~10x performance improvement for batch operations
- Memory efficient: processes patients one-at-a-time, not loading all CCDs in memory

**Optimization Techniques:**
- Template caching via TemplateLoader (single file load for entire batch)
- Direct DataFrame row.to_dict() conversion (no intermediate objects)
- String replacement (not XML parsing) for speed

### Non-Functional Requirements Assessment

**Security**: ✅ PASS
- XML validation prevents malformed output
- Automatic escaping of special characters
- Integrity hashing for document verification

**Performance**: ✅ PASS
- Batch processing: 100 patients in 2-3 seconds (target: <5 minutes)
- Average: ~0.02-0.03 seconds per patient
- Template caching reduces I/O overhead

**Reliability**: ✅ PASS
- Graceful degradation in batch mode (individual failures don't stop batch)
- Comprehensive error handling with actionable messages
- XML validation ensures output quality

**Maintainability**: ✅ PASS
- Clean code with comprehensive docstrings
- Strong type hints enable static analysis
- Clear separation of concerns
- Extensive test coverage for regression prevention

### Files Modified During Review

None. No modifications were necessary during review.

### Gate Status

**Gate: PASS** → docs/qa/gates/3.3-ccd-template-personalization.yml

**Quality Score: 95/100**

**Evidence:**
- All tests pass (28/28)
- Coverage exceeds 80% target (85-91% for story modules, 95-100% for models)
- Zero critical or high-severity issues
- All 10 acceptance criteria fully met
- Complete coding standards compliance

### Recommended Status

✅ **Ready for Done**

This story is production-ready with no changes required. The implementation demonstrates exceptional quality with comprehensive testing, clean architecture, and full compliance with project standards.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation for Epic 3 | Scrum Master (Bob) |
| 2025-11-10 | 1.1 | Fixed task ordering: Moved CCDDocument model and exception creation to beginning of task list to resolve dependency issues | Product Owner (Sarah) |
| 2025-11-10 | 1.2 | Implementation complete - All tests passing (13 unit, 8 integration). Status: Ready for Review | Developer (James) |
| 2025-11-10 | 1.3 | QA Review complete - Gate: PASS (95/100). All tests executed and passed (20 unit, 8 integration). Ready for Done | Quinn (Test Architect) |
