# Story 5.6: PIX Add CLI Commands

## Status
Done

## Story

**As a** healthcare integration developer,
**I want** CLI commands for PIX Add operations,
**so that** I can register patients from the terminal.

## Acceptance Criteria

1. CLI command `pix-add register <csv>` registers patients from CSV file
2. Option `--endpoint <url>` specifies PIX Add endpoint (overrides config)
3. Option `--cert <path>` specifies certificate for SAML signing
4. Option `--http` enables HTTP transport (with security warning)
5. Option `--output <file>` saves registration results to JSON file
6. Real-time status display shows progress through patient list
7. Color-coded output: green (success), red (failed), yellow (warning)
8. Summary report displays success rate and error breakdown
9. Option `--dry-run` validates without actually submitting
10. Detailed help documentation with usage examples

## Tasks / Subtasks

- [ ] Review existing PIX Add workflow implementation (AC: 1-10)
  - [ ] Review Story 5.4 PIX Add workflow integration in workflows.py
  - [ ] Review Story 5.5 error handling and error summary in error_summary.py
  - [ ] Identify all functions needed for CLI orchestration
  - [ ] Review existing CSV parsing from Story 1.5 in csv_parser/parser.py
  - [ ] Review existing SAML generation from Story 4.2/4.3 in saml/generator.py

- [ ] Create PIX Add CLI command module (AC: 1)
  - [ ] File: `src/ihe_test_util/cli/pix_commands.py` (NEW)
  - [ ] Import click framework (version 8.1+)
  - [ ] Create `@click.group(name='pix-add')` decorator for command group
  - [ ] Add group to main CLI in `cli/main.py`
  - [ ] Follow CLI exit code conventions: 0 (success), 1 (validation), 2 (transaction), 3 (critical)

- [ ] Implement `pix-add register` command (AC: 1, 2, 3, 4, 5, 9)
  - [ ] File: `src/ihe_test_util/cli/pix_commands.py`
  - [ ] Function: `@click.command(name='register')` with decorator
  - [ ] Parameter: `@click.argument('csv_file', type=click.Path(exists=True))`
  - [ ] Option: `@click.option('--endpoint', '-e', help='PIX Add endpoint URL')`
  - [ ] Option: `@click.option('--cert', '-c', type=click.Path(exists=True), help='Certificate path')`
  - [ ] Option: `@click.option('--http', is_flag=True, help='Use HTTP (displays warning)')`
  - [ ] Option: `@click.option('--output', '-o', type=click.Path(), help='Output JSON file path')`
  - [ ] Option: `@click.option('--dry-run', is_flag=True, help='Validate without submitting')`
  - [ ] Option: `@click.option('--config', type=click.Path(exists=True), help='Config file path')`
  - [ ] Add complete type hints: `def register(csv_file: str, endpoint: Optional[str], ...) -> None:`
  - [ ] Add Google-style docstring explaining command purpose and parameters

- [ ] Implement configuration loading with precedence (AC: 2, 3)
  - [ ] Function: `_load_config_with_overrides(config_path, endpoint, cert, http_flag)`
  - [ ] Load base config from ConfigManager
  - [ ] Override endpoint if --endpoint provided (RULE 3: use ConfigManager)
  - [ ] Override certificate path if --cert provided
  - [ ] Override transport protocol if --http provided
  - [ ] Validate all required config values present
  - [ ] Raise actionable error if config invalid (RULE 5)

- [ ] Display security warning for HTTP transport (AC: 4)
  - [ ] Check if http_flag is True or config uses HTTP endpoint
  - [ ] Use logger.warning() for security message (RULE 1)
  - [ ] Message: "⚠️  WARNING: Using insecure HTTP transport. Patient data will be transmitted unencrypted."
  - [ ] Use click.style() for yellow colored output
  - [ ] Prompt user for confirmation: "Continue? [y/N]"
  - [ ] Exit if user declines

- [ ] Implement dry-run validation mode (AC: 9)
  - [ ] If --dry-run flag set, validate but don't submit
  - [ ] Validate CSV file structure and content
  - [ ] Validate configuration completeness
  - [ ] Validate certificate file exists and is valid
  - [ ] Generate HL7v3 messages without submitting
  - [ ] Generate SAML assertions without submitting
  - [ ] Display validation results with click.echo()
  - [ ] Exit with code 0 if validation passes, 1 if fails

- [ ] Implement real-time progress display (AC: 6)
  - [ ] Load patient count from CSV using csv_parser
  - [ ] Display initial status: "Processing {count} patients from {csv_file}"
  - [ ] For each patient, display: "Patient {n}/{total}: {first_name} {last_name}"
  - [ ] Update status in-place using click.echo() with newline control
  - [ ] Use logging for detailed progress (RULE 1), not print()
  - [ ] Display elapsed time periodically
  - [ ] Note: MVP uses simple line-by-line output, not interactive progress bars

- [ ] Implement color-coded output (AC: 7)
  - [ ] Use click.style() for colored terminal output
  - [ ] Green for success: `click.style('✓ Success', fg='green')`
  - [ ] Red for failures: `click.style('✗ Failed', fg='red')`
  - [ ] Yellow for warnings: `click.style('⚠ Warning', fg='yellow')`
  - [ ] Display per-patient results with appropriate colors
  - [ ] Example: "Patient 1/100: John Doe ✓ Success (PIX ID: 12345)"
  - [ ] Example: "Patient 2/100: Jane Smith ✗ Failed (Connection error)"

- [ ] Implement summary report generation (AC: 8)
  - [ ] Collect statistics during batch processing
  - [ ] Track: total_patients, successful, failed, warnings
  - [ ] Calculate success_rate = successful / total_patients
  - [ ] Get error breakdown from ErrorSummaryCollector (Story 5.5)
  - [ ] Function: `_display_summary_report(stats, error_summary)`
  - [ ] Display formatted summary with color coding
  - [ ] Include error categories and frequencies (from Story 5.5)
  - [ ] Include remediation suggestions for top errors

- [ ] Implement JSON output generation (AC: 5)
  - [ ] If --output flag provided, save results to JSON file
  - [ ] Use pathlib.Path for file operations (RULE 4)
  - [ ] Structure: `{"total": N, "successful": M, "failed": K, "patients": [...]}`
  - [ ] Include per-patient results with status and IDs
  - [ ] Include error details for failed patients
  - [ ] Include timestamp and configuration used
  - [ ] Pretty-print JSON with indent=2
  - [ ] Display confirmation: "Results saved to {output_path}"

- [ ] Integrate with PIX Add workflow from Story 5.4 (AC: 1)
  - [ ] Import PIXAddWorkflow from ihe_transactions.workflows
  - [ ] Import ErrorSummaryCollector from ihe_transactions.error_summary
  - [ ] Call workflow.process_batch(csv_file) for actual submission
  - [ ] Capture BatchProcessingResult with error summary
  - [ ] Handle workflow exceptions with appropriate exit codes
  - [ ] Log complete workflow execution (RULE 2)

- [ ] Implement error handling and exit codes (AC: 1-10)
  - [ ] Validation errors (CSV, config, cert): exit code 1
  - [ ] Transaction errors (network, endpoint): exit code 2
  - [ ] Critical errors (SSL, config missing): exit code 3
  - [ ] Use try/except with specific exceptions (RULE 6)
  - [ ] All errors logged via logging module (RULE 1)
  - [ ] Error messages include remediation guidance (RULE 5)
  - [ ] Example: "Certificate expired. Generate new: scripts/generate_cert.sh"

- [ ] Add help documentation to commands (AC: 10)
  - [ ] Detailed help text for `pix-add register` command
  - [ ] Include usage examples in docstring
  - [ ] Document all options and flags
  - [ ] Add examples section showing common use cases
  - [ ] Example 1: Basic usage with config file
  - [ ] Example 2: Override endpoint URL
  - [ ] Example 3: Use HTTP for testing (with warning)
  - [ ] Example 4: Dry-run validation
  - [ ] Example 5: Save results to JSON file

- [ ] Create comprehensive unit tests (AC: 1-10)
  - [ ] File: `tests/unit/test_pix_commands.py` (NEW)
  - [ ] Use pytest with click.testing.CliRunner
  - [ ] Test: `test_pix_add_register_basic_usage`
    - [ ] Mock PIXAddWorkflow.process_batch()
    - [ ] Invoke register command with CSV file
    - [ ] Verify command succeeds (exit code 0)
  - [ ] Test: `test_pix_add_register_endpoint_override`
    - [ ] Provide --endpoint flag
    - [ ] Verify config uses provided endpoint
  - [ ] Test: `test_pix_add_register_cert_override`
    - [ ] Provide --cert flag
    - [ ] Verify config uses provided certificate
  - [ ] Test: `test_pix_add_register_http_warning`
    - [ ] Provide --http flag
    - [ ] Verify security warning displayed
    - [ ] Mock user input declining → exit code 1
  - [ ] Test: `test_pix_add_register_output_json`
    - [ ] Provide --output flag
    - [ ] Verify JSON file created with correct structure
  - [ ] Test: `test_pix_add_register_dry_run`
    - [ ] Provide --dry-run flag
    - [ ] Verify validation runs but no submission
    - [ ] Verify process_batch() not called
  - [ ] Test: `test_pix_add_register_progress_display`
    - [ ] Mock CSV with 3 patients
    - [ ] Verify progress messages for each patient
  - [ ] Test: `test_pix_add_register_color_output`
    - [ ] Mock successful and failed patients
    - [ ] Verify click.style() called with correct colors
  - [ ] Test: `test_pix_add_register_summary_report`
    - [ ] Mock batch results with mixed success/failure
    - [ ] Verify summary statistics displayed
  - [ ] Test: `test_pix_add_register_error_exit_codes`
    - [ ] Test validation error → exit code 1
    - [ ] Test transaction error → exit code 2
    - [ ] Test critical error → exit code 3
  - [ ] Test: `test_pix_add_help_documentation`
    - [ ] Invoke with --help flag
    - [ ] Verify help text includes all options
    - [ ] Verify usage examples present
  - [ ] Target 80%+ coverage on pix_commands.py

- [ ] Create integration tests (AC: 1-10)
  - [ ] File: `tests/integration/test_pix_commands_integration.py` (NEW)
  - [ ] Test: `test_pix_add_register_complete_workflow`
    - [ ] Use test CSV file from fixtures
    - [ ] Use mock PIX Add endpoint
    - [ ] Run complete pix-add register command
    - [ ] Verify patients registered successfully
    - [ ] Verify output JSON matches expectations
  - [ ] Test: `test_pix_add_register_with_errors`
    - [ ] Configure mock to return some errors
    - [ ] Verify error handling and summary report
    - [ ] Verify exit code appropriate for errors
  - [ ] Test: `test_pix_add_register_dry_run_integration`
    - [ ] Run dry-run with real CSV
    - [ ] Verify validation messages
    - [ ] Verify no actual network calls

- [ ] Update main CLI entry point (AC: 1)
  - [ ] File: `src/ihe_test_util/cli/main.py`
  - [ ] Import pix_add command group
  - [ ] Add pix_add group to main CLI: `cli.add_command(pix_add)`
  - [ ] Verify `ihe-test-util pix-add --help` works
  - [ ] Verify command appears in top-level help

- [ ] Create usage examples (AC: 10)
  - [ ] File: `examples/pix_add_cli_example.sh` (NEW)
  - [ ] Example 1: Basic registration with default config
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv`
  - [ ] Example 2: Override endpoint
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv --endpoint https://pix.example.com/add`
  - [ ] Example 3: Use custom certificate
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv --cert /path/to/cert.pem`
  - [ ] Example 4: HTTP mode (testing)
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv --http`
  - [ ] Example 5: Save results to JSON
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv --output results.json`
  - [ ] Example 6: Dry-run validation
    - [ ] Command: `ihe-test-util pix-add register examples/patients_sample.csv --dry-run`
  - [ ] Add expected output for each example

- [ ] Update documentation (AC: 10)
  - [ ] File: `docs/quickstart-templates.md` or create new CLI guide
  - [ ] Add section: "PIX Add CLI Commands"
  - [ ] Document all command options and flags
  - [ ] Include usage examples from examples file
  - [ ] Document exit codes and their meanings
  - [ ] Add troubleshooting section for common CLI issues
  - [ ] Document color-coded output meanings
  - [ ] Link to configuration guide for endpoint setup

## Dev Notes

### Previous Story Insights

[Source: Story 5.4 - PIX Add Workflow Integration]

**Existing PIX Add Workflow:**
- Location: `src/ihe_test_util/ihe_transactions/workflows.py`
- Class: `PIXAddWorkflow`
- Method: `process_batch(csv_file: Path) -> BatchProcessingResult`
- Already implements: Sequential patient processing, error categorization, batch results
- Returns: BatchProcessingResult with success/failure counts, patient IDs, error details

[Source: Story 5.5 - PIX Add Error Handling & Resilience]

**Error Summary System:**
- Location: `src/ihe_test_util/ihe_transactions/error_summary.py`
- Class: `ErrorSummaryCollector`
- Function: `generate_error_report(summary: ErrorSummary) -> str`
- Already implements: Error categorization, frequency tracking, remediation suggestions
- CLI can use this for summary report display (AC: 8)

**Integration Points:**
- CLI orchestrates existing workflow from Story 5.4
- CLI displays error summary from Story 5.5
- CLI adds user interface layer on top of existing business logic
- No new business logic needed - focus is on user experience

### Tech Stack

[Source: architecture/tech-stack.md]

**CLI Framework:**
- **click 8.1+** - Command-line interface framework
- Decorator-based API: `@click.command()`, `@click.option()`
- Built-in help generation and validation
- Color support via `click.style()`
- Testing support via `click.testing.CliRunner`

**Dependencies Already in Project:**
- Python 3.10+ (type hints required)
- logging (RULE 1: all output via logging)
- pathlib.Path (RULE 4: all file I/O)
- json (for JSON output generation)

**No New Dependencies Required** - All libraries already in requirements.txt

### File Locations

[Source: architecture/source-tree.md]

**Files to CREATE:**

```
src/ihe_test_util/cli/
├── pix_commands.py                 # PIX Add CLI commands (NEW)

tests/unit/
├── test_pix_commands.py            # Unit tests for CLI commands (NEW)

tests/integration/
├── test_pix_commands_integration.py # Integration tests (NEW)

examples/
├── pix_add_cli_example.sh          # Usage examples (NEW)
```

**Files to MODIFY:**

```
src/ihe_test_util/cli/
├── main.py                         # Add pix_add command group
```

**Existing Files to USE (no modifications):**

```
src/ihe_test_util/ihe_transactions/
├── workflows.py                    # PIXAddWorkflow.process_batch()
├── error_summary.py                # ErrorSummaryCollector, generate_error_report()

src/ihe_test_util/csv_parser/
├── parser.py                       # CSV parsing functions

src/ihe_test_util/config/
├── manager.py                      # ConfigManager for loading config
```

### CLI Architecture

[Source: architecture/components.md#cli-module]

**CLI Module Structure:**
- Entry point: `src/ihe_test_util/cli/main.py`
- Command groups: Hierarchical organization (csv, template, saml, pix-add, mock)
- Common options: `--config <path>`, `--verbose`, `--output <dir>`
- Exit codes: 0 (success), 1 (validation error), 2 (transaction error), 3 (critical error)

**PIX Add Command Group:**
```python
# pix_commands.py structure
import click

@click.group(name='pix-add')
def pix_add():
    """PIX Add patient registration commands."""
    pass

@pix_add.command(name='register')
@click.argument('csv_file', type=click.Path(exists=True))
@click.option('--endpoint', '-e', help='PIX Add endpoint URL')
@click.option('--cert', '-c', type=click.Path(exists=True), help='Certificate path')
@click.option('--http', is_flag=True, help='Use HTTP (displays warning)')
@click.option('--output', '-o', type=click.Path(), help='Output JSON file')
@click.option('--dry-run', is_flag=True, help='Validate without submitting')
@click.option('--config', type=click.Path(exists=True), help='Config file')
def register(csv_file: str, endpoint: Optional[str], ...) -> None:
    """Register patients from CSV file via PIX Add transaction."""
    pass
```

**CLI Dependencies:**
- CSV Parser (for patient data)
- IHE Transactions (for PIX Add workflow)
- Config Manager (for configuration)
- Logger (for output and audit)

### Click Framework Patterns

[Source: architecture/tech-stack.md + click documentation]

**Command Definition:**
```python
@click.command()
@click.argument('csv_file', type=click.Path(exists=True))
@click.option('--endpoint', '-e', help='PIX Add endpoint URL')
def register(csv_file, endpoint):
    """Register patients from CSV file."""
    pass
```

**Color-Coded Output (AC: 7):**
```python
click.echo(click.style('✓ Success', fg='green'))
click.echo(click.style('✗ Failed', fg='red'))
click.echo(click.style('⚠ Warning', fg='yellow'))
```

**Exit Codes:**
```python
import sys
sys.exit(0)  # Success
sys.exit(1)  # Validation error
sys.exit(2)  # Transaction error
sys.exit(3)  # Critical error

# Or use raise SystemExit(code)
```

**Testing with CliRunner:**
```python
from click.testing import CliRunner

def test_pix_add_register():
    runner = CliRunner()
    result = runner.invoke(register, ['test.csv'])
    assert result.exit_code == 0
    assert 'Success' in result.output
```

### Configuration Precedence

[Source: architecture/components.md#configuration-manager-module]

**Configuration Loading Order:**
1. CLI flags (highest priority) - `--endpoint`, `--cert`, `--http`
2. Environment variables - `IHE_TEST_*`
3. Configuration file - `config/config.json` or `--config <path>`
4. Defaults (lowest priority)

**Implementation (AC: 2, 3):**
```python
def _load_config_with_overrides(config_path, endpoint, cert, http_flag):
    # Load base config from file
    config = ConfigManager.load_config(config_path)
    
    # Override with CLI flags if provided
    if endpoint:
        config.pix_add_endpoint = endpoint
    if cert:
        config.certificate_path = cert
    if http_flag:
        config.transport_protocol = 'http'
    
    return config
```

### JSON Output Format (AC: 5)

**Output Structure:**
```json
{
  "timestamp": "2025-11-19T20:00:00Z",
  "config": {
    "endpoint": "https://pix.example.com/add",
    "csv_file": "patients.csv"
  },
  "summary": {
    "total_patients": 100,
    "successful": 95,
    "failed": 5,
    "success_rate": 0.95
  },
  "patients": [
    {
      "patient_id": "PAT001",
      "name": "John Doe",
      "status": "success",
      "pix_id": "12345^^^1.2.3.4.5&ISO"
    },
    {
      "patient_id": "PAT002",
      "name": "Jane Smith",
      "status": "failed",
      "error": "Connection timeout",
      "error_category": "TRANSIENT"
    }
  ],
  "error_summary": {
    "transient_errors": 3,
    "permanent_errors": 2,
    "critical_errors": 0,
    "top_errors": [
      {
        "type": "Timeout",
        "count": 3,
        "remediation": "Consider increasing timeout in config"
      }
    ]
  }
}
```

### Summary Report Format (AC: 8)

**Terminal Output:**
```
================================================================================
PIX ADD REGISTRATION SUMMARY
================================================================================

Processing Results
--------------------------------------------------------------------------------
Total Patients:         100
Successful:              95 (95.0%)
Failed:                   5 (5.0%)

Error Breakdown
--------------------------------------------------------------------------------
Transient Errors (Retry):    3 (60%)
Permanent Errors (Skip):     2 (40%)
Critical Errors (Halt):      0 (0%)

Top Errors
--------------------------------------------------------------------------------
1. Timeout:                  3 (60%) - Request timeout
   → Consider increasing timeout in config

2. ValidationError:          2 (40%) - Invalid patient data
   → Review CSV data for invalid fields

Affected Patients
--------------------------------------------------------------------------------
Timeout: PAT003, PAT008, PAT019
ValidationError: PAT002, PAT007

================================================================================
```

### Dry-Run Mode (AC: 9)

**Implementation:**
```python
if dry_run:
    click.echo("DRY RUN MODE - No patients will be submitted")
    
    # Validate CSV
    patients = csv_parser.parse_csv(csv_file)
    click.echo(f"✓ CSV validated: {len(patients)} patients")
    
    # Validate config
    config = ConfigManager.load_config(config_path)
    config.validate()
    click.echo(f"✓ Config validated: endpoint {config.pix_add_endpoint}")
    
    # Validate certificate
    cert = CertificateManager.load_pem_certificate(config.certificate_path)
    click.echo(f"✓ Certificate validated: expires {cert.not_valid_after}")
    
    # Generate messages (don't submit)
    for patient in patients[:3]:  # Show first 3
        message = build_pix_add_message(patient)
        click.echo(f"✓ Message generated for {patient.first_name} {patient.last_name}")
    
    click.echo("\nDRY RUN COMPLETE - No errors detected")
    sys.exit(0)
```

### HTTP Security Warning (AC: 4)

**Implementation:**
```python
if http_flag or config.pix_add_endpoint.startswith('http://'):
    warning = click.style(
        "⚠️  WARNING: Using insecure HTTP transport. "
        "Patient data will be transmitted unencrypted.",
        fg='yellow', bold=True
    )
    click.echo(warning)
    
    if not click.confirm("Continue with HTTP?", default=False):
        click.echo("Aborted.")
        sys.exit(1)
```

### Coding Standards

[Source: architecture/coding-standards.md]

**CRITICAL RULES - MUST FOLLOW:**

**RULE 1: Never use print() statements**
- Use logging module for all output
- Example: `logger.info("Processing patient")` NOT `print("Processing patient")`
- For CLI user-facing output, use `click.echo()` or `logger.info()`

**RULE 2: All IHE transactions MUST log complete request/response**
- CLI orchestrates workflow, workflow handles logging
- Ensure workflow logging is enabled

**RULE 3: Configuration values via Config Manager only**
- Never use `os.getenv()` directly
- Example: `config.get_endpoint("pix_add")` NOT `os.getenv("PIX_ADD_URL")`

**RULE 4: All file I/O MUST use Path objects**
- Use `pathlib.Path` not string paths
- Example: `Path(csv_file).read_text()` NOT `open(csv_file).read()`

**RULE 5: Exceptions must include actionable context**
- Error messages explain what failed AND suggest fixes
- Example: `raise ValueError("Invalid CSV file. Expected columns: first_name, last_name, dob, gender")`

**RULE 6: No bare except clauses**
- Always catch specific exceptions
- Example: `except (ValidationError, ConfigError)` NOT `except:`

**RULE 7: Type hints are mandatory**
- All function signatures must have complete type hints
- Example: `def register(csv_file: str, endpoint: Optional[str]) -> None:`

**Google-Style Docstrings Required:**
```python
def register(csv_file: str, endpoint: Optional[str], ...) -> None:
    """Register patients from CSV file via PIX Add transaction.
    
    Orchestrates the complete PIX Add workflow: CSV parsing, HL7v3 message
    construction, SAML signing, SOAP submission, and acknowledgment parsing.
    Displays real-time progress and color-coded results.
    
    Args:
        csv_file: Path to CSV file containing patient demographics
        endpoint: Optional PIX Add endpoint URL (overrides config)
        cert: Optional certificate path for SAML signing
        http: Use HTTP transport (displays security warning)
        output: Optional JSON file path for results
        dry_run: Validate without submitting
        config: Optional config file path
        
    Raises:
        ValidationError: Invalid CSV or configuration
        TransactionError: Network or endpoint errors
        CriticalError: SSL or critical configuration errors
        
    Example:
        >>> ihe-test-util pix-add register patients.csv
        >>> ihe-test-util pix-add register patients.csv --endpoint https://pix.example.com/add
        >>> ihe-test-util pix-add register patients.csv --dry-run
    """
```

## Testing

[Source: architecture/test-strategy-and-standards.md]

### Test File Locations
- Unit tests: `tests/unit/test_pix_commands.py`
- Integration tests: `tests/integration/test_pix_commands_integration.py`

### Test Coverage Goals
- Minimum: 75% (CI fails below)
- Target: 80%+ for CLI module
- Focus: All command options, error handling, output formatting

### Test Framework
- **pytest 7.4+** with click.testing.CliRunner
- **pytest-mock** for mocking workflow and config
- **AAA Pattern**: Arrange, Act, Assert

### Test Scenarios

**Unit Tests (tests/unit/test_pix_commands.py):**
- Command invocation with all option combinations
- Configuration loading and precedence
- HTTP security warning prompt
- Dry-run mode validation
- JSON output generation
- Progress display messages
- Color-coded output formatting
- Summary report generation
- Exit code handling for all error types
- Help documentation completeness

**Integration Tests (tests/integration/test_pix_commands_integration.py):**
- Complete workflow with mock endpoint
- Error handling with mixed results
- Dry-run integration with real CSV
- JSON output file validation

**Testing Pattern:**
```python
from click.testing import CliRunner
import pytest

def test_pix_add_register_basic(mocker, tmp_path):
    # Arrange
    runner = CliRunner()
    csv_file = tmp_path / "patients.csv"
    csv_file.write_text("first_name,last_name,dob,gender,patient_id_oid\nJohn,Doe,1980-01-01,M,1.2.3.4")
    
    mock_workflow = mocker.patch('ihe_test_util.ihe_transactions.workflows.PIXAddWorkflow')
    mock_workflow.return_value.process_batch.return_value = BatchProcessingResult(
        total=1, successful=1, failed=0
    )
    
    # Act
    result = runner.invoke(register, [str(csv_file)])
    
    # Assert
    assert result.exit_code == 0
    assert 'Success' in result.output
    mock_workflow.return_value.process_batch.assert_called_once()
```

## Dev Agent Record

### Implementation Summary

**Implementation Status: COMPLETE**

All 10 acceptance criteria have been implemented and tested:

| AC# | Acceptance Criteria | Implementation | Test Coverage |
|-----|---------------------|----------------|---------------|
| 1 | CLI command `pix-add register <csv>` | ✅ `register` command in `pix_commands.py` | ✅ `test_pix_add_register_basic_usage` |
| 2 | Option `--endpoint <url>` | ✅ `@click.option("--endpoint", "-e")` | ✅ `test_pix_add_register_endpoint_override` |
| 3 | Option `--cert <path>` | ✅ `@click.option("--cert", "-c")` | ✅ `test_pix_add_register_cert_override` |
| 4 | Option `--http` with warning | ✅ `_display_http_security_warning()` | ✅ `test_pix_add_register_http_warning` |
| 5 | Option `--output <file>` JSON | ✅ `_save_json_output()` | ✅ `test_pix_add_register_output_json` |
| 6 | Real-time progress display | ✅ `_display_patient_results()` | ✅ `test_pix_add_register_progress_display` |
| 7 | Color-coded output | ✅ `click.style()` green/red/yellow | ✅ `test_pix_add_register_color_output` |
| 8 | Summary report | ✅ `_display_summary_report()` | ✅ `test_pix_add_register_summary_report` |
| 9 | Option `--dry-run` | ✅ `_execute_dry_run()` | ✅ `test_pix_add_register_dry_run` |
| 10 | Help documentation | ✅ Docstrings with examples | ✅ `test_pix_add_help_documentation` |

### Files Created/Modified

**Created:**
- `src/ihe_test_util/cli/pix_commands.py` - Full CLI command implementation (593 lines)
- `tests/unit/test_pix_commands.py` - 13 unit tests covering all AC
- `tests/integration/test_pix_commands_integration.py` - 4 integration tests

**Modified:**
- `src/ihe_test_util/cli/main.py` - Added `cli.add_command(pix_add)` to register command group

### Test Results

**Unit Tests:** 13/13 passing
- TestPIXAddRegisterBasicUsage: 1 test
- TestPIXAddRegisterOptions: 3 tests
- TestPIXAddRegisterOutputAndDryRun: 2 tests
- TestPIXAddRegisterDisplay: 2 tests
- TestPIXAddRegisterSummary: 1 test
- TestPIXAddRegisterErrorHandling: 2 tests
- TestPIXAddRegisterHelp: 2 tests

**Integration Tests:** 4/4 passing
- test_pix_add_register_complete_workflow
- test_pix_add_register_with_errors
- test_pix_add_register_dry_run_integration
- test_endpoint_override_integration

### Test Fixes Applied (2025-11-21)

During testing, several issues were discovered and fixed in related test files:

1. **test_pix_add_flow.py:**
   - Changed `patient_id_root` to `patient_id_oid` (correct PatientDemographics parameter)
   - Changed `given_name` to `first_name`, `family_name` to `last_name`
   - Changed `birth_date="19800101"` to `dob=date(1980, 1, 1)` (correct type)
   - Changed `street_address` to `address`, `postal_code` to `zip`
   - Fixed expected exception from `ValueError` to `ValidationError`
   - Fixed import path from `src.ihe_test_util.*` to `ihe_test_util.*`

2. **test_pix_add_workflow_integration.py:**
   - Added `config.certificates = Mock()` attribute to integration_config fixture
   - Added `config.certificates.cert_path = "tests/fixtures/test_cert.pem"` string path

### Notes for QA

1. All acceptance criteria have been implemented and verified through tests
2. The `pix-add register` command is fully functional with all options
3. Exit codes follow the documented convention: 0=success, 1=validation, 2=transaction, 3=critical
4. HTTP security warning prompts user for confirmation before proceeding
5. Dry-run mode validates CSV, config, and certificates without submitting
6. JSON output includes timestamp, config, summary, and per-patient results
7. Color-coded output uses click.style() for terminal compatibility

## QA Results

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Test Execution Results

**Unit Tests:**
- Command: `python -m pytest tests/unit/test_pix_commands.py -v`
- Result: **13/13 PASSED** ✅
- Module Coverage: `pix_commands.py` **86%**

**Integration Tests:**
- Command: `python -m pytest tests/integration/test_pix_commands_integration.py -v`
- Result: **4/4 PASSED** ✅
- Module Coverage: `pix_commands.py` **74%**

### Code Quality Assessment

Excellent implementation quality. The code demonstrates:
- Clean separation of concerns with well-defined helper functions
- Comprehensive error handling with appropriate exit codes
- Proper use of Click framework patterns
- Good docstrings with examples
- Complete type hints throughout

### Compliance Check

- Coding Standards: ✓ All 7 rules fully compliant
  - RULE 1: Uses `logger` and `click.echo()` - no print statements
  - RULE 2: Workflow handles transaction logging appropriately
  - RULE 3: Uses `load_config()` from ConfigManager
  - RULE 4: Uses `pathlib.Path` for all file operations
  - RULE 5: Exceptions include actionable remediation context
  - RULE 6: Catches specific exceptions (ValidationError, ConnectionError, etc.)
  - RULE 7: Complete type hints on all function signatures
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ Tests follow AAA pattern with comprehensive mocking
- All ACs Met: ✓ All 10 acceptance criteria verified with tests

### AC Traceability

| AC# | Acceptance Criteria | Test Coverage |
|-----|---------------------|---------------|
| 1 | CLI command `pix-add register <csv>` | ✅ test_pix_add_register_basic_usage |
| 2 | Option `--endpoint <url>` | ✅ test_pix_add_register_endpoint_override |
| 3 | Option `--cert <path>` | ✅ test_pix_add_register_cert_override |
| 4 | Option `--http` with warning | ✅ test_pix_add_register_http_warning |
| 5 | Option `--output <file>` JSON | ✅ test_pix_add_register_output_json |
| 6 | Real-time progress display | ✅ test_pix_add_register_progress_display |
| 7 | Color-coded output | ✅ test_pix_add_register_color_output |
| 8 | Summary report | ✅ test_pix_add_register_summary_report |
| 9 | Option `--dry-run` | ✅ test_pix_add_register_dry_run |
| 10 | Help documentation | ✅ test_pix_add_help_documentation, test_pix_add_register_help_documentation |

### Improvements Checklist

- [x] All unit tests pass (13/13)
- [x] All integration tests pass (4/4)
- [x] Module coverage exceeds 80% target (86%)
- [x] All acceptance criteria have test coverage
- [x] Coding standards fully compliant
- [x] Error handling with appropriate exit codes
- [x] Help documentation includes usage examples

### Security Review

- ✓ HTTP security warning implemented with user confirmation prompt
- ✓ Certificate validation before operations
- ✓ Sensitive configuration handled via ConfigManager

### Performance Considerations

- No performance issues identified
- CLI commands execute efficiently with proper batching

### Files Modified During Review

None - implementation is complete and correct.

### Gate Status

Gate: **PASS** → docs/qa/gates/5.6-pix-add-cli-commands.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria implemented, tested, and verified.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story creation for Epic 5 | Scrum Master (Bob) |
| 2025-11-19 | 1.1 | Story validated and approved for implementation | Product Owner (Sarah) |
| 2025-11-21 | 1.2 | Implementation complete - all 10 AC implemented with tests | Dev Agent (James) |
| 2025-11-21 | 1.3 | Fixed related test files for PatientDemographics parameter names | Dev Agent (James) |
| 2025-11-21 | 1.4 | QA Review PASS - All tests pass, all ACs verified | Quinn (Test Architect) |
