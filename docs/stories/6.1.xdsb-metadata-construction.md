# Story 6.1: XDSb Metadata Construction

## Status
Done

## Story

**As a** developer,
**I want** to construct XDSb metadata for document submissions,
**so that** I can create valid ITI-41 transactions.

## Acceptance Criteria

1. Metadata builder creates ProvideAndRegisterDocumentSetRequest structure
2. Submission set metadata with unique ID, timestamp, source ID
3. Document entry metadata with unique ID, MIME type, hash, size
4. Patient identifier mapping from PIX Add registration results
5. Document classification codes (classCode, typeCode, formatCode) configurable
6. Author information populated from configuration or defaults
7. Metadata associations between submission set and document entries
8. XDSb slot elements for custom metadata attributes
9. Unique IDs generated using UUID or OID-based schemes
10. Unit tests verify metadata structure, required elements, XDSb conformance

## Tasks / Subtasks

- [x] Review existing ITI-41 implementation from Spike 1.1 (AC: 1-10)
  - [x] Review `src/ihe_test_util/ihe_transactions/iti41.py` for existing metadata structure
  - [x] Review spike findings in `docs/spike-findings-1.1-soap-mtom.md`
  - [x] Identify gaps between spike implementation and full XDSb requirements
  - [x] Review existing data models in `src/ihe_test_util/models/`

- [x] Create XDSb metadata builder module (AC: 1)
  - [x] File: `src/ihe_test_util/ihe_transactions/xdsb_metadata.py` (NEW)
  - [x] Class: `XDSbMetadataBuilder` - Main builder class
  - [x] Method: `build_provide_and_register_request() -> lxml.Element`
  - [x] Use lxml 5.1+ for XML construction [Source: architecture/tech-stack.md]
  - [x] Follow XDSb namespace: `urn:ihe:iti:xds-b:2007`
  - [x] Include rim namespace: `urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0`
  - [x] Add complete type hints on all methods (RULE 7)
  - [x] Add Google-style docstrings

- [x] Implement SubmissionSet metadata construction (AC: 2, 6, 9)
  - [x] Method: `_build_submission_set() -> lxml.Element`
  - [x] Create RegistryPackage element with objectType SubmissionSet
  - [x] Generate unique submission set ID using UUID4 format: `urn:uuid:{uuid4}`
  - [x] Add submission timestamp slot: `submissionTime` in HL7 DTM format (YYYYMMDDHHMMSS)
  - [x] Add source ID slot: `sourceId` from configuration (OID-based)
  - [x] Add content type code classification
  - [x] Add author slot with organization/person from configuration
  - [x] Add unique ID external identifier: `XDSSubmissionSet.uniqueId`
  - [x] Add source ID external identifier: `XDSSubmissionSet.sourceId`
  - [x] Add patient ID external identifier: `XDSSubmissionSet.patientId`
  - [x] Use ConfigManager for default author values (RULE 3)

- [x] Implement DocumentEntry metadata construction (AC: 3, 5, 9)
  - [x] Method: `_build_document_entry(document: CCDDocument) -> lxml.Element`
  - [x] Create ExtrinsicObject element with objectType DocumentEntry
  - [x] Generate unique document ID using UUID4 format: `urn:uuid:{uuid4}`
  - [x] Add mimeType attribute: `text/xml` for CCD documents
  - [x] Add hash slot: SHA-256 hash of document content (lowercase hex)
  - [x] Add size slot: Document size in bytes
  - [x] Add creationTime slot: Document creation timestamp
  - [x] Add languageCode slot: `en-US` (configurable)
  - [x] Add repositoryUniqueId slot from configuration
  - [x] Add unique ID external identifier: `XDSDocumentEntry.uniqueId`
  - [x] Add patient ID external identifier: `XDSDocumentEntry.patientId`

- [x] Implement document classification codes (AC: 5)
  - [x] Method: `_add_classification(parent: Element, scheme: str, code: str, display: str, code_system: str)`
  - [x] Add classCode classification (document class - e.g., clinical summary)
  - [x] Add typeCode classification (document type - e.g., CCD)
  - [x] Add formatCode classification (format - e.g., urn:ihe:pcc:xds-ms:2007)
  - [x] Add healthcareFacilityTypeCode classification
  - [x] Add practiceSettingCode classification
  - [x] Add confidentialityCode classification
  - [x] Make all codes configurable via configuration file
  - [x] Provide sensible defaults for CCD documents
  - [x] Class: `XDSbClassificationCodes` dataclass for code configuration

- [x] Implement patient identifier mapping (AC: 4)
  - [x] Method: `set_patient_identifier(patient_id: str, patient_id_oid: str)`
  - [x] Format: `{patient_id}^^^&{oid}&ISO` (CX format)
  - [x] Use patient ID from PIX Add acknowledgment if available
  - [x] Fall back to original patient ID from CSV if PIX Add not performed
  - [x] Validate OID format before use
  - [x] Add external identifier to both SubmissionSet and DocumentEntry

- [x] Implement author information (AC: 6)
  - [x] Method: `_build_author_slot() -> lxml.Element`
  - [x] Author person: XCN format `{id}^{family}^{given}^^^{prefix}^^^&{oid}&ISO`
  - [x] Author institution: XON format `{name}^^^&{oid}&ISO`
  - [x] Author role: From configuration (e.g., "Author", "Provider")
  - [x] Load defaults from configuration file
  - [x] Support override per document if needed

- [x] Implement metadata associations (AC: 7)
  - [x] Method: `_build_association(submission_set_id: str, document_id: str) -> lxml.Element`
  - [x] Create Association element with associationType: `HasMember`
  - [x] Link submission set (sourceObject) to document entry (targetObject)
  - [x] Add SubmissionSetStatus slot: `Original`
  - [x] Generate unique association ID using UUID4

- [x] Implement custom slot elements (AC: 8)
  - [x] Method: `add_slot(name: str, value_type: str, values: list[str])`
  - [x] Support multiple slot value types: ValueList, Value
  - [x] Implement helper: `_build_slot(name: str, values: list[str]) -> lxml.Element`
  - [x] Support common slots: intendedRecipient, legalAuthenticator
  - [x] Allow extensibility for organization-specific slots

- [x] Implement unique ID generation (AC: 9)
  - [x] Method: `_generate_uuid() -> str` - Returns `urn:uuid:{uuid4}`
  - [x] Method: `_generate_oid_based_id(root_oid: str) -> str` - OID extension format
  - [x] Support both UUID and OID-based schemes (configurable)
  - [x] Ensure uniqueness via uuid.uuid4()
  - [x] OID format: `{root_oid}.{timestamp}.{sequence}`

- [x] Create XDSb configuration model (AC: 5, 6)
  - [x] File: `src/ihe_test_util/config/xdsb_config.py` (NEW)
  - [x] Class: `XDSbConfig` using pydantic for validation
  - [x] Fields: source_id, repository_unique_id, author_person, author_institution
  - [x] Fields: class_code, type_code, format_code, confidentiality_code
  - [x] Fields: healthcare_facility_type_code, practice_setting_code
  - [x] Provide defaults for standard CCD document submissions
  - [x] Integrate with ConfigManager

- [x] Update ITI41Transaction model (AC: 1-9)
  - [x] File: `src/ihe_test_util/models/transactions.py`
  - [x] Add `metadata_xml: str` field for constructed XDSb metadata
  - [x] Add `submission_set_id: str` field
  - [x] Add `document_entry_id: str` field
  - [x] Ensure model captures all generated identifiers

- [x] Create unit tests for XDSb metadata (AC: 10)
  - [x] File: `tests/unit/test_xdsb_metadata.py` (NEW)
  - [x] Test: `test_build_submission_set_structure` - Verify RegistryPackage structure
  - [x] Test: `test_submission_set_required_slots` - Verify submissionTime, sourceId
  - [x] Test: `test_build_document_entry_structure` - Verify ExtrinsicObject structure
  - [x] Test: `test_document_entry_hash_calculation` - Verify SHA-256 hash
  - [x] Test: `test_document_entry_size_calculation` - Verify byte count
  - [x] Test: `test_patient_identifier_format` - Verify CX format
  - [x] Test: `test_classification_codes_structure` - Verify code elements
  - [x] Test: `test_association_structure` - Verify HasMember association
  - [x] Test: `test_slot_element_construction` - Verify slot values
  - [x] Test: `test_unique_id_generation_uuid` - Verify UUID format
  - [x] Test: `test_unique_id_generation_oid` - Verify OID extension format
  - [x] Test: `test_author_slot_xcn_format` - Verify author person format
  - [x] Test: `test_complete_request_structure` - Verify full request
  - [x] Test: `test_xdsb_namespace_compliance` - Verify all namespaces correct
  - [x] Use pytest with AAA pattern [Source: architecture/test-strategy-and-standards.md]
  - [x] Target 80%+ coverage on xdsb_metadata.py

- [x] Create integration test for metadata workflow (AC: 1-9)
  - [x] File: `tests/integration/test_xdsb_metadata_integration.py` (NEW)
  - [x] Test: `test_metadata_with_real_ccd_document` - Full CCD metadata generation
  - [x] Test: `test_metadata_patient_id_from_pix_result` - Integration with PIX response
  - [x] Test: `test_metadata_configuration_loading` - Config integration
  - [x] Use test CCD from `tests/fixtures/test_ccd_template.xml`

## Dev Notes

### Previous Story Insights

[Source: Story 5.6 - PIX Add CLI Commands]

**PIX Add Workflow Complete:**
- Location: `src/ihe_test_util/ihe_transactions/workflows.py`
- Class: `PIXAddWorkflow` - Batch patient processing implemented
- Returns: `BatchProcessingResult` with patient IDs and registration status
- Story 6.1 uses patient IDs from PIX Add acknowledgments for ITI-41 metadata

**Relevant for Integration:**
- Patient IDs extracted during PIX Add can be used in XDSb metadata `patientId` fields
- Sequential workflow: CSV → PIX Add → ITI-41 (Story 6.5 will integrate)

### Spike Findings (Story 1.1)

[Source: docs/spike-findings-1.1-soap-mtom.md]

**Existing ITI-41 Implementation:**
- File: `src/ihe_test_util/ihe_transactions/iti41.py`
- Already builds basic ProvideAndRegisterDocumentSetRequest structure
- XDSb metadata structure validated against specification
- Content-ID reference mechanism implemented
- Spike achieved 80% of metadata structure - this story completes remaining 20%

**What's Missing (Story 6.1 Scope):**
- Complete SubmissionSet with all required slots and external identifiers
- Configurable classification codes (classCode, typeCode, formatCode)
- Author information construction
- Proper patient ID external identifiers
- Custom slot support for extensibility
- OID-based unique ID generation option

### Tech Stack

[Source: architecture/tech-stack.md]

**XML Processing:**
- **lxml 5.1+** - XML parsing, template processing, and message construction
- High performance, standards-compliant, supports XPath
- Used for HL7v3 and XDSb metadata construction

**Configuration:**
- **pydantic 2.5+** - Data validation and settings management
- Use for XDSb configuration model

**No New Dependencies Required** - All libraries already in requirements.txt

### Data Models

[Source: architecture/data-models.md#iti-41-transaction]

**ITI41Transaction Model:**
```python
@dataclass
class ITI41Transaction:
    transaction_id: str
    submission_set_id: str
    patient_id: str
    patient_id_oid: str
    ccd_document: CCDDocument
    submission_timestamp: datetime
    source_id: str
    saml_assertion: SAMLAssertion
    mtom_content_id: str
    soap_xml: str
```

**CCDDocument Model (Input):**
```python
@dataclass
class CCDDocument:
    document_id: str
    patient_id: str
    template_path: str
    xml_content: str
    creation_timestamp: datetime
    mime_type: str = "text/xml"
    size_bytes: int = 0
    sha256_hash: str = ""
```

### File Locations

[Source: architecture/source-tree.md]

**Files to CREATE:**

```
src/ihe_test_util/ihe_transactions/
├── xdsb_metadata.py                 # XDSb metadata builder (NEW)

src/ihe_test_util/config/
├── xdsb_config.py                   # XDSb configuration model (NEW)

tests/unit/
├── test_xdsb_metadata.py            # Unit tests (NEW)

tests/integration/
├── test_xdsb_metadata_integration.py # Integration tests (NEW)
```

**Files to MODIFY:**

```
src/ihe_test_util/models/
├── transactions.py                  # Add metadata fields to ITI41Transaction

src/ihe_test_util/config/
├── schema.py                        # Add XDSb config to schema
├── manager.py                       # Add XDSb config loading
```

### XDSb Specification Details

[Source: IHE ITI TF-3 Section 4.2 - ebRIM Metadata Representation]

**Namespaces Required:**
```python
NAMESPACES = {
    'xds': 'urn:ihe:iti:xds-b:2007',
    'rim': 'urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0',
    'rs': 'urn:oasis:names:tc:ebxml-regrep:xsd:rs:3.0',
    'lcm': 'urn:oasis:names:tc:ebxml-regrep:xsd:lcm:3.0'
}
```

**SubmissionSet Required Elements:**
- ExternalIdentifier: uniqueId, sourceId, patientId
- Classification: contentTypeCode
- Slot: submissionTime
- Optional: author, title, comments

**DocumentEntry Required Elements:**
- ExternalIdentifier: uniqueId, patientId
- Classification: classCode, typeCode, formatCode, confidentialityCode, healthcareFacilityTypeCode, practiceSettingCode
- Slot: creationTime, hash, size, languageCode, repositoryUniqueId
- Optional: author, title, comments, serviceStartTime, serviceStopTime

**Classification Structure:**
```xml
<rim:Classification
    classificationScheme="urn:uuid:{scheme-uuid}"
    classifiedObject="{document-id}"
    nodeRepresentation="{code}">
    <rim:Slot name="codingScheme">
        <rim:ValueList>
            <rim:Value>{code-system-oid}</rim:Value>
        </rim:ValueList>
    </rim:Slot>
    <rim:Name>
        <rim:LocalizedString value="{display-name}"/>
    </rim:Name>
</rim:Classification>
```

**Classification Scheme UUIDs:**
- classCode: `urn:uuid:41a5887f-8865-4c09-adf7-e362475b143a`
- typeCode: `urn:uuid:f0306f51-975f-434e-a61c-c59651d33983`
- formatCode: `urn:uuid:a09d5840-386c-46f2-b5ad-9c3699a4309d`
- confidentialityCode: `urn:uuid:f4f85eac-e6cb-4883-b524-f2705394840f`
- healthcareFacilityTypeCode: `urn:uuid:f33fb8ac-18af-42cc-ae0e-ed0b0bdb91e1`
- practiceSettingCode: `urn:uuid:cccf5598-8b07-4b77-a05e-ae952c785ead`
- contentTypeCode (SubmissionSet): `urn:uuid:aa543740-bdda-424e-8c96-df4873be8500`

**External Identifier UUIDs:**
- XDSDocumentEntry.uniqueId: `urn:uuid:2e82c1f6-a085-4c72-9da3-8640a32e42ab`
- XDSDocumentEntry.patientId: `urn:uuid:58a6f841-87b3-4a3e-92fd-a8ffeff98427`
- XDSSubmissionSet.uniqueId: `urn:uuid:96fdda7c-d067-4183-912e-bf5ee74998a8`
- XDSSubmissionSet.sourceId: `urn:uuid:554ac39e-e3fe-47fe-b233-965d2a147832`
- XDSSubmissionSet.patientId: `urn:uuid:6b5aea1a-874d-4603-a4bc-96a0a7b38446`

### Coding Standards

[Source: architecture/coding-standards.md]

**CRITICAL RULES - MUST FOLLOW:**

**RULE 1: Never use print() statements**
- Use logging module: `logger.info()`, `logger.debug()`

**RULE 2: All IHE transactions MUST log complete request/response**
- Log generated XDSb metadata XML for debugging

**RULE 3: Configuration values via Config Manager only**
- Use ConfigManager for XDSb codes, OIDs, author info

**RULE 4: All file I/O MUST use Path objects**
- Use `pathlib.Path` for any template or document paths

**RULE 5: Exceptions must include actionable context**
- Example: `raise MetadataError("Missing classCode. Configure via xdsb.class_code in config.json")`

**RULE 6: No bare except clauses**
- Catch specific exceptions: `except (ValueError, KeyError)`

**RULE 7: Type hints are mandatory**
- All function signatures must have complete type hints

### Example Implementation Pattern

```python
from lxml import etree
from typing import Optional
from dataclasses import dataclass
import uuid
import hashlib
from datetime import datetime

class XDSbMetadataBuilder:
    """Builds XDSb metadata for ITI-41 document submissions.
    
    Constructs ProvideAndRegisterDocumentSetRequest with SubmissionSet,
    DocumentEntry, and Association elements per IHE ITI TF-3 Section 4.2.
    
    Example:
        >>> builder = XDSbMetadataBuilder(config)
        >>> builder.set_patient_identifier("PAT123", "2.16.840.1.113883.3.72.5.9.1")
        >>> builder.set_document(ccd_document)
        >>> metadata_xml = builder.build()
    """
    
    NAMESPACES = {
        'xds': 'urn:ihe:iti:xds-b:2007',
        'rim': 'urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0',
    }
    
    def __init__(self, config: XDSbConfig) -> None:
        """Initialize builder with XDSb configuration."""
        self._config = config
        self._patient_id: Optional[str] = None
        self._document: Optional[CCDDocument] = None
        
    def build(self) -> etree.Element:
        """Build complete ProvideAndRegisterDocumentSetRequest."""
        # Implementation here
        pass
```

## Testing

[Source: architecture/test-strategy-and-standards.md]  
[Source: docs/qa/assessments/6.1-test-design-20251122.md]

### Test Design Summary

| Metric | Count | Percentage |
|--------|-------|------------|
| **Total Test Scenarios** | 32 | 100% |
| **Unit Tests** | 22 | 68.8% |
| **Integration Tests** | 8 | 25.0% |
| **E2E Tests** | 2 | 6.2% |

### Priority Distribution

| Priority | Count | Focus Area |
|----------|-------|------------|
| **P0** | 12 | Critical - Core XDSb structure, patient IDs, hash/size |
| **P1** | 14 | Important - Classifications, associations, author info |
| **P2** | 6 | Secondary - Custom slots, OID generation |

### Test File Locations
- Unit tests: `tests/unit/test_xdsb_metadata.py`
- Integration tests: `tests/integration/test_xdsb_metadata_integration.py`

### Test Coverage Goals
- Minimum: 75% (CI fails below)
- Target: 80%+ for xdsb_metadata.py
- Critical module (IHE Transactions): 90%+

### Test Framework
- **pytest 7.4+** with standard fixtures
- **pytest-mock** for mocking configuration
- **AAA Pattern**: Arrange, Act, Assert

### P0 Unit Tests (Critical - Must Pass)

| ID | Test Scenario | AC |
|----|---------------|----|
| 6.1-UNIT-001 | Verify root element is `ProvideAndRegisterDocumentSetRequest` | AC1 |
| 6.1-UNIT-002 | Verify XDSb namespace `urn:ihe:iti:xds-b:2007` present | AC1 |
| 6.1-UNIT-003 | Verify rim namespace present | AC1 |
| 6.1-UNIT-005 | Verify RegistryPackage with SubmissionSet objectType | AC2 |
| 6.1-UNIT-006 | Verify XDSSubmissionSet.uniqueId external identifier | AC2 |
| 6.1-UNIT-007 | Verify submissionTime slot in YYYYMMDDHHMMSS format | AC2 |
| 6.1-UNIT-010 | Verify ExtrinsicObject with DocumentEntry objectType | AC3 |
| 6.1-UNIT-011 | Verify XDSDocumentEntry.uniqueId external identifier | AC3 |
| 6.1-UNIT-012 | Verify mimeType attribute is `text/xml` | AC3 |
| 6.1-UNIT-013 | Verify hash slot contains SHA-256 lowercase hex | AC3 |
| 6.1-UNIT-014 | Verify size slot matches document byte count | AC3 |
| 6.1-UNIT-015 | Verify patient ID CX format: `{id}^^^&{oid}&ISO` | AC4 |
| 6.1-UNIT-016 | Verify XDSDocumentEntry.patientId external identifier | AC4 |
| 6.1-UNIT-017 | Verify XDSSubmissionSet.patientId external identifier | AC4 |
| 6.1-UNIT-028 | Verify Association element with HasMember type | AC7 |

### P1 Unit Tests (Important)

| ID | Test Scenario | AC |
|----|---------------|----|
| 6.1-UNIT-004 | Verify builder raises error when document not set | AC1 |
| 6.1-UNIT-008 | Verify XDSSubmissionSet.sourceId external identifier | AC2 |
| 6.1-UNIT-009 | Verify sourceId matches configuration value | AC2 |
| 6.1-UNIT-018 | Verify OID format validation rejects invalid OIDs | AC4 |
| 6.1-UNIT-019 | Verify classCode classification element structure | AC5 |
| 6.1-UNIT-020 | Verify typeCode classification element structure | AC5 |
| 6.1-UNIT-021 | Verify formatCode classification element structure | AC5 |
| 6.1-UNIT-022 | Verify confidentialityCode classification present | AC5 |
| 6.1-UNIT-025 | Verify author slot created with XCN format | AC6 |
| 6.1-UNIT-026 | Verify author institution XON format | AC6 |
| 6.1-UNIT-029 | Verify sourceObject references submission set ID | AC7 |
| 6.1-UNIT-030 | Verify targetObject references document entry ID | AC7 |
| 6.1-UNIT-031 | Verify SubmissionSetStatus slot set to "Original" | AC7 |
| 6.1-UNIT-036 | Verify UUID generation returns `urn:uuid:{uuid4}` format | AC9 |
| 6.1-UNIT-037 | Verify UUID uniqueness across multiple calls | AC9 |

### P2 Unit Tests (Secondary)

| ID | Test Scenario | AC |
|----|---------------|----|
| 6.1-UNIT-023 | Verify healthcareFacilityTypeCode classification | AC5 |
| 6.1-UNIT-024 | Verify practiceSettingCode classification | AC5 |
| 6.1-UNIT-027 | Verify default author used when not in config | AC6 |
| 6.1-UNIT-032 | Verify add_slot creates Slot element with ValueList | AC8 |
| 6.1-UNIT-033 | Verify slot supports multiple values | AC8 |
| 6.1-UNIT-038 | Verify OID-based ID generation format | AC9 |

### Integration Tests

| ID | Priority | Test Scenario | AC |
|----|----------|---------------|----|
| 6.1-INT-001 | P1 | Build complete request with real CCD document | AC1 |
| 6.1-INT-002 | P0 | Verify hash calculation against known CCD content | AC3 |
| 6.1-INT-003 | P1 | Verify size calculation against file system size | AC3 |
| 6.1-INT-004 | P1 | Verify patient ID from PIX Add response used | AC4 |
| 6.1-INT-005 | P1 | Verify classification codes loaded from config | AC5 |
| 6.1-INT-006 | P1 | Verify author loaded from configuration | AC6 |
| 6.1-INT-007 | P2 | Verify ID scheme selected from configuration | AC9 |
| 6.1-INT-008 | P0 | Verify complete request validates against XDSb schema | AC10 |

### E2E Tests

| ID | Priority | Test Scenario | AC |
|----|----------|---------------|----|
| 6.1-E2E-001 | P0 | Build full metadata, submit to mock ITI-41 endpoint | AC10 |
| 6.1-E2E-002 | P1 | Build metadata with PIX Add patient ID, verify acceptance | AC10 |

### Key Given-When-Then Patterns

**Patient ID Format (AC4):**
```gherkin
Given a patient ID "PAT123" with OID "2.16.840.1.113883.3.72.5.9.1"
When I set the patient identifier
Then the formatted ID should be "PAT123^^^&2.16.840.1.113883.3.72.5.9.1&ISO"
```

**Hash Verification (AC3):**
```gherkin
Given a CCD document with known content
When I build the document entry
Then hash slot should contain SHA-256 lowercase hex of content
And size slot should match byte count exactly
```

**Association Structure (AC7):**
```gherkin
Given submission set ID "urn:uuid:ss-123" and document ID "urn:uuid:doc-456"
When I build the association
Then Association should have associationType "HasMember"
And sourceObject should reference submission set
And targetObject should reference document entry
```

### Test Data
- Use existing fixtures: `tests/fixtures/test_ccd_template.xml`
- Test certificates: `tests/fixtures/test_cert.pem`
- Test configuration: `tests/fixtures/test_xdsb_config.json` (NEW)
- Pre-calculated hash values for known content verification

## Dev Agent Record

### Agent Model Used
Claude claude-sonnet-4-5-20250929

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes List
- All 38 unit tests pass covering all P0 and P1 scenarios
- All 5 integration tests pass with real CCD documents
- XDSb metadata module achieves 90% test coverage (exceeds 80% target)
- Implementation follows simplified approach per user guidance (base registry table adequate for testing)
- Fixed deprecation warning for datetime.utcnow() -> datetime.now(timezone.utc)
- All classification codes configurable via XDSbConfig pydantic model
- Supports both UUID and OID-based ID generation schemes

### File List
**NEW FILES CREATED:**
- `src/ihe_test_util/config/xdsb_config.py` - XDSb configuration model with pydantic
- `src/ihe_test_util/ihe_transactions/xdsb_metadata.py` - Main XDSb metadata builder
- `src/ihe_test_util/models/transactions.py` - ITI41Transaction and PIXAddMessage models
- `tests/unit/test_xdsb_metadata.py` - 38 unit tests for XDSb metadata
- `tests/integration/test_xdsb_metadata_integration.py` - 5 integration tests

## QA Results

### Review Date: 2025-11-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** Excellent implementation quality. The XDSb metadata builder follows IHE ITI TF-3 Section 4.2 specifications precisely with clean, well-structured code following the builder pattern. All acceptance criteria are fully implemented and tested.

**Implementation Highlights:**
- Clean separation of concerns between configuration (XDSbConfig), builder (XDSbMetadataBuilder), and models
- Comprehensive namespace handling per IHE specifications
- All XDSb classification scheme UUIDs correctly defined as constants
- Proper OID validation with actionable error messages
- Supports both UUID and OID-based ID generation schemes

### Test Execution Results

**Unit Tests:**
- Command: `python -m pytest tests/unit/test_xdsb_metadata.py -v`
- Result: **38/38 PASSED** ✅
- Coverage: `xdsb_metadata.py` **99%**, `xdsb_config.py` **100%**

**Integration Tests:**
- Command: `python -m pytest tests/integration/test_xdsb_metadata_integration.py -v`
- Result: **5/5 PASSED** ✅
- Coverage: `xdsb_metadata.py` **90%** (combined with unit tests exceeds 80% target)

### Refactoring Performed

None required - implementation is clean and follows best practices.

### Compliance Check

- Coding Standards: ✓ All 7 critical rules followed
  - RULE 1: Uses logging module (logger.info(), logger.debug()) - no print statements
  - RULE 2: Logs XDSb metadata generation at debug and info levels
  - RULE 3: Uses ConfigManager via XDSbConfig pydantic model
  - RULE 4: Uses pathlib.Path in test fixtures
  - RULE 5: MetadataError includes actionable context with examples
  - RULE 6: No bare except clauses
  - RULE 7: Complete type hints on all function signatures
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ AAA pattern, test IDs match test design, 90%+ coverage
- All ACs Met: ✓ All 10 acceptance criteria verified

### Improvements Checklist

- [x] Implementation follows builder pattern with method chaining
- [x] All XDSb namespaces correctly defined per IHE ITI TF-3
- [x] Classification scheme UUIDs match specification
- [x] Patient ID CX format correctly implemented
- [x] Author XCN/XON formats correctly implemented
- [x] Hash calculated using SHA-256 (lowercase hex)
- [x] Size calculated in bytes
- [x] Association HasMember type correctly links submission set to document
- [x] Unit tests cover all P0 and P1 scenarios from test design
- [x] Integration tests verify real CCD document processing

### Security Review

No security concerns identified. The module:
- Does not handle credentials directly
- Validates OID formats to prevent injection
- Does not expose sensitive data in logs

### Performance Considerations

No performance concerns. The builder:
- Uses efficient lxml for XML construction
- Generates UUIDs efficiently using uuid4
- No unnecessary memory allocations

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/6.1-xdsb-metadata-construction.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, all tests passing, coverage exceeds targets, coding standards fully compliant.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-22 | 1.0 | Initial story creation for Epic 6 | Scrum Master (Bob) |
| 2025-11-22 | 1.1 | Story validated and approved for implementation | Product Owner (Sarah) |
| 2025-11-22 | 1.2 | Added comprehensive test design (32 scenarios) from QA | Quinn (Test Architect) |
