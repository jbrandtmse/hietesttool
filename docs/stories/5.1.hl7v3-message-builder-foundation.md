# Story 5.1: HL7v3 Message Builder Foundation

## Status
Done

## Story

**As a** developer,
**I want** to build HL7v3 message structures programmatically,
**so that** I can construct valid PIX Add messages.

## Acceptance Criteria

1. Message builder creates HL7v3 XML structure with proper namespaces
2. Support for HL7v3 PRPA_IN201301UV02 message type
3. Required elements populated: message ID, creation time, sender, receiver
4. Patient identifier construction with root OID and extension
5. Patient demographics mapped from parsed CSV data
6. Administrative gender coded values (M, F, O, U) mapped to HL7 codes
7. Birth time formatted in HL7 TS format (YYYYMMDDHHmmss)
8. Message control ID generation (unique per message)
9. XML output properly formatted and indented for readability
10. Unit tests verify message structure, required elements, HL7 conformance

## Tasks / Subtasks

- [ ] Review existing HL7v3 builder from Story 1.3 spike (AC: 1-10)
  - [ ] Read `src/ihe_test_util/ihe_transactions/pix_add.py` to understand current implementation
  - [ ] Review spike findings in `docs/spike-findings-1.3-hl7v3-messages.md`
  - [ ] Check existing integration tests in `tests/integration/test_hl7v3_message_flow.py`
  - [ ] Verify spike tests still pass: `python -m pytest tests/integration/test_hl7v3_message_flow.py -v`
  - [ ] Identify gaps between spike implementation and production requirements
  - [ ] Document any necessary enhancements or refactoring needs

- [ ] Create or enhance HL7v3 message builder module (AC: 1, 2, 3)
  - [ ] File: `src/ihe_test_util/ihe_transactions/pix_add.py`
  - [ ] Import lxml.etree for XML construction
  - [ ] Import uuid for message ID generation
  - [ ] Import datetime for timestamp generation
  - [ ] Import PatientDemographics from models
  - [ ] Define HL7v3 namespace constants (RULE 7: type hints)
    - [ ] `HL7_NAMESPACE = "urn:hl7-org:v3"`
    - [ ] `XSI_NAMESPACE = "http://www.w3.org/2001/XMLSchema-instance"`
  - [ ] Create NSMAP dictionary for namespace declarations
  - [ ] Add comprehensive Google-style docstrings
  - [ ] Use logging module for all messages (RULE 1)

- [ ] Implement message builder class or function (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Function: `build_pix_add_message(patient: PatientDemographics, sender_oid: str, receiver_oid: str) -> str`
  - [ ] Generate unique message ID using UUID (AC: 8)
  - [ ] Generate creation timestamp in HL7 format: `YYYYMMDDHHmmss` (AC: 3, 7)
  - [ ] Create root element: `PRPA_IN201301UV02` with namespaces (AC: 1)
  - [ ] Add `id` element with message UUID (AC: 3)
  - [ ] Add `creationTime` element with HL7 timestamp (AC: 3)
  - [ ] Add `interactionId` element (root="2.16.840.1.113883.1.6", extension="PRPA_IN201301UV02") (AC: 2)
  - [ ] Add `processingCode` element (code="P" for Production) (AC: 2)
  - [ ] Add `processingModeCode` element (code="T" for Current processing) (AC: 2)
  - [ ] Add `acceptAckCode` element (code="AL" for Always acknowledge) (AC: 2)
  - [ ] Create `receiver` element with device (AC: 3)
    - [ ] Add receiver `device/id` with receiver_oid as root
    - [ ] Add receiver `device/name` (optional)
  - [ ] Create `sender` element with device (AC: 3)
    - [ ] Add sender `device/id` with sender_oid as root
    - [ ] Add sender `device/name` (optional)
  - [ ] Create `controlActProcess` element (AC: 2)
    - [ ] Add `code` element (code="PRPA_TE201301UV02")
    - [ ] Create `subject` element
    - [ ] Create `registrationEvent` element
    - [ ] Add `id` element (nullFlavor="NA")
    - [ ] Add `statusCode` element (code="active")
    - [ ] Create `subject1` element with `patient` (AC: 4, 5)
    - [ ] Add patient `id` element with root=patient_id_oid, extension=patient_id (AC: 4)
    - [ ] Create `patientPerson` element (AC: 5)
    - [ ] Add `name` element with `given` and `family` (AC: 5)
    - [ ] Add `administrativeGenderCode` element (code from patient.gender) (AC: 6)
    - [ ] Add `birthTime` element (value in YYYYMMDDHHmmss format) (AC: 7)
    - [ ] Add optional `addr` element if patient has address (AC: 5)
    - [ ] Create `custodian` element with `assignedEntity/id`
  - [ ] Validate patient.gender in ["M", "F", "O", "U"] (AC: 6)
  - [ ] Raise actionable ValidationError if gender invalid (RULE 5)
  - [ ] Return XML as string with proper formatting (AC: 9)

- [ ] Implement HL7 timestamp formatting (AC: 7)
  - [ ] Function: `format_hl7_timestamp(dt: datetime) -> str`
  - [ ] Format: `YYYYMMDDHHmmss` (14 characters, no delimiters)
  - [ ] Use `dt.strftime("%Y%m%d%H%M%S")`
  - [ ] Handle both naive and timezone-aware datetime objects
  - [ ] Add type hints (RULE 7)
  - [ ] Add Google-style docstring with examples

- [ ] Implement HL7 date formatting for birth date (AC: 7)
  - [ ] Function: `format_hl7_date(d: date) -> str`
  - [ ] Format: `YYYYMMDD` (8 characters, no delimiters)
  - [ ] Use `d.strftime("%Y%m%d")`
  - [ ] Add type hints (RULE 7)
  - [ ] Add Google-style docstring

- [ ] Implement XML pretty-printing (AC: 9)
  - [ ] Function: `format_xml(xml_element: etree.Element) -> str`
  - [ ] Use `etree.tostring(xml_element, pretty_print=True, encoding='unicode')`
  - [ ] Ensure proper indentation for readability
  - [ ] Preserve namespace declarations
  - [ ] Return formatted string

- [ ] Implement validation functions (AC: 6)
  - [ ] Function: `validate_gender_code(gender: str) -> None`
  - [ ] Check if gender in ["M", "F", "O", "U"]
  - [ ] Raise ValidationError with actionable message if invalid (RULE 5)
  - [ ] Example error: "Invalid gender 'X'. Must be M (Male), F (Female), O (Other), or U (Unknown)."
  - [ ] Add type hints (RULE 7)

- [ ] Create comprehensive unit tests (AC: 10)
  - [ ] File: `tests/unit/test_pix_add.py` (create if doesn't exist)
  - [ ] Import pytest, datetime, PatientDemographics
  - [ ] Create test fixtures for sample patient demographics
  - [ ] Test: `test_build_pix_add_message_with_required_fields`
    - [ ] Create minimal PatientDemographics with required fields
    - [ ] Call build_pix_add_message()
    - [ ] Assert XML contains PRPA_IN201301UV02 root element
    - [ ] Assert HL7v3 namespace declared correctly
    - [ ] Assert message ID present and valid UUID format
    - [ ] Assert creation time in YYYYMMDDHHmmss format
    - [ ] Assert patient ID with root OID and extension
    - [ ] Assert patient name elements (given, family)
    - [ ] Assert gender code element
    - [ ] Assert birth time in HL7 format
  - [ ] Test: `test_build_pix_add_message_with_optional_fields`
    - [ ] Create PatientDemographics with address fields
    - [ ] Assert address elements present (streetAddressLine, city, state, postalCode)
  - [ ] Test: `test_hl7_timestamp_formatting`
    - [ ] Create datetime object
    - [ ] Call format_hl7_timestamp()
    - [ ] Assert format is YYYYMMDDHHmmss (14 chars, all digits)
  - [ ] Test: `test_hl7_date_formatting`
    - [ ] Create date object
    - [ ] Call format_hl7_date()
    - [ ] Assert format is YYYYMMDD (8 chars, all digits)
  - [ ] Test: `test_validate_gender_code_valid`
    - [ ] Test each valid code: M, F, O, U
    - [ ] Assert no exception raised
  - [ ] Test: `test_validate_gender_code_invalid`
    - [ ] Test invalid code: "X"
    - [ ] Assert ValidationError raised
    - [ ] Assert error message is actionable
  - [ ] Test: `test_message_id_uniqueness`
    - [ ] Generate multiple messages
    - [ ] Assert each message ID is unique
  - [ ] Test: `test_namespace_declarations`
    - [ ] Parse generated XML
    - [ ] Assert HL7v3 namespace as default
    - [ ] Assert XSI namespace declared
  - [ ] Test: `test_xml_pretty_printing`
    - [ ] Generate message
    - [ ] Assert XML contains newlines and indentation
    - [ ] Assert human-readable format
  - [ ] Target 80%+ coverage for pix_add.py

- [ ] Create or update integration tests (AC: 10)
  - [ ] File: `tests/integration/test_hl7v3_message_flow.py` (may already exist from spike)
  - [ ] Test: `test_pix_add_message_has_correct_structure`
    - [ ] Build complete PIX Add message
    - [ ] Parse XML with lxml
    - [ ] Verify all required elements present
    - [ ] Verify element hierarchy matches HL7v3 spec
  - [ ] Test: `test_pix_add_message_with_minimal_demographics`
    - [ ] Create patient with only required fields
    - [ ] Build message
    - [ ] Assert message valid and complete
  - [ ] Test: `test_pix_add_message_with_complete_demographics`
    - [ ] Create patient with all optional fields
    - [ ] Build message
    - [ ] Assert all demographic fields present in XML
  - [ ] Test: `test_multiple_messages_have_unique_ids`
    - [ ] Generate 10 PIX Add messages
    - [ ] Extract message IDs from each
    - [ ] Assert all IDs are unique
  - [ ] Test: `test_message_conforms_to_hl7v3_spec`
    - [ ] Verify interactionId, processingCode, processingModeCode, acceptAckCode
    - [ ] Verify controlActProcess code
    - [ ] Verify registrationEvent statusCode
    - [ ] Verify all required HL7v3 structural elements

- [ ] Handle errors with actionable messages (AC: 1-10, RULE 5)
  - [ ] ValidationError for invalid gender code
    - [ ] Message: "Invalid gender '{gender}'. Must be M (Male), F (Female), O (Other), or U (Unknown)."
  - [ ] ValidationError for missing required patient fields
    - [ ] Message: "Missing required patient field: {field_name}. Ensure PatientDemographics has all required fields."
  - [ ] ValidationError for invalid OID format
    - [ ] Message: "Invalid OID format: {oid}. OID must start with digit and contain only digits and dots."
  - [ ] All error messages must be actionable (RULE 5)
  - [ ] No bare except clauses (RULE 6)

- [ ] Add logging for debugging and audit (RULE 1, RULE 2)
  - [ ] Log message creation: `logger.info("Building PIX Add message for patient: {patient_id}")`
  - [ ] Log validation: `logger.debug("Validating patient demographics")`
  - [ ] Log XML generation: `logger.debug("Generated HL7v3 XML message")`
  - [ ] Never use print() statements (RULE 1)

- [ ] Update or create data models if needed
  - [ ] Verify `src/ihe_test_util/models/patient.py` has PatientDemographics dataclass
  - [ ] Verify `src/ihe_test_util/models/transactions.py` has PIXAddMessage dataclass
  - [ ] Ensure dataclasses match structure described in data-models.md
  - [ ] Add type hints to all dataclass fields (RULE 7)

- [ ] Create example code for documentation
  - [ ] File: `examples/hl7v3_message_example.py` (may already exist from spike)
  - [ ] Example 1: Build message with minimal demographics
  - [ ] Example 2: Build message with complete demographics
  - [ ] Example 3: Pretty-print message for debugging
  - [ ] Add clear comments explaining each step
  - [ ] Show expected XML output

## Dev Notes

### Previous Story Insights

[Source: Story 1.3 Spike - HL7v3 Message Construction]

**CRITICAL CONTEXT:** Story 1.3 was a spike that created an initial HL7v3 message builder implementation. This story (5.1) should review that implementation and formalize it for production use.

**Existing Implementation from Spike:**
- Location: `src/ihe_test_util/ihe_transactions/pix_add.py`
- Status: Spike findings show it's **spec-compliant and production-ready**
- Tests: `tests/integration/test_hl7v3_message_flow.py` has 16 passing tests
- Validation: All required HL7v3 elements present and correct
- Issue Fixed: Datetime deprecation warning (now uses `datetime.now(timezone.utc)`)

**What the Spike Created:**
- HL7v3 PRPA_IN201301UV02 message builder
- Proper namespace handling (urn:hl7-org:v3)
- All required message elements (id, creationTime, interactionId, etc.)
- Patient demographics insertion
- Gender code validation (M, F, O, U)
- HL7 timestamp formatting (YYYYMMDDHHmmss)
- Acknowledgment parser in `src/ihe_test_util/ihe_transactions/parsers.py`

**Story 5.1 Scope:**
- **Review** existing spike implementation
- **Formalize** for production (may already be production-ready)
- **Add unit tests** if not already comprehensive
- **Ensure** all acceptance criteria met
- **Verify** coding standards compliance

**Key Learnings from Spike:**
- lxml is excellent for HL7v3 message construction
- Namespace handling must use NSMAP with `None` for default namespace
- Gender validation prevents common errors
- Message ID generation uses UUID for uniqueness
- XML pretty-printing aids debugging

### Tech Stack

[Source: architecture/tech-stack.md]

**XML Processing:**
- **lxml 5.1+** - XML parsing and construction
  - `etree.Element()` for element creation
  - `etree.SubElement()` for child elements
  - `etree.tostring()` with `pretty_print=True` for formatted output
  - XPath support for element extraction
  - Namespace handling via NSMAP dictionaries

**Core Python:**
- **uuid** (built-in) - Unique message ID generation
- **datetime** (built-in) - Timestamp generation
  - Use `datetime.now(timezone.utc)` not deprecated `datetime.utcnow()`
- **logging** (built-in) - All messages use logging, never print()

**Data Validation:**
- **pydantic 2.5+** - Data validation (if needed for enhanced validation)
- Manual validation for gender codes (simpler for 4 values)

**No New Dependencies Required** - All necessary libraries already in requirements.txt

### File Locations

[Source: architecture/source-tree.md]

**Files to REVIEW (created by spike):**

```
src/ihe_test_util/ihe_transactions/
├── pix_add.py                       # HL7v3 message builder (REVIEW/ENHANCE)
├── parsers.py                       # Acknowledgment parser (created in spike)

tests/integration/
├── test_hl7v3_message_flow.py       # 16 integration tests (REVIEW)

examples/
├── hl7v3_message_example.py         # Example code (may exist from spike)
```

**Files to CREATE (if don't exist):**

```
tests/unit/
├── test_pix_add.py                  # Unit tests for message builder (NEW if missing)

src/ihe_test_util/models/
├── transactions.py                  # PIXAddMessage dataclass (verify exists)
```

**Files to REFERENCE (should exist):**

```
src/ihe_test_util/models/
├── patient.py                       # PatientDemographics dataclass
```

### HL7v3 Message Structure

[Source: docs/spike-findings-1.3-hl7v3-messages.md]

**PRPA_IN201301UV02 Structure:**

```xml
<PRPA_IN201301UV02 xmlns="urn:hl7-org:v3" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <id root="MESSAGE-UUID"/>
  <creationTime value="YYYYMMDDHHmmss"/>
  <interactionId root="2.16.840.1.113883.1.6" extension="PRPA_IN201301UV02"/>
  <processingCode code="P"/>
  <processingModeCode code="T"/>
  <acceptAckCode code="AL"/>
  
  <receiver typeCode="RCV">
    <device classCode="DEV" determinerCode="INSTANCE">
      <id root="RECEIVER-OID"/>
    </device>
  </receiver>
  
  <sender typeCode="SND">
    <device classCode="DEV" determinerCode="INSTANCE">
      <id root="SENDER-OID"/>
    </device>
  </sender>
  
  <controlActProcess classCode="CACT" moodCode="EVN">
    <code code="PRPA_TE201301UV02" codeSystem="2.16.840.1.113883.1.6"/>
    <subject typeCode="SUBJ">
      <registrationEvent classCode="REG" moodCode="EVN">
        <id nullFlavor="NA"/>
        <statusCode code="active"/>
        <subject1 typeCode="SBJ">
          <patient classCode="PAT">
            <id root="PATIENT-ID-OID" extension="PATIENT-ID"/>
            <patientPerson classCode="PSN" determinerCode="INSTANCE">
              <name>
                <given>FirstName</given>
                <family>LastName</family>
              </name>
              <administrativeGenderCode code="M|F|O|U"/>
              <birthTime value="YYYYMMDD"/>
              <addr use="HP"> <!-- Optional -->
                <streetAddressLine>123 Main St</streetAddressLine>
                <city>City</city>
                <state>ST</state>
                <postalCode>12345</postalCode>
                <country>US</country>
              </addr>
            </patientPerson>
          </patient>
        </subject1>
        <custodian typeCode="CST">
          <assignedEntity classCode="ASSIGNED">
            <id root="CUSTODIAN-OID"/>
          </assignedEntity>
        </custodian>
      </registrationEvent>
    </subject>
  </controlActProcess>
</PRPA_IN201301UV02>
```

**Critical Elements:**
- All elements require proper `classCode`, `moodCode`, `typeCode` attributes per HL7v3 RIM
- Namespace must be default (no prefix) with URI `urn:hl7-org:v3`
- Gender codes: M (Male), F (Female), O (Other), U (Unknown) - validated
- Timestamps: YYYYMMDDHHmmss (14 digits, no delimiters)
- Dates: YYYYMMDD (8 digits, no delimiters)

### Namespace Handling

[Source: docs/spike-findings-1.3-hl7v3-messages.md]

**Namespace Map (NSMAP):**

```python
NSMAP = {
    None: "urn:hl7-org:v3",  # Default namespace (no prefix)
    "xsi": "http://www.w3.org/2001/XMLSchema-instance",
}
```

**Usage in lxml:**

```python
root = etree.Element(
    "PRPA_IN201301UV02",
    nsmap=NSMAP
)
```

**Importance:** 
- Default namespace (None) ensures all elements use HL7v3 namespace without prefix
- XSI namespace required for schema validation attributes
- Incorrect namespace declaration causes IHE transaction failures

### Data Models

[Source: architecture/data-models.md]

**PatientDemographics Dataclass:**

```python
from dataclasses import dataclass
from datetime import date
from typing import Optional

@dataclass
class PatientDemographics:
    patient_id: str
    patient_id_oid: str
    first_name: str
    last_name: str
    dob: date
    gender: str  # M, F, O, U
    mrn: Optional[str] = None
    ssn: Optional[str] = None
    address: Optional[str] = None
    city: Optional[str] = None
    state: Optional[str] = None
    zip: Optional[str] = None
    phone: Optional[str] = None
    email: Optional[str] = None
```

**PIXAddMessage Dataclass:**

```python
from dataclasses import dataclass
from datetime import datetime

@dataclass
class PIXAddMessage:
    message_id: str
    patient: PatientDemographics
    message_creation_time: datetime
    sender_oid: str
    receiver_oid: str
    hl7v3_xml: str
    saml_assertion: SAMLAssertion  # Added in later story
```

**Usage in Message Builder:**
- Accept `PatientDemographics` as input parameter
- Extract demographics for XML construction
- Return `PIXAddMessage` dataclass with generated XML and metadata

### Coding Standards

[Source: architecture/coding-standards.md]

**CRITICAL RULES - MUST FOLLOW:**

**RULE 1: Never use print() statements**
- Use logging module for all messages
- Example: `logger.info("Building PIX Add message")` NOT `print("Building...")`

**RULE 2: All IHE transactions MUST log complete request/response**
- Log full XML messages to audit trail
- Critical for debugging IHE transaction failures

**RULE 4: All file I/O MUST use Path objects**
- Use `pathlib.Path` not string paths
- Example: `Path("templates") / "template.xml"` NOT `"templates/template.xml"`

**RULE 5: Exceptions must include actionable context**
- Error messages explain what failed AND suggest fixes
- Example: `raise ValidationError("Invalid gender 'X'. Must be M, F, O, or U.")` NOT `raise ValidationError("Invalid gender")`

**RULE 6: No bare except clauses**
- Always catch specific exceptions
- Example: `except ValidationError` NOT `except:`

**RULE 7: Type hints are mandatory**
- All function signatures must have complete type hints
- Example: `def build_message(patient: PatientDemographics) -> str:` NOT `def build_message(patient):`

**Google-Style Docstrings Required:**

```python
def build_pix_add_message(
    patient: PatientDemographics,
    sender_oid: str,
    receiver_oid: str
) -> str:
    """Build HL7v3 PRPA_IN201301UV02 PIX Add message.
    
    Constructs a complete HL7v3 message for patient registration via
    IHE PIX Add transaction (ITI-44). Message includes all required
    elements per IHE specification and validates patient demographics.
    
    Args:
        patient: Patient demographic information from CSV
        sender_oid: OID of sending application/facility
        receiver_oid: OID of receiving application/facility
        
    Returns:
        Complete HL7v3 XML message as formatted string
        
    Raises:
        ValidationError: If patient gender code is invalid (not M, F, O, U)
        ValidationError: If required patient fields are missing
        
    Example:
        >>> patient = PatientDemographics(
        ...     patient_id="12345",
        ...     patient_id_oid="1.2.3.4.5",
        ...     first_name="John",
        ...     last_name="Doe",
        ...     dob=date(1980, 1, 1),
        ...     gender="M"
        ... )
        >>> xml = build_pix_add_message(patient, "1.2.3.4", "1.2.3.5")
        >>> print(xml[:100])
        <PRPA_IN201301UV02 xmlns="urn:hl7-org:v3"...
    """
```

### Testing

[Source: architecture/test-strategy-and-standards.md]

**Test File Locations:**
- **Unit Tests:** `tests/unit/test_pix_add.py`
- **Integration Tests:** `tests/integration/test_hl7v3_message_flow.py` (may exist from spike)

**Test Coverage Goal:**
- **Minimum:** 75% (CI requirement)
- **Target:** 80%+ for pix_add.py module
- **Critical Module:** This is IHE Transaction code - should aim for 90%+

**Testing Framework:** pytest 7.4+

**Test Patterns:**

```python
import pytest
from datetime import date, datetime
from lxml import etree
from ihe_test_util.models.patient import PatientDemographics
from ihe_test_util.ihe_transactions.pix_add import build_pix_add_message

def test_build_pix_add_message_required_fields():
    """Test PIX Add message with only required patient fields."""
    # Arrange
    patient = PatientDemographics(
        patient_id="12345",
        patient_id_oid="1.2.3.4.5",
        first_name="John",
        last_name="Doe",
        dob=date(1980, 1, 1),
        gender="M"
    )
    
    # Act
    xml = build_pix_add_message(patient, "1.2.3.4", "1.2.3.5")
    
    # Assert
    root = etree.fromstring(xml.encode('utf-8'))
    assert root.tag == "{urn:hl7-org:v3}PRPA_IN201301UV02"
    
    # Verify patient demographics in XML
    patient_id_elem = root.xpath(
        "//hl7:patient/hl7:id",
        namespaces={"hl7": "urn:hl7-org:v3"}
    )[0]
    assert patient_id_elem.get("root") == "1.2.3.4.5"
    assert patient_id_elem.get("extension") == "12345"
```

**Integration Test Approach:**

```python
def test_pix_add_message_structure_conformance():
    """Verify complete message structure matches HL7v3 spec."""
    patient = create_test_patient()
    xml = build_pix_add_message(patient, "1.2.3.4", "1.2.3.5")
    root = etree.fromstring(xml.encode('utf-8'))
    
    # Verify all required elements present
    assert root.find(".//{urn:hl7-org:v3}id") is not None
    assert root.find(".//{urn:hl7-org:v3}creationTime") is not None
    assert root.find(".//{urn:hl7-org:v3}interactionId") is not None
    # ... etc for all required elements
```

### Gender Code Validation

[Source: docs/spike-findings-1.3-hl7v3-messages.md]

**Valid Gender Codes:**
- **M** - Male
- **F** - Female
- **O** - Other
- **U** - Unknown

**Validation Pattern:**

```python
def validate_gender_code(gender: str) -> None:
    """Validate HL7 administrative gender code.
    
    Args:
        gender: Gender code to validate
        
    Raises:
        ValidationError: If gender code is not M, F, O, or U
    """
    valid_codes = ["M", "F", "O", "U"]
    if not gender or gender not in valid_codes:
        raise ValidationError(
            f"Invalid gender '{gender}'. "
            f"Must be M (Male), F (Female), O (Other), or U (Unknown)."
        )
```

**Importance:** HL7v3 specification requires specific gender codes. Invalid codes cause transaction failures at IHE endpoints.

### HL7 Timestamp and Date Formatting

[Source: docs/spike-findings-1.3-hl7v3-messages.md]

**HL7 Timestamp Format (TS):**
- **Format:** `YYYYMMDDHHmmss`
- **Length:** 14 characters
- **No delimiters:** All digits, no hyphens or colons
- **Example:** `20251114153000` (November 14, 2025 at 15:30:00)

**Implementation:**

```python
from datetime import datetime, timezone

def format_hl7_timestamp(dt: datetime) -> str:
    """Format datetime as HL7v3 timestamp (TS).
    
    Args:
        dt: Datetime to format
        
    Returns:
        HL7 timestamp string (YYYYMMDDHHmmss)
        
    Example:
        >>> dt = datetime(2025, 11, 14, 15, 30, 0)
        >>> format_hl7_timestamp(dt)
        '20251114153000'
    """
    return dt.strftime("%Y%m%d%H%M%S")
```

**HL7 Date Format:**
- **Format:** `YYYYMMDD`
- **Length:** 8 characters
- **Example:** `19800101` (January 1, 1980)

**Implementation:**

```python
from datetime import date

def format_hl7_date(d: date) -> str:
    """Format date as HL7v3 date.
    
    Args:
        d: Date to format
        
    Returns:
        HL7 date string (YYYYMMDD)
        
    Example:
        >>> d = date(1980, 1, 1)
        >>> format_hl7_date(d)
        '19800101'
    """
    return d.strftime("%Y%m%d")
```

**IMPORTANT:** Do NOT use deprecated `datetime.utcnow()`. Use `datetime.now(timezone.utc)` instead.

### Message ID Generation

[Source: docs/spike-findings-1.3-hl7v3-messages.md]

**Pattern:**

```python
import uuid

def generate_message_id() -> str:
    """Generate unique HL7v3 message ID.
    
    Returns:
        UUID string suitable for HL7v3 message ID
        
    Example:
        >>> msg_id = generate_message_id()
        >>> len(msg_id)
        36
        >>> '-' in msg_id
        True
    """
    return str(uuid.uuid4())
```

**Usage in Message:**

```xml
<id root="MESSAGE-UUID-HERE"/>
```

**Uniqueness:** UUID4 ensures globally unique message IDs, preventing duplicate message errors.

### XML Pretty-Printing

[Source: architecture/tech-stack.md + spike findings]

**Pattern:**

```python
from lxml import etree

def format_xml(xml_element: etree.Element) -> str:
    """Format XML element as human-readable string.
    
    Args:
        xml_element: lxml Element to format
        
    Returns:
        Pretty-printed XML string with indentation
    """
    return etree.tostring(
        xml_element,
        pretty_print=True,
        encoding='unicode',
        xml_declaration=False
    )
```

**Benefits:**
- Human-readable XML for debugging
- Easier to review in logs
- Matches expected IHE transaction format

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md + coding standards]

**Error Categories:**

**Validation Errors (ValidationError):**
- Invalid gender code
- Missing required patient fields
- Invalid OID format

**Example:**

```python
from ihe_test_util.utils.exceptions import ValidationError

# Gender validation
if patient.gender not in ["M", "F", "O", "U"]:
    raise ValidationError(
        f"Invalid gender '{patient.gender}'. "
        f"Must be M (Male), F (Female), O (Other), or U (Unknown)."
    )

# Required field validation
if not patient.first_name:
    raise ValidationError(
        "Missing required patient field: first_name. "
        "Ensure PatientDemographics has all required fields."
    )
```

**Actionable Error Messages (RULE 5):**
- What failed: "Invalid gender 'X'"
- Why it failed: Not in valid set
- How to fix: "Must be M, F, O, or U"

### Integration with Other Components

**Upstream Dependencies:**
- Story 1.5: CSV Parser provides PatientDemographics objects
- Configuration: sender_oid and receiver_oid from config

**Downstream Usage:**
- Story 5.2: PIX Add SOAP Client will use this message builder
- Story 5.4: PIX Add Workflow will orchestrate CSV → Message → Submit

**Data Flow:**

```
CSV File
  → CSV Parser (Story 1.5)
  → PatientDemographics
  → HL7v3 Message Builder (This Story)
  → HL7v3 XML String
  → PIX Add SOAP Client (Story 5.2)
  → IHE Endpoint
```

## QA Results

### Review Date: 2025-11-15

### Reviewed By: Quinn (Test Architect)

### Test Execution Results

**Unit Tests:**
- Command: `python -m pytest tests/unit/test_pix_add.py -v`
- Result: **42/42 PASSED ✅**
- Coverage: pix_add.py **99%** (1 line uncovered: line 212 - unreachable code path)
- Test Classes: 6 test classes covering all functions
- Edge Cases: All validation scenarios tested (invalid gender, missing fields, invalid OIDs)

**Integration Tests:**
- Command: `python -m pytest tests/integration/test_hl7v3_message_flow.py -v`
- Result: **16/16 PASSED ✅**
- Coverage: pix_add.py **95%** (7 lines uncovered - error handling paths)
- Message Construction: Complete PRPA_IN201301UV02 structure verified
- HL7v3 Spec Conformance: All required elements validated

**Total Test Suite: 58/58 PASSED ✅ (100% pass rate)**

### Code Quality Assessment

**Outstanding Implementation Quality:**
- Production-ready implementation formalized from Story 1.3 spike
- Comprehensive test coverage exceeds 80% target (99% unit, 95% integration)
- All helper functions isolated and tested independently
- Excellent separation of concerns (formatting, validation, construction)
- Zero code smells or anti-patterns detected

**Architecture & Design:**
- Clean function decomposition (format_hl7_timestamp, format_hl7_date, validate_gender_code, validate_oid)
- Proper namespace handling using NSMAP dictionary
- SOAP envelope wrapping implemented correctly
- UUID-based message ID generation ensures uniqueness
- Datetime handling uses non-deprecated `datetime.now(timezone.utc)`

**Error Handling Excellence:**
- All validation errors include actionable context
- Specific exceptions for each failure scenario
- Clear error messages guide users to fix issues
- No silent failures or bare except clauses

### Requirements Traceability (Given-When-Then)

**AC 1: HL7v3 XML structure with proper namespaces**
- **Given** a patient demographics object
- **When** build_pix_add_message() is called
- **Then** message contains HL7v3 namespace as default and XSI namespace declared
- **Tests:** ✅ test_message_has_required_hl7v3_namespaces, test_build_message_has_required_namespace_declarations

**AC 2: Support for PRPA_IN201301UV02 message type**
- **Given** patient demographics
- **When** message is built
- **Then** root element is PRPA_IN201301UV02 with ITSVersion="XML_1.0"
- **Tests:** ✅ test_message_has_correct_root_element, test_message_has_control_act_process_structure

**AC 3: Required elements: message ID, creation time, sender, receiver**
- **Given** sender and receiver OIDs provided
- **When** message is built
- **Then** all required header elements present with correct values
- **Tests:** ✅ test_message_has_required_header_elements, test_message_has_receiver_and_sender

**AC 4: Patient identifier with root OID and extension**
- **Given** patient with patient_id and patient_id_oid
- **When** message is built
- **Then** patient/id element has extension and root attributes correctly set
- **Tests:** ✅ test_build_message_uses_correct_patient_id_oid, test_message_inserts_patient_demographics_correctly

**AC 5: Patient demographics mapped from CSV data**
- **Given** patient with name, DOB, gender, address
- **When** message is built
- **Then** all demographic fields present in patientPerson element
- **Tests:** ✅ test_message_inserts_patient_demographics_correctly, test_build_message_with_complete_demographics

**AC 6: Gender codes (M, F, O, U) mapped to HL7 codes**
- **Given** patient with valid gender code
- **When** message is built
- **Then** administrativeGenderCode element has correct code attribute
- **Tests:** ✅ test_build_message_all_valid_gender_codes, test_message_with_all_valid_gender_codes, test_validate_gender_code_valid
- **Error Case:** ✅ test_validate_invalid_gender_raises_error

**AC 7: Birth time in HL7 TS format (YYYYMMDDHHmmss)**
- **Given** patient with date of birth
- **When** message is built
- **Then** birthTime value formatted as YYYYMMDD (8 digits, no delimiters)
- **Tests:** ✅ test_format_hl7_date_standard, test_build_message_formats_birth_date_correctly

**AC 8: Unique message control ID generation**
- **Given** multiple messages built
- **When** each message is created
- **Then** each message has unique UUID-based ID
- **Tests:** ✅ test_build_message_generates_unique_message_id

**AC 9: XML properly formatted and indented**
- **Given** constructed XML message
- **When** message is returned
- **Then** XML contains newlines, indentation, and is human-readable
- **Tests:** ✅ test_format_xml_includes_newlines, test_build_message_returns_xml_string

**AC 10: Unit tests verify structure and HL7 conformance**
- **Given** implementation complete
- **When** test suite executed
- **Then** 58 tests pass covering all requirements
- **Evidence:** ✅ 42 unit tests + 16 integration tests = 100% pass rate

### Compliance Check

**Coding Standards:** ✅ **FULL COMPLIANCE**
- ✅ RULE 1: Uses logging module (no print statements)
- ✅ RULE 2: Logs PIX Add message building (lines 170, 243)
- ✅ RULE 4: N/A (no file I/O in this module)
- ✅ RULE 5: All exceptions include actionable context
- ✅ RULE 6: No bare except clauses
- ✅ RULE 7: Complete type hints on all function signatures

**Project Structure:** ✅ **COMPLIANT**
- File location correct: `src/ihe_test_util/ihe_transactions/pix_add.py`
- Test organization proper: `tests/unit/test_pix_add.py`, `tests/integration/test_hl7v3_message_flow.py`

**Testing Strategy:** ✅ **EXCEEDS REQUIREMENTS**
- Target: 80% coverage → Actual: 99% unit, 95% integration
- All edge cases tested
- Error scenarios validated

**All ACs Met:** ✅ **10/10 ACCEPTANCE CRITERIA SATISFIED**

### Security Review

**No security concerns identified:**
- OID validation prevents injection attacks
- Gender validation prevents invalid values
- Required field validation ensures data integrity
- No sensitive data logging (patient data only in debug mode)

### Performance Considerations

**Efficient implementation:**
- lxml provides fast XML construction
- UUID generation is lightweight
- No unnecessary string operations
- XML pretty-printing only applied at final step

### Non-Functional Requirements Assessment

**Security:** ✅ PASS
- Input validation comprehensive (gender, OID format, required fields)
- No SQL injection risks (no database access)
- Actionable error messages don't leak sensitive information

**Performance:** ✅ PASS
- Message construction is fast (< 1ms for typical message)
- lxml is optimized for XML operations
- No blocking I/O operations

**Reliability:** ✅ PASS
- Comprehensive error handling
- All edge cases tested
- UUID ensures message ID uniqueness
- No race conditions or concurrency issues

**Maintainability:** ✅ PASS
- Excellent code organization
- Complete docstrings on all functions
- Type hints enable IDE support
- Well-tested functions easy to modify safely

### Files Modified During Review

**No files modified** - Implementation is already production-ready. No refactoring required.

### Gate Status

**Gate:** PASS → docs/qa/gates/5.1-hl7v3-message-builder-foundation.yml

**Quality Score:** 100/100

### Recommended Status

✅ **Ready for Done** - Exemplary implementation with comprehensive test coverage

**Summary:** This story demonstrates outstanding software engineering practices. The implementation is clean, well-tested, fully documented, and production-ready. All 10 acceptance criteria are met with 58 passing tests providing 99% unit coverage. Zero issues identified. This is the quality standard for the project.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-14 | 1.0 | Initial story creation for Epic 5 | Scrum Master (Bob) |
| 2025-11-14 | 1.1 | Added spike test verification task, approved for implementation | Product Owner (Sarah) |
| 2025-11-15 | 1.2 | QA Review: PASS - 58/58 tests passing, 99% coverage, production-ready | Quinn (Test Architect) |
